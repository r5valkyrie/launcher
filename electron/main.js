import{app as T,BrowserWindow as Ve,ipcMain as v,dialog as we,protocol as Ne,shell as me}from"electron";import{createRequire as et}from"node:module";import m from"node:path";import{fileURLToPath as tt,pathToFileURL as vt}from"node:url";import Q from"node:https";import y from"node:fs";import rt from"node:zlib";import{spawn as ne}from"node:child_process";import nt from"node:os";import D from"node:fs";import L from"node:path";import We from"node:crypto";import{pipeline as He}from"node:stream";import{promisify as qe}from"node:util";import le from"node:https";var Oe=qe(He);function ie(s){return String(s||"").replace(/\\/g,"/").replace(/^\/+/,"")}function Ce(s){return String(s||"").replace(/\\/g,"/").toLowerCase()}var G=new Map,Ae=new le.Agent({keepAlive:!0,maxSockets:64,maxFreeSockets:32,keepAliveMsecs:6e4,scheduling:"fifo"}),ce=class{constructor(){this.maxBytesPerSecond=0,this.tokens=0,this.lastRefill=Date.now()}setMaxSpeed(t){this.maxBytesPerSecond=Math.max(0,t),this.tokens=this.maxBytesPerSecond}async consumeTokens(t){if(this.maxBytesPerSecond<=0)return;let r=Date.now(),e=(r-this.lastRefill)/1e3;if(this.tokens=Math.min(this.maxBytesPerSecond,this.tokens+e*this.maxBytesPerSecond),this.lastRefill=r,t>this.tokens){let o=(t-this.tokens)/this.maxBytesPerSecond*1e3;await j(o),this.tokens=0}else this.tokens-=t}},De=new ce;function be(s){De.setMaxSpeed(s)}function O(s){return new Promise((t,r)=>{let e=We.createHash("sha256"),n=D.createReadStream(s);n.on("error",r),n.on("end",()=>t(e.digest("hex"))),n.on("data",o=>e.update(o))})}function Le(s){D.mkdirSync(s,{recursive:!0})}function Je(s){return new Promise((t,r)=>{let e=le.get(s,{agent:Ae},n=>{if(n.statusCode!==200){r(new Error(`HTTP ${n.statusCode} for ${s}`)),n.resume();return}let o="";n.setEncoding("utf8"),n.on("data",a=>o+=a),n.on("end",()=>{try{t(JSON.parse(o))}catch(a){r(a)}})});e.on("error",r),e.setTimeout(3e4,()=>{e.destroy(),r(new Error("JSON fetch timeout"))})})}function j(s){return new Promise(t=>setTimeout(t,s))}function Te(){return{cancelled:!1,requests:new Set}}function de(s){if(s){s.cancelled=!0;for(let t of s.requests)try{t.destroy(new Error("cancelled"))}catch{}s.requests.clear()}}var Ge=new Set(["ECONNRESET","ETIMEDOUT","EAI_AGAIN","ECONNABORTED","ENETRESET","EHOSTUNREACH","ENETUNREACH","EPIPE","ENOTFOUND","ECONNREFUSED","EHOSTDOWN","ENETDOWN","EPERM","EBUSY","EACCES"]);async function te(s,t,r,e=1,n,o=0,a=0){return new Promise((c,h)=>{Le(L.dirname(t));let l;try{l=D.createWriteStream(t,{flags:o>0?"a":"w"})}catch(i){if(e<8&&(i.code==="EPERM"||i.code==="EBUSY"||i.code==="EACCES")){let A=Math.min(1e3*e,5e3);return j(A).then(()=>c(te(s,t,r,e+1,n,o,a)))}return h(i)}if(n?.cancelled)return l.close(()=>{}),h(new Error("cancelled"));let d=!1,u=i=>{d||(d=!0,c(i))},p=i=>{d||(d=!0,h(i))},g={agent:Ae};o>0&&(g.headers={Range:`bytes=${o}-`});let w=0,f=null,x=()=>new Promise(i=>{try{l.close(()=>i())}catch{i()}}),S=async(i,A=!1)=>{try{f&&clearInterval(f)}catch{}try{await x()}catch{}if(await j(100),A)try{D.unlinkSync(t)}catch{}if(e<8){let C=Math.min(1e3*Math.pow(1.5,e),15e3),b=Math.random()*1e3,R=C+b;return await j(R),u(te(s,t,r,e+1,n,i,a)),!0}return!1},k=le.get(s,g,i=>{if(i.statusCode!==200&&!(o>0&&i.statusCode===206)){if(d=!0,o>0&&i.statusCode===200){i.resume(),S(0,!0).then(P=>{P||h(new Error(`HTTP ${i.statusCode} for ${s}`))});return}if(o>0&&i.statusCode===416){i.resume(),S(0,!0).then(P=>{P||h(new Error(`HTTP ${i.statusCode} for ${s}`))});return}if(i.statusCode&&[429,500,502,503,504].includes(i.statusCode)&&e<5){i.resume(),S(o,!1).then(P=>{P||h(new Error(`HTTP ${i.statusCode} for ${s}`))});return}x().then(()=>{D.unlink(t,()=>{}),h(new Error(`HTTP ${i.statusCode} for ${s}`))}),i.resume();return}let A=Number(i.headers["content-length"]||0),C=a>0?a:o>0?o+A:A,b=Date.now(),R=e<=2?3e4:45e3;f=setInterval(()=>{if(!n?.cancelled&&Date.now()-b>R)try{let P=new Error("stalled");P.code="ETIMEDOUT",k.destroy(P)}catch{}},1e4),i.on("data",async P=>{await De.consumeTokens(P.length),w+=P.length,b=Date.now(),r&&r(Math.min(o+w,C||o+w),C||0)}),i.on("aborted",async()=>{await S(o+w)||p(new Error("response aborted"))}),Oe(i,l).then(()=>{try{f&&clearInterval(f)}catch{}u()}).catch(async P=>{try{f&&clearInterval(f)}catch{}let $=String(P?.message||P||"").toLowerCase();($.includes("aborted")||$.includes("socket")||$.includes("closed"))&&await S(o+w)||p(P)})});if(n?.requests.add(k),k.on("socket",i=>{try{i.setKeepAlive(!0,6e4),i.setNoDelay(!0),i.setRecvBufferSize&&i.setRecvBufferSize(64*1024),i.setSendBufferSize&&i.setSendBufferSize(64*1024)}catch{}}),k.on("close",()=>n?.requests.delete(k)),k.setTimeout(9e4,()=>{try{let i=new Error("Request timeout");i.code="ETIMEDOUT",k.destroy(i)}catch{}}),n?.cancelled)try{k.destroy(new Error("cancelled"))}catch{}k.on("error",async i=>{let A=i?.code,C=String(i?.message||"").toLowerCase(),b=C.includes("aborted")||C.includes("socket")||C.includes("closed");if(e<8&&(b||A&&Ge.has(String(A)))){let P=o;try{P=D.statSync(t).size}catch{}await S(P)||p(i)}else{let P=new Promise($=>{try{l.close(()=>$())}catch{$()}});try{await P}catch{}p(i)}})})}async function Ke(s,t,r){try{let e=D.statSync(s);return r&&Number(r)>0&&e.size!==Number(r)?!1:(await O(s)).toLowerCase()===String(t).toLowerCase()}catch{return!1}}async function $e(s){let t=`${s.replace(/\/$/,"")}/checksums.json`;return Je(t)}async function Ye(s,t,r,e,n=4,o){let a=ie(t.path).split("/").join(L.sep),c=L.join(r,a);if(Le(L.dirname(c)),await Ke(c,t.checksum,t.size))return e("progress:skip",{path:t.path}),{downloadComplete:!0,verificationComplete:!0,targetPath:c};if(o?.cancelled)throw new Error("cancelled");if(Array.isArray(t.parts)&&t.parts.length>0){let l=t.parts.length,d=new Array(l),u=0,p=new Set;async function g(){for(;;){let f=u++;if(f>=l)return;if(p.has(f))continue;p.add(f);let x=t.parts[f],S=ie(x.path),k=`${s.replace(/\/$/,"")}/${S}`,i=`${c}.part${f}`;try{if(D.existsSync(i))if((await O(i)).toLowerCase()===String(x.checksum).toLowerCase()){e("progress:part",{path:t.path,part:f,totalParts:l,received:Number(x.size||0),total:Number(x.size||0)}),d[f]=i;continue}else try{D.unlinkSync(i)}catch{}}catch{}let A=0;for(;;){if(o?.cancelled)throw new Error("cancelled");A+=1;let C=0,b=0;try{let $=0;try{$=D.statSync(i).size}catch{}let U=Number(x.size||0);if(U>0&&$>U)try{D.unlinkSync(i),$=0}catch{}await te(k,i,(_,F)=>{let W=Math.max(0,_-b);b=_;try{W>0&&e("progress:bytes",{delta:W})}catch{}C+=W;let q=U||F||0;e("progress:part",{path:t.path,part:f,totalParts:l,received:Math.min(_,q||_),total:q})},1,o,$,U)}catch{try{D.unlinkSync(i)}catch{}try{C>0&&e("progress:bytes",{delta:-C})}catch{}try{e("progress:part:reset",{path:t.path,part:f,totalParts:l})}catch{}let U=Math.min(2e3*A,1e4);await j(U);continue}if((await O(i)).toLowerCase()===String(x.checksum).toLowerCase())break;try{D.unlinkSync(i)}catch{}try{C>0&&e("progress:bytes",{delta:-C})}catch{}try{e("progress:part:reset",{path:t.path,part:f,totalParts:l})}catch{}let P=Math.min(2e3*A,1e4);await j(P)}d[f]=i}}let w=Array.from({length:Math.max(1,n)},()=>g());return await Promise.all(w),{downloadComplete:!0,verificationComplete:!1,targetPath:c,mergeAndVerifyAsync:async()=>{e("progress:merge:start",{path:t.path,parts:d.length});let f=D.createWriteStream(c);for(let S=0;S<d.length;S++){let k=d[S];e("progress:merge:part",{path:t.path,part:S,totalParts:d.length}),await new Promise((i,A)=>{let C=D.createReadStream(k);C.on("error",A),f.on("error",A),C.on("end",()=>{try{D.unlinkSync(k)}catch{}i()}),C.pipe(f,{end:!1})})}await new Promise((S,k)=>{f.on("error",k),f.on("finish",S),f.end()});try{e("progress:merge:done",{path:t.path})}catch{}if(e("progress:verify",{path:t.path}),(await O(c)).toLowerCase()!==String(t.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${t.path}`);try{let S=D.readdirSync(L.dirname(c)),k=L.basename(c);S.forEach(i=>{if(i.startsWith(k+".part"))try{D.unlinkSync(L.join(L.dirname(c),i))}catch{}})}catch{}return{verificationComplete:!0,targetPath:c,filePath:t.path}}}}else{let l=ie(t.path),d=`${s.replace(/\/$/,"")}/${l}`,u=0;for(;;){u+=1;let p=0,g=0,w=`${c}.download`,f=0;try{f=D.statSync(w).size}catch{}let x=Number(t.size||0);if(x>0&&f>x)try{D.unlinkSync(w),f=0}catch{}if(await te(d,w,(k,i)=>{let A=Math.max(0,k-g);g=k;try{A>0&&e("progress:bytes",{delta:A})}catch{}p+=A;let C=x||i||0;e("progress:file",{path:t.path,received:Math.min(k,C||k),total:C})},1,o,f,x),(await O(w)).toLowerCase()===String(t.checksum).toLowerCase())break;try{D.unlinkSync(w)}catch{}try{p>0&&e("progress:bytes",{delta:-p})}catch{}if(u>=2)throw new Error(`Checksum mismatch for ${t.path}`)}try{D.unlinkSync(c)}catch{}D.renameSync(`${c}.download`,c)}if(e("progress:verify",{path:t.path}),(await O(c)).toLowerCase()!==String(t.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${t.path}`);return{downloadComplete:!0,verificationComplete:!0,targetPath:c}}async function Re(s,t,r,e,n=!1,o=4,a=4,c,h){let l=new Set,d=[];for(let k of t.files||[]){if(!(n||!k.optional))continue;let i=Ce(k.path);i&&(l.has(i)||(l.add(i),d.push(k)))}let u=d.filter(k=>!(Array.isArray(k.parts)&&k.parts.length>0)),p=d.filter(k=>Array.isArray(k.parts)&&k.parts.length>0),g=u.concat(p),w=g.length,f=0,x=g.reduce((k,i)=>{let A=Number(i.size||0);return A>0?k+A:Array.isArray(i.parts)&&i.parts.length?k+i.parts.reduce((C,b)=>C+Number(b.size||0),0):k},0);try{e("progress:bytes:total",{totalBytes:x})}catch{}async function S(k,i,A,C=!1){let b=0,R=[];async function P(){for(;;){for(;h&&h();)if(await j(100),c?.cancelled)return;let U=b++;if(U>=k.length)return;let _=k[U],F=i+U,W=Ce(_.path),q=async()=>Ye(s,_,r,e,a,c),Ee=!1,Z=G.get(W);Z?Ee=!0:(e("progress:start",{index:F,total:w,path:_.path,completed:f}),Z=(async()=>{try{let I=await q();if(C&&I?.mergeAndVerifyAsync){let Pe=I.mergeAndVerifyAsync().then(M=>(M?.filePath&&(f+=1,e("progress:done",{index:F,total:w,path:M.filePath,completed:f})),M)).catch(M=>{if(String(M?.message||M||"error").includes("cancelled"))throw M;try{let B=L.join(r,_.path.replace(/\\/g,L.sep));try{D.unlinkSync(B)}catch{}try{let N=D.readdirSync(L.dirname(B)),z=L.basename(B);N.forEach(ee=>{if(ee.startsWith(z+".part"))try{D.unlinkSync(L.join(L.dirname(B),ee))}catch{}})}catch{}return q().then(N=>N.mergeAndVerifyAsync?N.mergeAndVerifyAsync().then(z=>(z?.filePath&&(f+=1,e("progress:done",{index:F,total:w,path:z.filePath,completed:f})),z)):N)}catch(B){try{e("progress:error",{path:_.path,message:String(B?.message||B)})}catch{}throw B}});return R.push(Pe),{...I,skipProgressDone:!0}}return I}catch(I){if(String(I?.message||I||"error").includes("cancelled"))throw I;try{let M=L.join(r,_.path.replace(/\\/g,L.sep));try{D.unlinkSync(M)}catch{}let J=await q();if(C&&J?.mergeAndVerifyAsync){let B=J.mergeAndVerifyAsync().then(N=>(N?.filePath&&(f+=1,e("progress:done",{index:F,total:w,path:N.filePath,completed:f})),N)).catch(N=>{try{let z=L.join(r,_.path.replace(/\\/g,L.sep)),ee=D.readdirSync(L.dirname(z)),Fe=L.basename(z);ee.forEach(ve=>{if(ve.startsWith(Fe+".part"))try{D.unlinkSync(L.join(L.dirname(z),ve))}catch{}})}catch{}try{e("progress:error",{path:_.path,message:String(N?.message||N)})}catch{}throw N});return R.push(B),{...J,skipProgressDone:!0}}return J}catch(M){try{e("progress:error",{path:_.path,message:String(M?.message||M)})}catch{}throw M}}})(),G.set(W,Z));let xe;try{xe=await Z}finally{Ee||G.delete(W)}xe?.skipProgressDone||(f+=1,e("progress:done",{index:F,total:w,path:_.path,completed:f})),await j(10)}}let $=Array.from({length:Math.max(1,A)},()=>P());await Promise.all($),R.length>0&&await Promise.all(R)}if(await S(u,0,Math.max(1,o)),G.size>0)try{await Promise.all([...G.values()])}catch{}await S(p,u.length,1,!0)}import he from"node:fs";import Xe from"node:path";import{app as Qe}from"electron";var _e=Qe.getPath("userData"),Me=Xe.join(_e,"settings.json");function ue(){try{let s=he.readFileSync(Me,"utf-8");return JSON.parse(s)}catch{return{}}}function Ze(s){he.mkdirSync(_e,{recursive:!0}),he.writeFileSync(Me,JSON.stringify(s,null,2),"utf-8")}function fe(s,t=void 0){return ue()[s]??t}function re(s,t){let r=ue();r[s]=t,Ze(r)}function K(){return ue()}var ze=et(import.meta.url),{autoUpdater:V}=ze("electron-updater"),Ue=ze("electron-log"),st=tt(import.meta.url),Y=m.dirname(st);var E,H=null,pe=new Set,se=new Map,oe=new Map,ye="r5v",ae=[];function Ie(s){try{return(s||[]).filter(t=>typeof t=="string"&&t.startsWith(`${ye}://`))}catch{return[]}}function Se(s){try{let t=new URL(s);if(t.hostname==="mod"&&t.pathname==="/install"){let r=t.searchParams.get("name")||"",e=t.searchParams.get("version")||"",n=t.searchParams.get("downloadUrl")?.split(",")||"";if(E&&E.webContents&&!E.webContents.isLoading())try{E.webContents.send("deeplink:mod-install",{url:s,name:r,version:e,downloadUrls:n})}catch{}else ae.push(s)}}catch{}}function ot(){for(;ae.length;){let s=ae.shift();Se(s)}}var at=T.requestSingleInstanceLock();at?T.on("second-instance",(s,t)=>{try{Ie(t).forEach(e=>Se(e)),E&&(E.isMinimized()&&E.restore(),E.focus())}catch{}}):T.quit();T.on("open-url",(s,t)=>{s.preventDefault(),Se(t)});async function Be(){let s=fe("windowState",{width:1150,height:800,x:void 0,y:void 0,isMaximized:!1});E=new Ve({width:s.width,height:s.height,x:s.x,y:s.y,minWidth:1150,minHeight:800,frame:!1,titleBarStyle:"hidden",webPreferences:{preload:m.join(Y,"preload.cjs"),contextIsolation:!0,nodeIntegration:!1},show:!1,icon:m.join(Y,"..","public","icon.png")});let t=process.env.VITE_DEV_SERVER_URL;if(t)await E.loadURL(t);else{let a=m.join(Y,"..","dist","index.html");await E.loadFile(a)}E.webContents.setWindowOpenHandler(({url:a})=>{try{me.openExternal(a)}catch{}return{action:"deny"}}),E.webContents.on("will-navigate",(a,c)=>{let h=c.startsWith("file:"),l=!!process.env.VITE_DEV_SERVER_URL&&c.startsWith(String(process.env.VITE_DEV_SERVER_URL));if(!h&&!l){a.preventDefault();try{me.openExternal(c)}catch{}}});let r=()=>{E&&(E.isVisible()||E.show(),E.isFocused()||E.focus())};s.isMaximized&&E.maximize(),E.once("ready-to-show",r),E.webContents.once("did-finish-load",r);let e=setTimeout(r,1e3);E.on("show",()=>clearTimeout(e));function n(){if(!E)return;let a=E.getBounds(),c=E.isMaximized();re("windowState",{width:a.width,height:a.height,x:a.x,y:a.y,isMaximized:c})}E.on("resize",n),E.on("move",n),E.on("maximize",n),E.on("unmaximize",n),(!!process.env.VITE_DEV_SERVER_URL||process.env.NODE_ENV==="development")&&E.webContents.openDevTools({mode:"detach"}),E.webContents.on("did-fail-load",(a,c,h,l)=>{console.error("Load failed",{errorCode:c,errorDesc:h,validatedURL:l}),we.showErrorBox("Load failed",`${h} (code ${c})
URL: ${l}`),E.show()})}T.on("window-all-closed",()=>{process.platform!=="darwin"&&T.quit()});T.whenReady().then(()=>{try{process.defaultApp&&process.platform==="win32"?T.setAsDefaultProtocolClient(ye,process.execPath,[process.argv[1]]):T.setAsDefaultProtocolClient(ye)}catch{}let s=m.resolve(T.getAppPath(),".."),t=m.join(s,"cache");Ne.registerFileProtocol("r5v",(e,n)=>{try{let o=new URL(e.url),a=decodeURIComponent(o.pathname).replace(/^\//,""),c=m.normalize(m.join(t,a));n({path:c})}catch{n({error:-6})}});let r=m.join(Y,"..","dist");Ne.interceptFileProtocol("file",(e,n)=>{try{let o=new URL(e.url),a=decodeURIComponent(o.pathname),c=a.replace(/\\/g,"/"),h=c.indexOf("/_astro/");if(h!==-1){let l=c.substring(h+8),d=m.join(r,"_astro",l);return n({path:d})}if(c.endsWith("/favicon.svg")||/\/favicon\.svg$/i.test(c)){let l=m.join(r,"favicon.svg");return n({path:l})}if(c.startsWith("/")){let l=c.replace(/^\/+/,""),d=m.join(r,l);try{return y.accessSync(d),n({path:d})}catch{}}return n({path:a})}catch{return n({error:-6})}}),Be();try{Ie(process.argv).forEach(e=>ae.push(e))}catch{}try{E?.webContents?.once("did-finish-load",ot)}catch{}try{V.autoDownload=!1;try{V.logger=Ue,Ue.transports.file.level="info"}catch{}V.on("error",e=>{try{E?.webContents.send("update:error",{message:String(e?.stack||e?.message||e)})}catch{}}),V.on("update-available",e=>{try{E?.webContents.send("update:available",e)}catch{}}),V.on("update-not-available",e=>{try{E?.webContents.send("update:not-available",e)}catch{}}),V.on("download-progress",e=>{try{E?.webContents.send("update:download-progress",e)}catch{}}),V.on("update-downloaded",e=>{try{E?.webContents.send("update:downloaded",e)}catch{}})}catch{}T.on("activate",()=>{Ve.getAllWindows().length===0&&Be()})});v.handle("update:check",async()=>{try{return{ok:!0,result:(await V.checkForUpdates())?.updateInfo||null}}catch(s){return{ok:!1,error:String(s?.message||s)}}});v.handle("update:download",async()=>{try{return await V.downloadUpdate(),{ok:!0}}catch(s){return{ok:!1,error:String(s?.message||s)}}});v.handle("update:quitAndInstall",async()=>{try{return setImmediate(()=>V.quitAndInstall(!1,!0)),{ok:!0}}catch(s){return{ok:!1,error:String(s?.message||s)}}});v.handle("app:getVersion",async()=>{try{return T.getVersion()}catch{return"0.0.0"}});v.handle("app:getBaseDir",async()=>{try{return m.resolve(T.getAppPath(),"..")}catch{return""}});v.handle("app:getLauncherInstallRoot",async()=>{try{let s=process.env.LOCALAPPDATA||m.join(T.getPath("home"),"AppData","Local");return m.join(s,"Programs","r5vlauncher")}catch{return""}});function it(s){try{let t=m.join(s,"mods.vdf"),r=y.readFileSync(t,"utf-8"),e={},n=/"([^"]+)"\s*"([01])"/g,o;for(;o=n.exec(r);){let a=o[1];a&&a!=="ModList"&&(e[a]=o[2]==="1")}return e}catch{return{}}}function ke(s){try{let t=m.join(s,"mods.vdf"),r=y.readFileSync(t,"utf-8"),e={},n=[],o=/"([^"]+)"\s*"([01])"/g,a;for(;a=o.exec(r);){let c=a[1];!c||c==="ModList"||(c in e||n.push(c),e[c]=a[2]==="1")}return{map:e,order:n}}catch{return{map:{},order:[]}}}function ge(s){try{let t=y.readFileSync(s,"utf-8"),r=t.match(/"id"\s*"([^"]+)"/i),e=t.match(/"name"\s*"([^"]+)"/i),n=r?r[1]:null,o=e?e[1]:null;return{id:n,name:o}}catch{return{id:null,name:null}}}function ct(s,t){let r=['"ModList"',"{"];for(let[e,n]of Object.entries(t))r.push(`	"${e}"		"${n?"1":"0"}"`);r.push("}"),y.mkdirSync(s,{recursive:!0}),y.writeFileSync(m.join(s,"mods.vdf"),r.join(`
`),"utf-8")}function je(s,t,r){let e=new Set,n=['"ModList"',"{"],o=a=>{n.push(`	"${a}"		"${r[a]?"1":"0"}"`),e.add(a)};for(let a of Array.isArray(t)?t:[])Object.prototype.hasOwnProperty.call(r,a)&&!e.has(a)&&o(a);for(let a of Object.keys(r))e.has(a)||o(a);n.push("}"),y.mkdirSync(s,{recursive:!0}),y.writeFileSync(m.join(s,"mods.vdf"),n.join(`
`),"utf-8")}v.handle("mods:listInstalled",async(s,{installDir:t})=>{try{let r=m.join(t,"mods"),{map:e,order:n}=ke(r),o=[],a=y.existsSync(r)?y.readdirSync(r,{withFileTypes:!0}):[];for(let h of a){if(!h.isDirectory())continue;let l=m.join(r,h.name),d=m.join(l,"manifest.json"),u=m.join(l,"mod.vdf"),p=m.join(l,"icon.png"),g=null;try{g=JSON.parse(y.readFileSync(d,"utf-8"))}catch{}let w=ge(u),f=w.id||g?.name||h.name,x=null;try{x=`data:image/png;base64,${y.readFileSync(p).toString("base64")}`}catch{}o.push({id:f,name:g?.name||w.name||h.name,folder:h.name,version:g?.version_number||null,description:g?.description||"",enabled:f?!!e[f]:!1,hasManifest:y.existsSync(d),iconDataUrl:x})}let c=new Map(n.map((h,l)=>[h,l]));return o.sort((h,l)=>{let d=h.id!=null&&c.has(h.id)?c.get(h.id):Number.MAX_SAFE_INTEGER,u=l.id!=null&&c.has(l.id)?c.get(l.id):Number.MAX_SAFE_INTEGER;return d!==u?d-u:String(h.name||"").localeCompare(String(l.name||""))}),{ok:!0,mods:o}}catch(r){return{ok:!1,error:String(r?.message||r)}}});v.handle("mods:setEnabled",async(s,{installDir:t,name:r,enabled:e})=>{try{let n=m.join(t,"mods"),{map:o}=ke(n);return o[r]=!!e,je(n,void 0,o),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});v.handle("mods:reorder",async(s,{installDir:t,orderIds:r})=>{try{let e=m.join(t,"mods"),{map:n,order:o}=ke(e),a=Array.isArray(r)?r.filter(d=>typeof d=="string"&&d&&Object.prototype.hasOwnProperty.call(n,d)):[],c=new Set(a),h=o.filter(d=>Object.prototype.hasOwnProperty.call(n,d)&&!c.has(d)),l=[...a,...h];return je(e,l,n),{ok:!0}}catch(e){return{ok:!1,error:String(e?.message||e)}}});v.handle("mods:uninstall",async(s,{installDir:t,folder:r})=>{try{let e=m.join(t,"mods"),n=m.join(e,r);return y.rmSync(n,{recursive:!0,force:!0}),{ok:!0}}catch(e){return{ok:!1,error:String(e?.message||e)}}});v.handle("mods:fetchAll",async(s,{query:t})=>{let r="https://thunderstore.io/c/r5valkyrie/api/v1/package-listing-index/",e=o=>new Promise((a,c)=>{Q.get(o,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"*/*"}},l=>{if(l.statusCode&&l.statusCode>=300&&l.statusCode<400&&l.headers.location){l.resume();let u=l.headers.location.startsWith("http")?l.headers.location:new URL(l.headers.location,o).toString();return a(e(u))}if(l.statusCode!==200)return l.resume(),c(new Error(`HTTP ${l.statusCode}`));let d=[];l.on("data",u=>d.push(Buffer.isBuffer(u)?u:Buffer.from(u))),l.on("end",()=>a(Buffer.concat(d)))}).on("error",c)}),n=o=>{try{return rt.gunzipSync(o)}catch{return o}};try{let o=await e(r),a=JSON.parse(n(o).toString("utf8")),c=Array.isArray(a)?a:[],h=6,l=[],d=0;await Promise.all(Array.from({length:h}).map(async()=>{for(;d<c.length;){let p=d++,g=c[p];try{let w=await e(g),f=n(w).toString("utf8"),x=JSON.parse(f);Array.isArray(x)&&l.push(...x)}catch{}}}));let u=l;if(t&&String(t).trim()){let p=String(t).toLowerCase();u=u.filter(g=>String(g?.name||"").toLowerCase().includes(p)||String(g?.full_name||"").toLowerCase().includes(p))}return{ok:!0,mods:u}}catch(o){try{let c=await e("https://thunderstore.io/c/r5valkyrie/api/v1/package/"),h=JSON.parse(c.toString("utf8")),l=Array.isArray(h)?h:[];if(t&&String(t).trim()){let d=String(t).toLowerCase();l=l.filter(u=>String(u?.name||"").toLowerCase().includes(d)||String(u?.full_name||"").toLowerCase().includes(d))}return{ok:!0,mods:l}}catch(a){return{ok:!1,error:String(a?.message||o?.message||a||o)}}}});v.handle("mods:install",async(s,{installDir:t,name:r,downloadUrl:e})=>{if(!e.startsWith("https://thunderstore.io"))return{ok:!1,error:"Download URL does not point to Thunderstore"};try{let n=String(r||"").trim();if(!n)return{ok:!1,error:"Invalid mod name"};if(pe.has(n))return{ok:!0};pe.add(n);let o=m.join(t,"mods");y.mkdirSync(o,{recursive:!0});let a=m.join(o,`.__mod_${Date.now()}.zip`),c=(u,p=0)=>new Promise((g,w)=>{if(p>5)return w(new Error("Too many redirects"));let f=y.createWriteStream(a);Q.get(u,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"application/octet-stream,*/*;q=0.8",Referer:"https://thunderstore.io/",Connection:"keep-alive"}},S=>{if(S.statusCode&&S.statusCode>=300&&S.statusCode<400&&S.headers.location){S.resume(),f.close(()=>{});try{y.unlinkSync(a)}catch{}let b=S.headers.location.startsWith("http")?S.headers.location:new URL(S.headers.location,u).toString();return g(c(b,p+1))}if(S.statusCode!==200){f.close(()=>{});try{y.unlinkSync(a)}catch{}return S.resume(),w(new Error(`HTTP ${S.statusCode}`))}let k=Number(S.headers["content-length"]||0),i=0,A=Date.now(),C=b=>{try{s?.sender?.send("mods:progress",{key:r,phase:b,received:i,total:k})}catch{}};S.on("data",b=>{i+=Buffer.isBuffer(b)?b.length:Buffer.byteLength(String(b));let R=Date.now();R-A>150&&(A=R,C("downloading"))}),S.pipe(f),f.on("finish",()=>{C("downloading"),f.close(g)})}).on("error",S=>{try{y.unlinkSync(a)}catch{}w(S)})});await c(e);try{s?.sender?.send("mods:progress",{key:r,phase:"extracting"})}catch{}let h=m.join(o,r);try{y.rmSync(h,{recursive:!0,force:!0})}catch{}y.mkdirSync(h,{recursive:!0}),await new Promise((u,p)=>{let g=ne("powershell.exe",["-NoProfile","-NonInteractive","-Command",`Expand-Archive -LiteralPath "${a}" -DestinationPath "${h}" -Force`],{stdio:"ignore"});g.on("exit",w=>w===0?u():p(new Error(`Expand-Archive failed ${w}`))),g.on("error",p)});try{y.unlinkSync(a)}catch{}let l=null;try{let u=m.join(h,"mod.vdf");if(y.existsSync(u))l=ge(u).id;else{let p=y.readdirSync(h,{withFileTypes:!0});for(let g of p)if(g.isDirectory()){let w=m.join(h,g.name,"mod.vdf");if(y.existsSync(w)&&(l=ge(w).id,l))break}}}catch{}let d=it(o);d[l||r]=!0,ct(o,d);try{s?.sender?.send("mods:progress",{key:r,phase:"done"})}catch{}return{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}finally{try{pe.delete(String(r||""))}catch{}}});v.handle("mods:watch",async(s,{installDir:t})=>{try{let r=m.join(t,"mods");if(!y.existsSync(r))return{ok:!0};let e=r;if(se.has(e))return{ok:!0};let n=y.watch(r,{persistent:!0},(o,a)=>{let c=e;clearTimeout(oe.get(c));let h=setTimeout(()=>{try{E?.webContents?.send("mods:changed",{installDir:t})}catch{}},300);oe.set(c,h)});return se.set(e,n),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});v.handle("mods:unwatch",async(s,{installDir:t})=>{try{let e=m.join(t,"mods"),n=se.get(e);if(n){try{n.close()}catch{}se.delete(e)}let o=oe.get(e);return o&&(clearTimeout(o),oe.delete(e)),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});v.handle("mods:iconDataUrl",async(s,{installDir:t,folder:r})=>{try{let e=m.join(t,"mods",r,"icon.png");return await y.promises.access(e),{ok:!0,dataUrl:`data:image/png;base64,${(await y.promises.readFile(e)).toString("base64")}`}}catch(e){return{ok:!1,error:String(e?.message||e)}}});v.handle("select-directory",async()=>{let s=await we.showOpenDialog({properties:["openDirectory","createDirectory"]});return s.canceled||s.filePaths.length===0?null:s.filePaths[0]});v.handle("settings:get",()=>K());v.handle("settings:set",(s,{key:t,value:r})=>re(t,r));v.handle("download:checksums",async(s,{baseUrl:t})=>$e(t));v.handle("download:all",async(s,{baseUrl:t,checksums:r,installDir:e,includeOptional:n,concurrency:o,partConcurrency:a,channelName:c,mode:h})=>{let l=(d,u)=>s.sender.send(d,u);try{if(!(String(h||"install").toLowerCase()==="install")){let u=m.join(e,"mods","mods.vdf");if(y.existsSync(u)){let g=(Array.isArray(r?.files)?r.files:[]).filter(w=>{try{return String(w?.path||w?.name||"").replace(/\\/g,"/").toLowerCase()!=="mods/mods.vdf"}catch{return!0}});r={...r||{},files:g}}}}catch{}H=Te(),X=!1;try{await Re(t,r,e,l,!!n,Number(o)||4,Number(a)||4,H,()=>X);try{let d=fe("channels",{})||{};d[String(c||"default")]={installDir:e,gameVersion:r?.game_version||null,gameBaseUrl:t,lastUpdatedAt:Date.now()},re("channels",d)}catch(d){console.error("Failed to persist channel info",d)}}finally{H=null}return!0});v.handle("default-install-dir",(s,{channelName:t})=>{let e=K()?.customBaseDir,n;if(e&&typeof e=="string"&&e.trim())n=e;else{let o=process.env.LOCALAPPDATA||m.join(T.getPath("home"),"AppData","Local");n=m.join(o,"Programs","R5VLibrary")}return t?m.join(n,t):n});v.handle("scan-custom-channels",async(s,{officialChannelNames:t,channelsSettings:r})=>{try{let e=[],n=new Set((t||[]).map(d=>d.toLowerCase())),o=new Set,a=async d=>{try{return await y.promises.access(m.join(d,"r5apex.exe")),!0}catch{try{return await y.promises.access(m.join(d,"r5apex_ds.exe")),!0}catch{return!1}}},h=K()?.customBaseDir,l;if(h&&typeof h=="string"&&h.trim())l=h;else{let d=process.env.LOCALAPPDATA||m.join(T.getPath("home"),"AppData","Local");l=m.join(d,"Programs","R5VLibrary")}try{await y.promises.access(l);let d=await y.promises.readdir(l,{withFileTypes:!0});for(let u of d){if(!u.isDirectory())continue;let p=u.name,g=m.join(l,p),w=g.toLowerCase();o.has(w)||n.has(p.toLowerCase())||await a(g)&&(e.push({name:p,installDir:g,isCustom:!0}),o.add(w))}}catch{}if(r&&typeof r=="object")for(let[d,u]of Object.entries(r)){if(!u||typeof u!="object")continue;let p=u.installDir;if(!p||typeof p!="string")continue;let g=p.toLowerCase();if(!o.has(g)&&await a(p)){let w=m.basename(p);n.has(w.toLowerCase())||(e.push({name:w,installDir:p,isCustom:!0}),o.add(g))}}if(r&&typeof r=="object"){let d=new Set;for(let u of Object.values(r))if(u&&typeof u=="object"&&u.installDir){let p=m.dirname(u.installDir);d.add(p)}for(let u of d)try{let p=await y.promises.readdir(u,{withFileTypes:!0});for(let g of p){if(!g.isDirectory())continue;let w=g.name,f=m.join(u,w),x=f.toLowerCase();o.has(x)||n.has(w.toLowerCase())||await a(f)&&(e.push({name:w,installDir:f,isCustom:!0}),o.add(x))}}catch{}}return e}catch(e){return console.error("Error scanning for custom channels:",e),[]}});v.handle("open-folder",async(s,{folderPath:t})=>{try{if(!t)return{ok:!1,error:"No folder path provided"};try{await y.promises.access(t)}catch{return{ok:!1,error:"Folder does not exist"}}return await me.openPath(t),{ok:!0}}catch(r){return console.error("Error opening folder:",r),{ok:!1,error:String(r)}}});v.handle("set-download-speed-limit",async(s,{bytesPerSecond:t})=>{try{let r=Number(t)||0;return be(r),{ok:!0}}catch(r){return console.error("Error setting download speed limit:",r),{ok:!1,error:String(r)}}});v.handle("launcher:config",async(s,{url:t})=>(e=>new Promise((n,o)=>{Q.get(e,a=>{if(a.statusCode!==200){o(new Error(`HTTP ${a.statusCode} for ${e}`)),a.resume();return}let c="";a.setEncoding("utf8"),a.on("data",h=>c+=h),a.on("end",()=>{try{n(JSON.parse(c))}catch(h){o(h)}})}).on("error",o)}))(t));v.handle("eula:get",async()=>{let s="https://playvalkyrie.org/api/eula",t=r=>new Promise((e,n)=>{Q.get(r,o=>{if(o.statusCode!==200){n(new Error(`HTTP ${o.statusCode}`)),o.resume();return}let a=[];o.on("data",c=>a.push(Buffer.isBuffer(c)?c:Buffer.from(c))),o.on("end",()=>{try{let c=Buffer.concat(a).toString("utf8");e(JSON.parse(c))}catch(c){n(c)}})}).on("error",n)});try{return{ok:!0,json:await t(s)}}catch(r){return{ok:!1,error:String(r?.message||r)}}});v.handle("video:cache",async(s,{filename:t})=>{try{let e=`https://blaze.playvalkyrie.org/video_backgrounds/${t}`,n=m.join(m.resolve(T.getAppPath(),".."),"cache"),o=m.join(n,"videos"),a=m.join(o,t),c=m.join(Y,"..","dist"),h=m.join(c,t);await y.promises.mkdir(o,{recursive:!0});try{if((await y.promises.stat(a)).size>0){try{await y.promises.access(h)}catch{await y.promises.copyFile(a,h)}return`./${t}`}else await y.promises.unlink(a)}catch{}return await new Promise((l,d)=>{let u=y.createWriteStream(a),p=Q.get(e,g=>{if(g.statusCode!==200){u.close(()=>{}),y.unlink(a,()=>{}),d(new Error(`HTTP ${g.statusCode} for video ${t}`)),g.resume();return}g.pipe(u),u.on("finish",()=>u.close(l)),u.on("error",w=>{y.unlink(a,()=>d(w))})});p.on("error",g=>{u.close(()=>{}),y.unlink(a,()=>{}),d(g)}),p.setTimeout(3e4,()=>{p.destroy(),u.close(()=>{}),y.unlink(a,()=>{}),d(new Error(`Video download timeout for ${t}`))})}),await y.promises.copyFile(a,h),`./${t}`}catch(r){throw console.error(`Video cache error for ${t}:`,r),r}});v.handle("fs:is-installed-in-dir",async(s,{path:t})=>{let r=!1,e=!1;try{await y.promises.access(m.join(t,"r5apex.exe")),r=!0}catch{}try{await y.promises.access(m.join(t,"r5apex_ds.exe")),e=!0}catch{}return r||e});var X=!1;v.handle("download:pause",async()=>{X=!0;try{E?.webContents.send("progress:paused",{})}catch{}return!0});v.handle("download:resume",async()=>{X=!1;try{E?.webContents.send("progress:resumed",{})}catch{}return!0});v.handle("download:cancel",async()=>{try{de(H)}catch{}H=null,X=!1;try{E?.webContents.send("progress:cancelled",{})}catch{}return!0});v.handle("select-file",async(s,{filters:t})=>{let r=await we.showOpenDialog({properties:["openFile"],filters:Array.isArray(t)?t:void 0});return r.canceled||r.filePaths.length===0?null:r.filePaths[0]});v.handle("game:launch",async(s,{channelName:t,installDir:r,mode:e,argsString:n})=>{try{if(!r)throw new Error("Missing installDir");let o=String(e).toUpperCase()==="SERVER"?"r5apex_ds.exe":"r5apex.exe",a=m.join(r,o);await y.promises.access(a).catch(()=>{throw new Error(`Executable not found: ${a}`)});let h=(d=>!d||typeof d!="string"?[]:(d.match(/(?:[^\s\"]+|\"[^\"]*\")+/g)||[]).map(p=>p.replace(/^\"|\"$/g,"")))(n);return ne(a,h,{cwd:r,detached:!0,stdio:"ignore",env:{...process.env}}).unref(),{ok:!0}}catch(o){return{ok:!1,error:String(o?.message||o)}}});v.handle("fix-folder-permissions",async(s,{selectedChannel:t})=>{let r=[],e=K().channels[t].installDir;try{if(!e)return{ok:!1,error:"No folder path provided"};let n=m.resolve(e).replace(/\//g,"\\");if(!n||n.length<3)return{ok:!1,error:`Invalid path format: ${e}`};let o=n.length>=3&&n[1]===":"?n.slice(3):n;if(/[<>:"|?*]/.test(o))return{ok:!1,error:`Path contains invalid characters: ${n}`};let h=nt.userInfo().username,l=m.join(process.resourcesPath,"elevate.exe"),d=y.existsSync(l);try{y.mkdirSync(n,{recursive:!0})}catch{}let u=[{exe:"icacls",args:[n,"/grant",`${h}:F`,"/t","/q"],desc:`Grant permissions to current user (${h})`},{exe:"icacls",args:[n,"/grant","Everyone:F","/t","/q"],desc:"Grant Everyone full permissions"},{exe:"icacls",args:[n,"/grant","Users:F","/t","/q"],desc:"Grant Users full permissions"}];for(let p=0;p<u.length;p++){let{exe:g,args:w,desc:f}=u[p];try{let x=await new Promise((S,k)=>{let i,A,C;d?(A=[l,["-wait",g,...w]],C={stdio:["ignore","pipe","pipe"],windowsHide:!0}):(A=[g,w],C={stdio:["ignore","pipe","pipe"],windowsHide:!0});try{i=ne(A[0],A[1],C)}catch(P){console.error("[Permission Fix] Spawn failed:",P),k(P);return}let b="",R="";i.stdout&&i.stdout.on("data",P=>{b+=P.toString()}),i.stderr&&i.stderr.on("data",P=>{R+=P.toString()}),i.on("exit",(P,$)=>{S({code:P,stdout:b,stderr:R,signal:$})}),i.on("error",P=>{k(P)}),setTimeout(()=>{try{i.kill()}catch{}k(new Error("Command timeout"))},3e4)});if(x.code!==0){let S=x.stderr||x.stdout||"Unknown error";if(!(S.includes("duplicate")||S.includes("already")||x.code===1332)){let i=`${f} failed (code ${x.code}): ${S}`;r.push(i)}}}catch(x){let S=`${f} error: ${x.message}`;r.push(S)}}try{let p=m.join(n,"test_write.tmp");y.writeFileSync(p,"test"),y.unlinkSync(p)}catch(p){let g=`Write test failed: ${p.message}`;r.push(g);try{if(y.mkdirSync(n,{recursive:!0}),(await new Promise(f=>{let x=ne("cmd",["/c",`icacls "${n}" /grant "%USERNAME%":F /q`],{stdio:"ignore",windowsHide:!0});x.on("exit",S=>f({code:S})),x.on("error",()=>f({code:1})),setTimeout(()=>{try{x.kill()}catch{}f({code:1})},5e3)})).code===0){let f=m.join(n,"test_write2.tmp");return y.writeFileSync(f,"test"),y.unlinkSync(f),{ok:!0,warnings:r}}}catch{}return{ok:!1,error:g,details:r}}return r.length>0?{ok:!0,warnings:r}:{ok:!0}}catch(n){let o=`Unexpected error: ${n?.message||n}`;return r.push(o),{ok:!1,error:o,details:r}}});v.on("window:minimize",()=>{E?.minimize()});v.on("window:maximize",()=>{E&&(E.isMaximized()?E.unmaximize():E.maximize())});v.on("window:close",()=>{E?.close()});T.on("before-quit",()=>{if(H)try{de(H)}catch{}});
