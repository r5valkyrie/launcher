import{app as b,BrowserWindow as zt,ipcMain as v,dialog as wt,protocol as Nt,shell as mt}from"electron";import{createRequire as te}from"node:module";import p from"node:path";import{fileURLToPath as ee,pathToFileURL as Pe}from"node:url";import Z from"node:https";import g from"node:fs";import re from"node:zlib";import{spawn as nt}from"node:child_process";import ne from"node:os";import P from"node:fs";import D from"node:path";import Wt from"node:crypto";import{pipeline as qt}from"node:stream";import{promisify as Ot}from"node:util";import lt from"node:https";var Ht=Ot(qt);function it(s){return String(s||"").replace(/\\/g,"/").replace(/^\/+/,"")}function Ct(s){return String(s||"").replace(/\\/g,"/").toLowerCase()}var K=new Map,At=new lt.Agent({keepAlive:!0,maxSockets:64,maxFreeSockets:32,keepAliveMsecs:6e4,scheduling:"fifo"}),ct=class{constructor(){this.maxBytesPerSecond=0,this.tokens=0,this.lastRefill=Date.now()}setMaxSpeed(e){this.maxBytesPerSecond=Math.max(0,e),this.tokens=this.maxBytesPerSecond}async consumeTokens(e){if(this.maxBytesPerSecond<=0)return;let r=Date.now(),t=(r-this.lastRefill)/1e3;if(this.tokens=Math.min(this.maxBytesPerSecond,this.tokens+t*this.maxBytesPerSecond),this.lastRefill=r,e>this.tokens){let o=(e-this.tokens)/this.maxBytesPerSecond*1e3;await I(o),this.tokens=0}else this.tokens-=e}},Dt=new ct;function bt(s){Dt.setMaxSpeed(s)}function H(s){return new Promise((e,r)=>{let t=Wt.createHash("sha256"),n=P.createReadStream(s);n.on("error",r),n.on("end",()=>e(t.digest("hex"))),n.on("data",o=>t.update(o))})}function Lt(s){P.mkdirSync(s,{recursive:!0})}function Jt(s){return new Promise((e,r)=>{let t=lt.get(s,{agent:At},n=>{if(n.statusCode!==200){r(new Error(`HTTP ${n.statusCode} for ${s}`)),n.resume();return}let o="";n.setEncoding("utf8"),n.on("data",a=>o+=a),n.on("end",()=>{try{e(JSON.parse(o))}catch(a){r(a)}})});t.on("error",r),t.setTimeout(3e4,()=>{t.destroy(),r(new Error("JSON fetch timeout"))})})}function I(s){return new Promise(e=>setTimeout(e,s))}function Tt(){return{cancelled:!1,requests:new Set}}function dt(s){if(s){s.cancelled=!0;for(let e of s.requests)try{e.destroy(new Error("cancelled"))}catch{}s.requests.clear()}}var Gt=new Set(["ECONNRESET","ETIMEDOUT","EAI_AGAIN","ECONNABORTED","ENETRESET","EHOSTUNREACH","ENETUNREACH","EPIPE","ENOTFOUND","ECONNREFUSED","EHOSTDOWN","ENETDOWN"]);async function J(s,e,r,t=1,n,o=0,a=0){return new Promise((i,u)=>{Lt(D.dirname(e));let l=P.createWriteStream(e,{flags:o>0?"a":"w"});if(n?.cancelled)return l.close(()=>{}),u(new Error("cancelled"));let d={agent:At};o>0&&(d.headers={Range:`bytes=${o}-`});let h=lt.get(s,d,c=>{if(c.statusCode!==200&&!(o>0&&c.statusCode===206)){if(l.close(()=>{}),o>0&&c.statusCode===200){try{P.unlinkSync(e)}catch{}let m=Math.min(2e3*t,1e4);c.resume();try{h.destroy(new Error("restart:range-ignored"))}catch{}return I(m).then(()=>i(J(s,e,r,t+1,n,0,a)))}if(P.unlink(e,()=>{}),c.statusCode&&[429,500,502,503,504].includes(c.statusCode)&&t<5){let m=Math.min(2e3*t,1e4);return c.resume(),I(m).then(()=>i(J(s,e,r,t+1,n,o,a)))}u(new Error(`HTTP ${c.statusCode} for ${s}`)),c.resume();return}let y=Number(c.headers["content-length"]||0),w=a>0?a:o>0?o+y:y,f=0,x=Date.now(),k=t<=2?3e4:45e3,E=setInterval(()=>{if(!n?.cancelled&&Date.now()-x>k)try{let m=new Error("stalled");m.code="ETIMEDOUT",h.destroy(m)}catch{}},1e4);c.on("data",async m=>{await Dt.consumeTokens(m.length),f+=m.length,x=Date.now(),r&&r(Math.min(o+f,w||o+f),w||0)}),c.on("aborted",async()=>{let m=new Promise(C=>l.close(()=>C()));try{clearInterval(E)}catch{}try{await m}catch{}if(t<5){let C=Math.min(2e3*t,1e4);return I(C).then(()=>i(J(s,e,r,t+1,n,o+f,a)))}u(new Error("response aborted"))}),Ht(c,l).then(()=>{try{clearInterval(E)}catch{}i()}).catch(m=>{try{clearInterval(E)}catch{}u(m)})});if(n?.requests.add(h),h.on("socket",c=>{try{c.setKeepAlive(!0,6e4),c.setNoDelay(!0),c.setRecvBufferSize&&c.setRecvBufferSize(64*1024),c.setSendBufferSize&&c.setSendBufferSize(64*1024)}catch{}}),h.on("close",()=>n?.requests.delete(h)),h.setTimeout(9e4,()=>{try{let c=new Error("Request timeout");c.code="ETIMEDOUT",h.destroy(c)}catch{}}),n?.cancelled)try{h.destroy(new Error("cancelled"))}catch{}h.on("error",async c=>{let y=c?.code,w=t<8&&y&&Gt.has(String(y)),f=new Promise(x=>{try{l.close(()=>x())}catch{x()}});try{await f}catch{}if(w){let x=Math.min(1e3*Math.pow(1.5,t),15e3),k=Math.random()*1e3,E=x+k,m=o;try{m=P.statSync(e).size}catch{}return I(E).then(()=>i(J(s,e,r,t+1,n,m,a)))}u(c)})})}async function Kt(s,e,r){try{let t=P.statSync(s);return r&&Number(r)>0&&t.size!==Number(r)?!1:(await H(s)).toLowerCase()===String(e).toLowerCase()}catch{return!1}}async function _t(s){let e=`${s.replace(/\/$/,"")}/checksums.json`;return Jt(e)}async function Xt(s,e,r,t,n=4,o){let a=it(e.path).split("/").join(D.sep),i=D.join(r,a);if(Lt(D.dirname(i)),await Kt(i,e.checksum,e.size))return t("progress:skip",{path:e.path}),{downloadComplete:!0,verificationComplete:!0,targetPath:i};if(o?.cancelled)throw new Error("cancelled");if(Array.isArray(e.parts)&&e.parts.length>0){let l=e.parts.length,d=new Array(l),h=0,c=new Set;async function y(){for(;;){let f=h++;if(f>=l)return;if(c.has(f))continue;c.add(f);let x=e.parts[f],k=it(x.path),E=`${s.replace(/\/$/,"")}/${k}`,m=`${i}.part${f}`;try{if(P.existsSync(m))if((await H(m)).toLowerCase()===String(x.checksum).toLowerCase()){t("progress:part",{path:e.path,part:f,totalParts:l,received:Number(x.size||0),total:Number(x.size||0)}),d[f]=m;continue}else try{P.unlinkSync(m)}catch{}}catch{}let C=0;for(;;){if(o?.cancelled)throw new Error("cancelled");C+=1;let A=0,L=0;try{let z=0;try{z=P.statSync(m).size}catch{}let N=Number(x.size||0);if(N>0&&z>N)try{P.unlinkSync(m),z=0}catch{}await J(E,m,(T,F)=>{let W=Math.max(0,T-L);L=T;try{W>0&&t("progress:bytes",{delta:W})}catch{}A+=W;let O=N||F||0;t("progress:part",{path:e.path,part:f,totalParts:l,received:Math.min(T,O||T),total:O})},1,o,z,N)}catch{try{P.unlinkSync(m)}catch{}try{A>0&&t("progress:bytes",{delta:-A})}catch{}try{t("progress:part:reset",{path:e.path,part:f,totalParts:l})}catch{}let N=Math.min(2e3*C,1e4);await I(N);continue}if((await H(m)).toLowerCase()===String(x.checksum).toLowerCase())break;try{P.unlinkSync(m)}catch{}try{A>0&&t("progress:bytes",{delta:-A})}catch{}try{t("progress:part:reset",{path:e.path,part:f,totalParts:l})}catch{}let _=Math.min(2e3*C,1e4);await I(_)}d[f]=m}}let w=Array.from({length:Math.max(1,n)},()=>y());return await Promise.all(w),{downloadComplete:!0,verificationComplete:!1,targetPath:i,mergeAndVerifyAsync:async()=>{t("progress:merge:start",{path:e.path,parts:d.length});let f=P.createWriteStream(i);for(let k=0;k<d.length;k++){let E=d[k];t("progress:merge:part",{path:e.path,part:k,totalParts:d.length}),await new Promise((m,C)=>{let A=P.createReadStream(E);A.on("error",C),f.on("error",C),A.on("end",()=>{try{P.unlinkSync(E)}catch{}m()}),A.pipe(f,{end:!1})})}await new Promise((k,E)=>{f.on("error",E),f.on("finish",k),f.end()});try{t("progress:merge:done",{path:e.path})}catch{}if(t("progress:verify",{path:e.path}),(await H(i)).toLowerCase()!==String(e.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${e.path}`);try{let k=P.readdirSync(D.dirname(i)),E=D.basename(i);k.forEach(m=>{if(m.startsWith(E+".part"))try{P.unlinkSync(D.join(D.dirname(i),m))}catch{}})}catch{}return{verificationComplete:!0,targetPath:i,filePath:e.path}}}}else{let l=it(e.path),d=`${s.replace(/\/$/,"")}/${l}`,h=0;for(;;){h+=1;let c=0,y=0,w=`${i}.download`,f=0;try{f=P.statSync(w).size}catch{}let x=Number(e.size||0);if(x>0&&f>x)try{P.unlinkSync(w),f=0}catch{}if(await J(d,w,(E,m)=>{let C=Math.max(0,E-y);y=E;try{C>0&&t("progress:bytes",{delta:C})}catch{}c+=C;let A=x||m||0;t("progress:file",{path:e.path,received:Math.min(E,A||E),total:A})},1,o,f,x),(await H(w)).toLowerCase()===String(e.checksum).toLowerCase())break;try{P.unlinkSync(w)}catch{}try{c>0&&t("progress:bytes",{delta:-c})}catch{}if(h>=2)throw new Error(`Checksum mismatch for ${e.path}`)}try{P.unlinkSync(i)}catch{}P.renameSync(`${i}.download`,i)}if(t("progress:verify",{path:e.path}),(await H(i)).toLowerCase()!==String(e.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${e.path}`);return{downloadComplete:!0,verificationComplete:!0,targetPath:i}}async function Mt(s,e,r,t,n=!1,o=4,a=4,i,u){let l=new Set,d=[];for(let E of e.files||[]){if(!(n||!E.optional))continue;let m=Ct(E.path);m&&(l.has(m)||(l.add(m),d.push(E)))}let h=d.filter(E=>!(Array.isArray(E.parts)&&E.parts.length>0)),c=d.filter(E=>Array.isArray(E.parts)&&E.parts.length>0),y=h.concat(c),w=y.length,f=0,x=y.reduce((E,m)=>{let C=Number(m.size||0);return C>0?E+C:Array.isArray(m.parts)&&m.parts.length?E+m.parts.reduce((A,L)=>A+Number(L.size||0),0):E},0);try{t("progress:bytes:total",{totalBytes:x})}catch{}async function k(E,m,C,A=!1){let L=0,R=[];async function _(){for(;;){for(;u&&u();)if(await I(100),i?.cancelled)return;let N=L++;if(N>=E.length)return;let T=E[N],F=m+N,W=Ct(T.path),O=async()=>Xt(s,T,r,t,a,i),xt=!1,tt=K.get(W);tt?xt=!0:(t("progress:start",{index:F,total:w,path:T.path,completed:f}),tt=(async()=>{try{let j=await O();if(A&&j?.mergeAndVerifyAsync){let vt=j.mergeAndVerifyAsync().then(M=>(M?.filePath&&(f+=1,t("progress:done",{index:F,total:w,path:M.filePath,completed:f})),M)).catch(M=>{if(String(M?.message||M||"error").includes("cancelled"))throw M;try{let U=D.join(r,T.path.replace(/\\/g,D.sep));try{P.unlinkSync(U)}catch{}try{let $=P.readdirSync(D.dirname(U)),B=D.basename(U);$.forEach(et=>{if(et.startsWith(B+".part"))try{P.unlinkSync(D.join(D.dirname(U),et))}catch{}})}catch{}return O().then($=>$.mergeAndVerifyAsync?$.mergeAndVerifyAsync().then(B=>(B?.filePath&&(f+=1,t("progress:done",{index:F,total:w,path:B.filePath,completed:f})),B)):$)}catch(U){try{t("progress:error",{path:T.path,message:String(U?.message||U)})}catch{}throw U}});return R.push(vt),{...j,skipProgressDone:!0}}return j}catch(j){if(String(j?.message||j||"error").includes("cancelled"))throw j;try{let M=D.join(r,T.path.replace(/\\/g,D.sep));try{P.unlinkSync(M)}catch{}let G=await O();if(A&&G?.mergeAndVerifyAsync){let U=G.mergeAndVerifyAsync().then($=>($?.filePath&&(f+=1,t("progress:done",{index:F,total:w,path:$.filePath,completed:f})),$)).catch($=>{try{let B=D.join(r,T.path.replace(/\\/g,D.sep)),et=P.readdirSync(D.dirname(B)),Ft=D.basename(B);et.forEach(Pt=>{if(Pt.startsWith(Ft+".part"))try{P.unlinkSync(D.join(D.dirname(B),Pt))}catch{}})}catch{}try{t("progress:error",{path:T.path,message:String($?.message||$)})}catch{}throw $});return R.push(U),{...G,skipProgressDone:!0}}return G}catch(M){try{t("progress:error",{path:T.path,message:String(M?.message||M)})}catch{}throw M}}})(),K.set(W,tt));let Et;try{Et=await tt}finally{xt||K.delete(W)}Et?.skipProgressDone||(f+=1,t("progress:done",{index:F,total:w,path:T.path,completed:f})),await I(10)}}let z=Array.from({length:Math.max(1,C)},()=>_());await Promise.all(z),R.length>0&&await Promise.all(R)}if(await k(h,0,Math.max(1,o)),K.size>0)try{await Promise.all([...K.values()])}catch{}await k(c,h.length,1,!0)}import ht from"node:fs";import Qt from"node:path";import{app as Yt}from"electron";var $t=Yt.getPath("userData"),Rt=Qt.join($t,"settings.json");function ut(){try{let s=ht.readFileSync(Rt,"utf-8");return JSON.parse(s)}catch{return{}}}function Zt(s){ht.mkdirSync($t,{recursive:!0}),ht.writeFileSync(Rt,JSON.stringify(s,null,2),"utf-8")}function ft(s,e=void 0){return ut()[s]??e}function rt(s,e){let r=ut();r[s]=e,Zt(r)}function X(){return ut()}var Bt=te(import.meta.url),{autoUpdater:V}=Bt("electron-updater"),Ut=Bt("electron-log"),se=ee(import.meta.url),Q=p.dirname(se);var S,q=null,pt=new Set,st=new Map,ot=new Map,yt="r5v",at=[];function It(s){try{return(s||[]).filter(e=>typeof e=="string"&&e.startsWith(`${yt}://`))}catch{return[]}}function St(s){try{let e=new URL(s);if(e.hostname==="mod"&&e.pathname==="/install"){let r=e.searchParams.get("name")||"",t=e.searchParams.get("version")||"",n=e.searchParams.get("downloadUrl")?.split(",")||"";if(S&&S.webContents&&!S.webContents.isLoading())try{S.webContents.send("deeplink:mod-install",{url:s,name:r,version:t,downloadUrls:n})}catch{}else at.push(s)}}catch{}}function oe(){for(;at.length;){let s=at.shift();St(s)}}var ae=b.requestSingleInstanceLock();ae?b.on("second-instance",(s,e)=>{try{It(e).forEach(t=>St(t)),S&&(S.isMinimized()&&S.restore(),S.focus())}catch{}}):b.quit();b.on("open-url",(s,e)=>{s.preventDefault(),St(e)});async function Vt(){let s=ft("windowState",{width:1150,height:800,x:void 0,y:void 0,isMaximized:!1});S=new zt({width:s.width,height:s.height,x:s.x,y:s.y,minWidth:1150,minHeight:800,frame:!1,titleBarStyle:"hidden",webPreferences:{preload:p.join(Q,"preload.cjs"),contextIsolation:!0,nodeIntegration:!1},show:!1,icon:p.join(Q,"..","public","icon.png")});let e=process.env.VITE_DEV_SERVER_URL;if(e)await S.loadURL(e);else{let a=p.join(Q,"..","dist","index.html");await S.loadFile(a)}S.webContents.setWindowOpenHandler(({url:a})=>{try{mt.openExternal(a)}catch{}return{action:"deny"}}),S.webContents.on("will-navigate",(a,i)=>{let u=i.startsWith("file:"),l=!!process.env.VITE_DEV_SERVER_URL&&i.startsWith(String(process.env.VITE_DEV_SERVER_URL));if(!u&&!l){a.preventDefault();try{mt.openExternal(i)}catch{}}});let r=()=>{S&&(S.isVisible()||S.show(),S.isFocused()||S.focus())};s.isMaximized&&S.maximize(),S.once("ready-to-show",r),S.webContents.once("did-finish-load",r);let t=setTimeout(r,1e3);S.on("show",()=>clearTimeout(t));function n(){if(!S)return;let a=S.getBounds(),i=S.isMaximized();rt("windowState",{width:a.width,height:a.height,x:a.x,y:a.y,isMaximized:i})}S.on("resize",n),S.on("move",n),S.on("maximize",n),S.on("unmaximize",n),(!!process.env.VITE_DEV_SERVER_URL||process.env.NODE_ENV==="development")&&S.webContents.openDevTools({mode:"detach"}),S.webContents.on("did-fail-load",(a,i,u,l)=>{console.error("Load failed",{errorCode:i,errorDesc:u,validatedURL:l}),wt.showErrorBox("Load failed",`${u} (code ${i})
URL: ${l}`),S.show()})}b.on("window-all-closed",()=>{process.platform!=="darwin"&&b.quit()});b.whenReady().then(()=>{try{process.defaultApp&&process.platform==="win32"?b.setAsDefaultProtocolClient(yt,process.execPath,[process.argv[1]]):b.setAsDefaultProtocolClient(yt)}catch{}let s=p.resolve(b.getAppPath(),".."),e=p.join(s,"cache");Nt.registerFileProtocol("r5v",(t,n)=>{try{let o=new URL(t.url),a=decodeURIComponent(o.pathname).replace(/^\//,""),i=p.normalize(p.join(e,a));n({path:i})}catch{n({error:-6})}});let r=p.join(Q,"..","dist");Nt.interceptFileProtocol("file",(t,n)=>{try{let o=new URL(t.url),a=decodeURIComponent(o.pathname),i=a.replace(/\\/g,"/"),u=i.indexOf("/_astro/");if(u!==-1){let l=i.substring(u+8),d=p.join(r,"_astro",l);return n({path:d})}if(i.endsWith("/favicon.svg")||/\/favicon\.svg$/i.test(i)){let l=p.join(r,"favicon.svg");return n({path:l})}if(i.startsWith("/")){let l=i.replace(/^\/+/,""),d=p.join(r,l);try{return g.accessSync(d),n({path:d})}catch{}}return n({path:a})}catch{return n({error:-6})}}),Vt();try{It(process.argv).forEach(t=>at.push(t))}catch{}try{S?.webContents?.once("did-finish-load",oe)}catch{}try{V.autoDownload=!1;try{V.logger=Ut,Ut.transports.file.level="info"}catch{}V.on("error",t=>{try{S?.webContents.send("update:error",{message:String(t?.stack||t?.message||t)})}catch{}}),V.on("update-available",t=>{try{S?.webContents.send("update:available",t)}catch{}}),V.on("update-not-available",t=>{try{S?.webContents.send("update:not-available",t)}catch{}}),V.on("download-progress",t=>{try{S?.webContents.send("update:download-progress",t)}catch{}}),V.on("update-downloaded",t=>{try{S?.webContents.send("update:downloaded",t)}catch{}})}catch{}b.on("activate",()=>{zt.getAllWindows().length===0&&Vt()})});v.handle("update:check",async()=>{try{return{ok:!0,result:(await V.checkForUpdates())?.updateInfo||null}}catch(s){return{ok:!1,error:String(s?.message||s)}}});v.handle("update:download",async()=>{try{return await V.downloadUpdate(),{ok:!0}}catch(s){return{ok:!1,error:String(s?.message||s)}}});v.handle("update:quitAndInstall",async()=>{try{return setImmediate(()=>V.quitAndInstall(!1,!0)),{ok:!0}}catch(s){return{ok:!1,error:String(s?.message||s)}}});v.handle("app:getVersion",async()=>{try{return b.getVersion()}catch{return"0.0.0"}});v.handle("app:getBaseDir",async()=>{try{return p.resolve(b.getAppPath(),"..")}catch{return""}});v.handle("app:getLauncherInstallRoot",async()=>{try{let s=process.env.LOCALAPPDATA||p.join(b.getPath("home"),"AppData","Local");return p.join(s,"Programs","r5vlauncher")}catch{return""}});function ie(s){try{let e=p.join(s,"mods.vdf"),r=g.readFileSync(e,"utf-8"),t={},n=/"([^"]+)"\s*"([01])"/g,o;for(;o=n.exec(r);){let a=o[1];a&&a!=="ModList"&&(t[a]=o[2]==="1")}return t}catch{return{}}}function kt(s){try{let e=p.join(s,"mods.vdf"),r=g.readFileSync(e,"utf-8"),t={},n=[],o=/"([^"]+)"\s*"([01])"/g,a;for(;a=o.exec(r);){let i=a[1];!i||i==="ModList"||(i in t||n.push(i),t[i]=a[2]==="1")}return{map:t,order:n}}catch{return{map:{},order:[]}}}function gt(s){try{let e=g.readFileSync(s,"utf-8"),r=e.match(/"id"\s*"([^"]+)"/i),t=e.match(/"name"\s*"([^"]+)"/i),n=r?r[1]:null,o=t?t[1]:null;return{id:n,name:o}}catch{return{id:null,name:null}}}function ce(s,e){let r=['"ModList"',"{"];for(let[t,n]of Object.entries(e))r.push(`	"${t}"		"${n?"1":"0"}"`);r.push("}"),g.mkdirSync(s,{recursive:!0}),g.writeFileSync(p.join(s,"mods.vdf"),r.join(`
`),"utf-8")}function jt(s,e,r){let t=new Set,n=['"ModList"',"{"],o=a=>{n.push(`	"${a}"		"${r[a]?"1":"0"}"`),t.add(a)};for(let a of Array.isArray(e)?e:[])Object.prototype.hasOwnProperty.call(r,a)&&!t.has(a)&&o(a);for(let a of Object.keys(r))t.has(a)||o(a);n.push("}"),g.mkdirSync(s,{recursive:!0}),g.writeFileSync(p.join(s,"mods.vdf"),n.join(`
`),"utf-8")}v.handle("mods:listInstalled",async(s,{installDir:e})=>{try{let r=p.join(e,"mods"),{map:t,order:n}=kt(r),o=[],a=g.existsSync(r)?g.readdirSync(r,{withFileTypes:!0}):[];for(let u of a){if(!u.isDirectory())continue;let l=p.join(r,u.name),d=p.join(l,"manifest.json"),h=p.join(l,"mod.vdf"),c=p.join(l,"icon.png"),y=null;try{y=JSON.parse(g.readFileSync(d,"utf-8"))}catch{}let w=gt(h),f=w.id||y?.name||u.name,x=null;try{x=`data:image/png;base64,${g.readFileSync(c).toString("base64")}`}catch{}o.push({id:f,name:y?.name||w.name||u.name,folder:u.name,version:y?.version_number||null,description:y?.description||"",enabled:f?!!t[f]:!1,hasManifest:g.existsSync(d),iconDataUrl:x})}let i=new Map(n.map((u,l)=>[u,l]));return o.sort((u,l)=>{let d=u.id!=null&&i.has(u.id)?i.get(u.id):Number.MAX_SAFE_INTEGER,h=l.id!=null&&i.has(l.id)?i.get(l.id):Number.MAX_SAFE_INTEGER;return d!==h?d-h:String(u.name||"").localeCompare(String(l.name||""))}),{ok:!0,mods:o}}catch(r){return{ok:!1,error:String(r?.message||r)}}});v.handle("mods:setEnabled",async(s,{installDir:e,name:r,enabled:t})=>{try{let n=p.join(e,"mods"),{map:o}=kt(n);return o[r]=!!t,jt(n,void 0,o),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});v.handle("mods:reorder",async(s,{installDir:e,orderIds:r})=>{try{let t=p.join(e,"mods"),{map:n,order:o}=kt(t),a=Array.isArray(r)?r.filter(d=>typeof d=="string"&&d&&Object.prototype.hasOwnProperty.call(n,d)):[],i=new Set(a),u=o.filter(d=>Object.prototype.hasOwnProperty.call(n,d)&&!i.has(d)),l=[...a,...u];return jt(t,l,n),{ok:!0}}catch(t){return{ok:!1,error:String(t?.message||t)}}});v.handle("mods:uninstall",async(s,{installDir:e,folder:r})=>{try{let t=p.join(e,"mods"),n=p.join(t,r);return g.rmSync(n,{recursive:!0,force:!0}),{ok:!0}}catch(t){return{ok:!1,error:String(t?.message||t)}}});v.handle("mods:fetchAll",async(s,{query:e})=>{let r="https://thunderstore.io/c/r5valkyrie/api/v1/package-listing-index/",t=o=>new Promise((a,i)=>{Z.get(o,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"*/*"}},l=>{if(l.statusCode&&l.statusCode>=300&&l.statusCode<400&&l.headers.location){l.resume();let h=l.headers.location.startsWith("http")?l.headers.location:new URL(l.headers.location,o).toString();return a(t(h))}if(l.statusCode!==200)return l.resume(),i(new Error(`HTTP ${l.statusCode}`));let d=[];l.on("data",h=>d.push(Buffer.isBuffer(h)?h:Buffer.from(h))),l.on("end",()=>a(Buffer.concat(d)))}).on("error",i)}),n=o=>{try{return re.gunzipSync(o)}catch{return o}};try{let o=await t(r),a=JSON.parse(n(o).toString("utf8")),i=Array.isArray(a)?a:[],u=6,l=[],d=0;await Promise.all(Array.from({length:u}).map(async()=>{for(;d<i.length;){let c=d++,y=i[c];try{let w=await t(y),f=n(w).toString("utf8"),x=JSON.parse(f);Array.isArray(x)&&l.push(...x)}catch{}}}));let h=l;if(e&&String(e).trim()){let c=String(e).toLowerCase();h=h.filter(y=>String(y?.name||"").toLowerCase().includes(c)||String(y?.full_name||"").toLowerCase().includes(c))}return{ok:!0,mods:h}}catch(o){try{let i=await t("https://thunderstore.io/c/r5valkyrie/api/v1/package/"),u=JSON.parse(i.toString("utf8")),l=Array.isArray(u)?u:[];if(e&&String(e).trim()){let d=String(e).toLowerCase();l=l.filter(h=>String(h?.name||"").toLowerCase().includes(d)||String(h?.full_name||"").toLowerCase().includes(d))}return{ok:!0,mods:l}}catch(a){return{ok:!1,error:String(a?.message||o?.message||a||o)}}}});v.handle("mods:install",async(s,{installDir:e,name:r,downloadUrl:t})=>{if(!t.startsWith("https://thunderstore.io"))return{ok:!1,error:"Download URL does not point to Thunderstore"};try{let n=String(r||"").trim();if(!n)return{ok:!1,error:"Invalid mod name"};if(pt.has(n))return{ok:!0};pt.add(n);let o=p.join(e,"mods");g.mkdirSync(o,{recursive:!0});let a=p.join(o,`.__mod_${Date.now()}.zip`),i=(h,c=0)=>new Promise((y,w)=>{if(c>5)return w(new Error("Too many redirects"));let f=g.createWriteStream(a);Z.get(h,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"application/octet-stream,*/*;q=0.8",Referer:"https://thunderstore.io/",Connection:"keep-alive"}},k=>{if(k.statusCode&&k.statusCode>=300&&k.statusCode<400&&k.headers.location){k.resume(),f.close(()=>{});try{g.unlinkSync(a)}catch{}let L=k.headers.location.startsWith("http")?k.headers.location:new URL(k.headers.location,h).toString();return y(i(L,c+1))}if(k.statusCode!==200){f.close(()=>{});try{g.unlinkSync(a)}catch{}return k.resume(),w(new Error(`HTTP ${k.statusCode}`))}let E=Number(k.headers["content-length"]||0),m=0,C=Date.now(),A=L=>{try{s?.sender?.send("mods:progress",{key:r,phase:L,received:m,total:E})}catch{}};k.on("data",L=>{m+=Buffer.isBuffer(L)?L.length:Buffer.byteLength(String(L));let R=Date.now();R-C>150&&(C=R,A("downloading"))}),k.pipe(f),f.on("finish",()=>{A("downloading"),f.close(y)})}).on("error",k=>{try{g.unlinkSync(a)}catch{}w(k)})});await i(t);try{s?.sender?.send("mods:progress",{key:r,phase:"extracting"})}catch{}let u=p.join(o,r);try{g.rmSync(u,{recursive:!0,force:!0})}catch{}g.mkdirSync(u,{recursive:!0}),await new Promise((h,c)=>{let y=nt("powershell.exe",["-NoProfile","-NonInteractive","-Command",`Expand-Archive -LiteralPath "${a}" -DestinationPath "${u}" -Force`],{stdio:"ignore"});y.on("exit",w=>w===0?h():c(new Error(`Expand-Archive failed ${w}`))),y.on("error",c)});try{g.unlinkSync(a)}catch{}let l=null;try{let h=p.join(u,"mod.vdf");if(g.existsSync(h))l=gt(h).id;else{let c=g.readdirSync(u,{withFileTypes:!0});for(let y of c)if(y.isDirectory()){let w=p.join(u,y.name,"mod.vdf");if(g.existsSync(w)&&(l=gt(w).id,l))break}}}catch{}let d=ie(o);d[l||r]=!0,ce(o,d);try{s?.sender?.send("mods:progress",{key:r,phase:"done"})}catch{}return{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}finally{try{pt.delete(String(r||""))}catch{}}});v.handle("mods:watch",async(s,{installDir:e})=>{try{let r=p.join(e,"mods");if(!g.existsSync(r))return{ok:!0};let t=r;if(st.has(t))return{ok:!0};let n=g.watch(r,{persistent:!0},(o,a)=>{let i=t;clearTimeout(ot.get(i));let u=setTimeout(()=>{try{S?.webContents?.send("mods:changed",{installDir:e})}catch{}},300);ot.set(i,u)});return st.set(t,n),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});v.handle("mods:unwatch",async(s,{installDir:e})=>{try{let t=p.join(e,"mods"),n=st.get(t);if(n){try{n.close()}catch{}st.delete(t)}let o=ot.get(t);return o&&(clearTimeout(o),ot.delete(t)),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});v.handle("mods:iconDataUrl",async(s,{installDir:e,folder:r})=>{try{let t=p.join(e,"mods",r,"icon.png");return await g.promises.access(t),{ok:!0,dataUrl:`data:image/png;base64,${(await g.promises.readFile(t)).toString("base64")}`}}catch(t){return{ok:!1,error:String(t?.message||t)}}});v.handle("select-directory",async()=>{let s=await wt.showOpenDialog({properties:["openDirectory","createDirectory"]});return s.canceled||s.filePaths.length===0?null:s.filePaths[0]});v.handle("settings:get",()=>X());v.handle("settings:set",(s,{key:e,value:r})=>rt(e,r));v.handle("download:checksums",async(s,{baseUrl:e})=>_t(e));v.handle("download:all",async(s,{baseUrl:e,checksums:r,installDir:t,includeOptional:n,concurrency:o,partConcurrency:a,channelName:i,mode:u})=>{let l=(d,h)=>s.sender.send(d,h);try{if(!(String(u||"install").toLowerCase()==="install")){let h=p.join(t,"mods","mods.vdf");if(g.existsSync(h)){let y=(Array.isArray(r?.files)?r.files:[]).filter(w=>{try{return String(w?.path||w?.name||"").replace(/\\/g,"/").toLowerCase()!=="mods/mods.vdf"}catch{return!0}});r={...r||{},files:y}}}}catch{}q=Tt(),Y=!1;try{await Mt(e,r,t,l,!!n,Number(o)||4,Number(a)||4,q,()=>Y);try{let d=ft("channels",{})||{};d[String(i||"default")]={installDir:t,gameVersion:r?.game_version||null,gameBaseUrl:e,lastUpdatedAt:Date.now()},rt("channels",d)}catch(d){console.error("Failed to persist channel info",d)}}finally{q=null}return!0});v.handle("default-install-dir",(s,{channelName:e})=>{let t=X()?.customBaseDir,n;if(t&&typeof t=="string"&&t.trim())n=t;else{let o=process.env.LOCALAPPDATA||p.join(b.getPath("home"),"AppData","Local");n=p.join(o,"Programs","R5VLibrary")}return e?p.join(n,e):n});v.handle("scan-custom-channels",async(s,{officialChannelNames:e,channelsSettings:r})=>{try{let t=[],n=new Set((e||[]).map(d=>d.toLowerCase())),o=new Set,a=async d=>{try{return await g.promises.access(p.join(d,"r5apex.exe")),!0}catch{try{return await g.promises.access(p.join(d,"r5apex_ds.exe")),!0}catch{return!1}}},u=X()?.customBaseDir,l;if(u&&typeof u=="string"&&u.trim())l=u;else{let d=process.env.LOCALAPPDATA||p.join(b.getPath("home"),"AppData","Local");l=p.join(d,"Programs","R5VLibrary")}try{await g.promises.access(l);let d=await g.promises.readdir(l,{withFileTypes:!0});for(let h of d){if(!h.isDirectory())continue;let c=h.name,y=p.join(l,c),w=y.toLowerCase();o.has(w)||n.has(c.toLowerCase())||await a(y)&&(t.push({name:c,installDir:y,isCustom:!0}),o.add(w))}}catch{}if(r&&typeof r=="object")for(let[d,h]of Object.entries(r)){if(!h||typeof h!="object")continue;let c=h.installDir;if(!c||typeof c!="string")continue;let y=c.toLowerCase();if(!o.has(y)&&await a(c)){let w=p.basename(c);n.has(w.toLowerCase())||(t.push({name:w,installDir:c,isCustom:!0}),o.add(y))}}if(r&&typeof r=="object"){let d=new Set;for(let h of Object.values(r))if(h&&typeof h=="object"&&h.installDir){let c=p.dirname(h.installDir);d.add(c)}for(let h of d)try{let c=await g.promises.readdir(h,{withFileTypes:!0});for(let y of c){if(!y.isDirectory())continue;let w=y.name,f=p.join(h,w),x=f.toLowerCase();o.has(x)||n.has(w.toLowerCase())||await a(f)&&(t.push({name:w,installDir:f,isCustom:!0}),o.add(x))}}catch{}}return t}catch(t){return console.error("Error scanning for custom channels:",t),[]}});v.handle("open-folder",async(s,{folderPath:e})=>{try{if(!e)return{ok:!1,error:"No folder path provided"};try{await g.promises.access(e)}catch{return{ok:!1,error:"Folder does not exist"}}return await mt.openPath(e),{ok:!0}}catch(r){return console.error("Error opening folder:",r),{ok:!1,error:String(r)}}});v.handle("set-download-speed-limit",async(s,{bytesPerSecond:e})=>{try{let r=Number(e)||0;return bt(r),{ok:!0}}catch(r){return console.error("Error setting download speed limit:",r),{ok:!1,error:String(r)}}});v.handle("launcher:config",async(s,{url:e})=>(t=>new Promise((n,o)=>{Z.get(t,a=>{if(a.statusCode!==200){o(new Error(`HTTP ${a.statusCode} for ${t}`)),a.resume();return}let i="";a.setEncoding("utf8"),a.on("data",u=>i+=u),a.on("end",()=>{try{n(JSON.parse(i))}catch(u){o(u)}})}).on("error",o)}))(e));v.handle("eula:get",async()=>{let s="https://playvalkyrie.org/api/eula",e=r=>new Promise((t,n)=>{Z.get(r,o=>{if(o.statusCode!==200){n(new Error(`HTTP ${o.statusCode}`)),o.resume();return}let a=[];o.on("data",i=>a.push(Buffer.isBuffer(i)?i:Buffer.from(i))),o.on("end",()=>{try{let i=Buffer.concat(a).toString("utf8");t(JSON.parse(i))}catch(i){n(i)}})}).on("error",n)});try{return{ok:!0,json:await e(s)}}catch(r){return{ok:!1,error:String(r?.message||r)}}});v.handle("video:cache",async(s,{filename:e})=>{try{let t=`https://blaze.playvalkyrie.org/video_backgrounds/${e}`,n=p.join(p.resolve(b.getAppPath(),".."),"cache"),o=p.join(n,"videos"),a=p.join(o,e),i=p.join(Q,"..","dist"),u=p.join(i,e);await g.promises.mkdir(o,{recursive:!0});try{if((await g.promises.stat(a)).size>0){try{await g.promises.access(u)}catch{await g.promises.copyFile(a,u)}return`./${e}`}else await g.promises.unlink(a)}catch{}return await new Promise((l,d)=>{let h=g.createWriteStream(a),c=Z.get(t,y=>{if(y.statusCode!==200){h.close(()=>{}),g.unlink(a,()=>{}),d(new Error(`HTTP ${y.statusCode} for video ${e}`)),y.resume();return}y.pipe(h),h.on("finish",()=>h.close(l)),h.on("error",w=>{g.unlink(a,()=>d(w))})});c.on("error",y=>{h.close(()=>{}),g.unlink(a,()=>{}),d(y)}),c.setTimeout(3e4,()=>{c.destroy(),h.close(()=>{}),g.unlink(a,()=>{}),d(new Error(`Video download timeout for ${e}`))})}),await g.promises.copyFile(a,u),`./${e}`}catch(r){throw console.error(`Video cache error for ${e}:`,r),r}});v.handle("fs:is-installed-in-dir",async(s,{path:e})=>{let r=!1,t=!1;try{await g.promises.access(p.join(e,"r5apex.exe")),r=!0}catch{}try{await g.promises.access(p.join(e,"r5apex_ds.exe")),t=!0}catch{}return r||t});var Y=!1;v.handle("download:pause",async()=>{Y=!0;try{S?.webContents.send("progress:paused",{})}catch{}return!0});v.handle("download:resume",async()=>{Y=!1;try{S?.webContents.send("progress:resumed",{})}catch{}return!0});v.handle("download:cancel",async()=>{try{dt(q)}catch{}q=null,Y=!1;try{S?.webContents.send("progress:cancelled",{})}catch{}return!0});v.handle("select-file",async(s,{filters:e})=>{let r=await wt.showOpenDialog({properties:["openFile"],filters:Array.isArray(e)?e:void 0});return r.canceled||r.filePaths.length===0?null:r.filePaths[0]});v.handle("game:launch",async(s,{channelName:e,installDir:r,mode:t,argsString:n})=>{try{if(!r)throw new Error("Missing installDir");let o=String(t).toUpperCase()==="SERVER"?"r5apex_ds.exe":"r5apex.exe",a=p.join(r,o);await g.promises.access(a).catch(()=>{throw new Error(`Executable not found: ${a}`)});let u=(d=>!d||typeof d!="string"?[]:(d.match(/(?:[^\s\"]+|\"[^\"]*\")+/g)||[]).map(c=>c.replace(/^\"|\"$/g,"")))(n);return nt(a,u,{cwd:r,detached:!0,stdio:"ignore",env:{...process.env}}).unref(),{ok:!0}}catch(o){return{ok:!1,error:String(o?.message||o)}}});v.handle("fix-folder-permissions",async(s,{selectedChannel:e})=>{let r=[],t=X().channels[e].installDir;try{if(!t)return{ok:!1,error:"No folder path provided"};let n=p.resolve(t).replace(/\//g,"\\");if(!n||n.length<3)return{ok:!1,error:`Invalid path format: ${t}`};let o=n.length>=3&&n[1]===":"?n.slice(3):n;if(/[<>:"|?*]/.test(o))return{ok:!1,error:`Path contains invalid characters: ${n}`};let u=ne.userInfo().username,l=p.join(process.resourcesPath,"elevate.exe"),d=g.existsSync(l);try{g.mkdirSync(n,{recursive:!0})}catch{}let h=[{exe:"icacls",args:[n,"/grant",`${u}:F`,"/t","/q"],desc:`Grant permissions to current user (${u})`},{exe:"icacls",args:[n,"/grant","Everyone:F","/t","/q"],desc:"Grant Everyone full permissions"},{exe:"icacls",args:[n,"/grant","Users:F","/t","/q"],desc:"Grant Users full permissions"}];for(let c=0;c<h.length;c++){let{exe:y,args:w,desc:f}=h[c];try{let x=await new Promise((k,E)=>{let m,C,A;d?(C=[l,["-wait",y,...w]],A={stdio:["ignore","pipe","pipe"],windowsHide:!0}):(C=[y,w],A={stdio:["ignore","pipe","pipe"],windowsHide:!0});try{m=nt(C[0],C[1],A)}catch(_){console.error("[Permission Fix] Spawn failed:",_),E(_);return}let L="",R="";m.stdout&&m.stdout.on("data",_=>{L+=_.toString()}),m.stderr&&m.stderr.on("data",_=>{R+=_.toString()}),m.on("exit",(_,z)=>{k({code:_,stdout:L,stderr:R,signal:z})}),m.on("error",_=>{E(_)}),setTimeout(()=>{try{m.kill()}catch{}E(new Error("Command timeout"))},3e4)});if(x.code!==0){let k=x.stderr||x.stdout||"Unknown error";if(!(k.includes("duplicate")||k.includes("already")||x.code===1332)){let m=`${f} failed (code ${x.code}): ${k}`;r.push(m)}}}catch(x){let k=`${f} error: ${x.message}`;r.push(k)}}try{let c=p.join(n,"test_write.tmp");g.writeFileSync(c,"test"),g.unlinkSync(c)}catch(c){let y=`Write test failed: ${c.message}`;r.push(y);try{if(g.mkdirSync(n,{recursive:!0}),(await new Promise(f=>{let x=nt("cmd",["/c",`icacls "${n}" /grant "%USERNAME%":F /q`],{stdio:"ignore",windowsHide:!0});x.on("exit",k=>f({code:k})),x.on("error",()=>f({code:1})),setTimeout(()=>{try{x.kill()}catch{}f({code:1})},5e3)})).code===0){let f=p.join(n,"test_write2.tmp");return g.writeFileSync(f,"test"),g.unlinkSync(f),{ok:!0,warnings:r}}}catch{}return{ok:!1,error:y,details:r}}return r.length>0?{ok:!0,warnings:r}:{ok:!0}}catch(n){let o=`Unexpected error: ${n?.message||n}`;return r.push(o),{ok:!1,error:o,details:r}}});v.on("window:minimize",()=>{S?.minimize()});v.on("window:maximize",()=>{S&&(S.isMaximized()?S.unmaximize():S.maximize())});v.on("window:close",()=>{S?.close()});b.on("before-quit",()=>{if(q)try{dt(q)}catch{}});
