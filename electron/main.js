import{app as _,BrowserWindow as ze,ipcMain as C,dialog as Se,protocol as Ue,shell as ye}from"electron";import{createRequire as tt}from"node:module";import p from"node:path";import{fileURLToPath as rt,pathToFileURL as Ct}from"node:url";import Q from"node:https";import y from"node:fs";import nt from"node:zlib";import{spawn as ne}from"node:child_process";import st from"node:os";import D from"node:fs";import L from"node:path";import Fe from"node:crypto";import{pipeline as He}from"node:stream";import{promisify as qe}from"node:util";import de from"node:https";var Oe=qe(He);function ce(o){return String(o||"").replace(/\\/g,"/").replace(/^\/+/,"")}function Ae(o){return String(o||"").replace(/\\/g,"/").toLowerCase()}var G=new Map,De=new de.Agent({keepAlive:!0,maxSockets:64,maxFreeSockets:32,keepAliveMsecs:6e4,scheduling:"fifo"}),Je={"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"application/octet-stream, */*;q=0.8","Accept-Encoding":"identity",Connection:"keep-alive","Cache-Control":"no-transform"},le=class{constructor(){this.maxBytesPerSecond=0,this.tokens=0,this.lastRefill=Date.now()}setMaxSpeed(t){this.maxBytesPerSecond=Math.max(0,t),this.tokens=this.maxBytesPerSecond}async consumeTokens(t){if(this.maxBytesPerSecond<=0)return;let r=Date.now(),e=(r-this.lastRefill)/1e3;if(this.tokens=Math.min(this.maxBytesPerSecond,this.tokens+e*this.maxBytesPerSecond),this.lastRefill=r,t>this.tokens){let s=(t-this.tokens)/this.maxBytesPerSecond*1e3;await W(s),this.tokens=0}else this.tokens-=t}},be=new le;function Le(o){be.setMaxSpeed(o)}function O(o){return new Promise((t,r)=>{let e=Fe.createHash("sha256"),n=D.createReadStream(o);n.on("error",r),n.on("end",()=>t(e.digest("hex"))),n.on("data",s=>e.update(s))})}function Te(o){try{D.mkdirSync(o,{recursive:!0})}catch(t){if(t?.code==="ENOENT"){let e=o.split(L.sep).filter(Boolean),n="";for(let s of e){n=n?L.join(n,s):s.includes(":")?s+L.sep:s;try{D.accessSync(n)}catch{throw new Error(`Cannot create directory: parent path "${n}" does not exist or is not accessible. Please ensure the drive is available and you have write permissions.`)}}}throw t}}function Ge(o){return new Promise((t,r)=>{let e={agent:De,headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"application/json","Accept-Encoding":"identity",Connection:"keep-alive"}},n=de.get(o,e,s=>{if(s.statusCode!==200){r(new Error(`HTTP ${s.statusCode} for ${o}`)),s.resume();return}let a="";s.setEncoding("utf8"),s.on("data",i=>a+=i),s.on("end",()=>{try{t(JSON.parse(a))}catch(i){r(i)}})});n.on("error",r),n.setTimeout(3e4,()=>{n.destroy(),r(new Error("JSON fetch timeout"))})})}function W(o){return new Promise(t=>setTimeout(t,o))}function Re(){return{cancelled:!1,requests:new Set}}function he(o){if(o){o.cancelled=!0;for(let t of o.requests)try{t.destroy(new Error("cancelled"))}catch{}o.requests.clear()}}var Ke=new Set(["ECONNRESET","ETIMEDOUT","EAI_AGAIN","ECONNABORTED","ENETRESET","EHOSTUNREACH","ENETUNREACH","EPIPE","ENOTFOUND","ECONNREFUSED","EHOSTDOWN","ENETDOWN","EPERM","EBUSY","EACCES"]);async function te(o,t,r,e=1,n,s=0,a=0){return new Promise((i,h)=>{Te(L.dirname(t));let d;try{d=D.createWriteStream(t,{flags:s>0?"a":"w"})}catch(c){if(e<8&&(c.code==="EPERM"||c.code==="EBUSY"||c.code==="EACCES")){let E=Math.min(1e3*e,5e3);return W(E).then(()=>i(te(o,t,r,e+1,n,s,a)))}return h(c)}if(n?.cancelled)return d.close(()=>{}),h(new Error("cancelled"));let l=!1,u=c=>{l||(l=!0,i(c))},m=c=>{l||(l=!0,h(c))},w={agent:De,headers:{...Je}};s>0&&(w.headers.Range=`bytes=${s}-`);let g=0,f=null,x=()=>new Promise(c=>{try{d.close(()=>c())}catch{c()}}),v=async(c,E=!1)=>{try{f&&clearInterval(f)}catch{}try{await x()}catch{}if(await W(100),E)try{D.unlinkSync(t)}catch{}if(e<8){let A=Math.min(1e3*Math.pow(1.5,e),15e3),b=Math.random()*1e3,R=A+b;return await W(R),u(te(o,t,r,e+1,n,c,a)),!0}return!1},S=de.get(o,w,c=>{if(c.statusCode!==200&&!(s>0&&c.statusCode===206)){if(l=!0,s>0&&c.statusCode===200){c.resume(),v(0,!0).then(P=>{P||h(new Error(`HTTP ${c.statusCode} for ${o}`))});return}if(s>0&&c.statusCode===416){c.resume(),v(0,!0).then(P=>{P||h(new Error(`HTTP ${c.statusCode} for ${o}`))});return}if(c.statusCode&&[429,500,502,503,504].includes(c.statusCode)&&e<5){c.resume(),v(s,!1).then(P=>{P||h(new Error(`HTTP ${c.statusCode} for ${o}`))});return}x().then(()=>{D.unlink(t,()=>{}),h(new Error(`HTTP ${c.statusCode} for ${o}`))}),c.resume();return}let E=Number(c.headers["content-length"]||0),A=a>0?a:s>0?s+E:E,b=Date.now(),R=e<=2?3e4:45e3;f=setInterval(()=>{if(!n?.cancelled&&Date.now()-b>R)try{let P=new Error("stalled");P.code="ETIMEDOUT",S.destroy(P)}catch{}},1e4),c.on("data",async P=>{await be.consumeTokens(P.length),g+=P.length,b=Date.now(),r&&r(Math.min(s+g,A||s+g),A||0)}),c.on("aborted",async()=>{await v(s+g)||m(new Error("response aborted"))}),Oe(c,d).then(()=>{try{f&&clearInterval(f)}catch{}u()}).catch(async P=>{try{f&&clearInterval(f)}catch{}let $=String(P?.message||P||"").toLowerCase();($.includes("aborted")||$.includes("socket")||$.includes("closed"))&&await v(s+g)||m(P)})});if(n?.requests.add(S),S.on("socket",c=>{try{c.setKeepAlive(!0,6e4),c.setNoDelay(!0),c.setRecvBufferSize&&c.setRecvBufferSize(64*1024),c.setSendBufferSize&&c.setSendBufferSize(64*1024)}catch{}}),S.on("close",()=>n?.requests.delete(S)),S.setTimeout(9e4,()=>{try{let c=new Error("Request timeout");c.code="ETIMEDOUT",S.destroy(c)}catch{}}),n?.cancelled)try{S.destroy(new Error("cancelled"))}catch{}S.on("error",async c=>{let E=c?.code,A=String(c?.message||"").toLowerCase(),b=A.includes("aborted")||A.includes("socket")||A.includes("closed");if(e<8&&(b||E&&Ke.has(String(E)))){let P=s;try{P=D.statSync(t).size}catch{}await v(P)||m(c)}else{let P=new Promise($=>{try{d.close(()=>$())}catch{$()}});try{await P}catch{}m(c)}})})}async function Ye(o,t,r){try{let e=D.statSync(o);return r&&Number(r)>0&&e.size!==Number(r)?!1:(await O(o)).toLowerCase()===String(t).toLowerCase()}catch{return!1}}async function $e(o){let t=`${o.replace(/\/$/,"")}/checksums.json`;return Ge(t)}async function Xe(o,t,r,e,n=4,s){let a=ce(t.path).split("/").join(L.sep),i=L.join(r,a);if(Te(L.dirname(i)),await Ye(i,t.checksum,t.size))return e("progress:skip",{path:t.path}),{downloadComplete:!0,verificationComplete:!0,targetPath:i};if(s?.cancelled)throw new Error("cancelled");if(Array.isArray(t.parts)&&t.parts.length>0){let d=t.parts.length,l=new Array(d),u=0,m=new Set;async function w(){for(;;){let f=u++;if(f>=d)return;if(m.has(f))continue;m.add(f);let x=t.parts[f],v=ce(x.path),S=`${o.replace(/\/$/,"")}/${v}`,c=`${i}.part${f}`;try{if(D.existsSync(c))if((await O(c)).toLowerCase()===String(x.checksum).toLowerCase()){e("progress:part",{path:t.path,part:f,totalParts:d,received:Number(x.size||0),total:Number(x.size||0)}),l[f]=c;continue}else try{D.unlinkSync(c)}catch{}}catch{}let E=0;for(;;){if(s?.cancelled)throw new Error("cancelled");E+=1;let A=0,b=0;try{let $=0;try{$=D.statSync(c).size}catch{}let N=Number(x.size||0);if(N>0&&$>N)try{D.unlinkSync(c),$=0}catch{}await te(S,c,(T,M)=>{let F=Math.max(0,T-b);b=T;try{F>0&&e("progress:bytes",{delta:F})}catch{}A+=F;let q=N||M||0;e("progress:part",{path:t.path,part:f,totalParts:d,received:Math.min(T,q||T),total:q})},1,s,$,N)}catch{try{D.unlinkSync(c)}catch{}try{A>0&&e("progress:bytes",{delta:-A})}catch{}try{e("progress:part:reset",{path:t.path,part:f,totalParts:d})}catch{}let N=Math.min(2e3*E,1e4);await W(N);continue}if((await O(c)).toLowerCase()===String(x.checksum).toLowerCase())break;try{D.unlinkSync(c)}catch{}try{A>0&&e("progress:bytes",{delta:-A})}catch{}try{e("progress:part:reset",{path:t.path,part:f,totalParts:d})}catch{}let P=Math.min(2e3*E,1e4);await W(P)}l[f]=c}}let g=Array.from({length:Math.max(1,n)},()=>w());return await Promise.all(g),{downloadComplete:!0,verificationComplete:!1,targetPath:i,mergeAndVerifyAsync:async()=>{e("progress:merge:start",{path:t.path,parts:l.length});let f=5*60*1e3,x=async()=>{let S=D.createWriteStream(i),c=null;try{for(let E=0;E<l.length;E++){let A=l[E];if(!A)throw new Error(`Part ${E} path is undefined for ${t.path}`);e("progress:merge:part",{path:t.path,part:E,totalParts:l.length}),await new Promise((b,R)=>{if(!D.existsSync(A)){R(new Error(`Part file missing: ${A}`));return}let P=D.createReadStream(A);P.on("error",R),c||(c=$=>R($),S.on("error",c)),P.on("end",()=>{try{D.unlinkSync(A)}catch{}b()}),P.pipe(S,{end:!1})})}await new Promise((E,A)=>{S.on("finish",E),S.end()})}catch(E){try{S.destroy()}catch{}throw E}};await Promise.race([x(),new Promise((S,c)=>setTimeout(()=>c(new Error(`Merge timeout for ${t.path}`)),f))]);try{e("progress:merge:done",{path:t.path})}catch{}if(e("progress:verify",{path:t.path}),(await O(i)).toLowerCase()!==String(t.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${t.path}`);try{let S=D.readdirSync(L.dirname(i)),c=L.basename(i);S.forEach(E=>{if(E.startsWith(c+".part"))try{D.unlinkSync(L.join(L.dirname(i),E))}catch{}})}catch{}return{verificationComplete:!0,targetPath:i,filePath:t.path}}}}else{let d=ce(t.path),l=`${o.replace(/\/$/,"")}/${d}`,u=0;for(;;){u+=1;let m=0,w=0,g=`${i}.download`,f=0;try{f=D.statSync(g).size}catch{}let x=Number(t.size||0);if(x>0&&f>x)try{D.unlinkSync(g),f=0}catch{}if(await te(l,g,(S,c)=>{let E=Math.max(0,S-w);w=S;try{E>0&&e("progress:bytes",{delta:E})}catch{}m+=E;let A=x||c||0;e("progress:file",{path:t.path,received:Math.min(S,A||S),total:A})},1,s,f,x),(await O(g)).toLowerCase()===String(t.checksum).toLowerCase())break;try{D.unlinkSync(g)}catch{}try{m>0&&e("progress:bytes",{delta:-m})}catch{}if(u>=2)throw new Error(`Checksum mismatch for ${t.path}`)}try{D.unlinkSync(i)}catch{}D.renameSync(`${i}.download`,i)}if(e("progress:verify",{path:t.path}),(await O(i)).toLowerCase()!==String(t.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${t.path}`);return{downloadComplete:!0,verificationComplete:!0,targetPath:i}}async function _e(o,t,r,e,n=!1,s=4,a=4,i,h){let d=new Set,l=[];for(let S of t.files||[]){if(!(n||!S.optional))continue;let c=Ae(S.path);c&&(d.has(c)||(d.add(c),l.push(S)))}let u=l.filter(S=>!(Array.isArray(S.parts)&&S.parts.length>0)),m=l.filter(S=>Array.isArray(S.parts)&&S.parts.length>0),w=u.concat(m),g=w.length,f=0,x=w.reduce((S,c)=>{let E=Number(c.size||0);return E>0?S+E:Array.isArray(c.parts)&&c.parts.length?S+c.parts.reduce((A,b)=>A+Number(b.size||0),0):S},0);try{e("progress:bytes:total",{totalBytes:x})}catch{}async function v(S,c,E,A=!1){let b=0,R=[];async function P(){for(;;){for(;h&&h();)if(await W(100),i?.cancelled)return;let N=b++;if(N>=S.length)return;let T=S[N],M=c+N,F=Ae(T.path),q=async()=>Xe(o,T,r,e,a,i),ve=!1,Z=G.get(F);Z?ve=!0:(e("progress:start",{index:M,total:g,path:T.path,completed:f}),Z=(async()=>{try{let j=await q();if(A&&j?.mergeAndVerifyAsync){let xe=j.mergeAndVerifyAsync().then(U=>(U?.filePath&&(f+=1,e("progress:done",{index:M,total:g,path:U.filePath,completed:f})),U)).catch(async U=>{if(String(U?.message||U||"error").includes("cancelled"))throw U;try{let B=L.join(r,T.path.replace(/\\/g,L.sep));try{D.unlinkSync(B)}catch{}try{let I=D.readdirSync(L.dirname(B)),ie=L.basename(B);I.forEach(ee=>{if(ee.startsWith(ie+".part"))try{D.unlinkSync(L.join(L.dirname(B),ee))}catch{}})}catch{}let V=await q();if(V.mergeAndVerifyAsync){let I=await V.mergeAndVerifyAsync();return I?.filePath&&(f+=1,e("progress:done",{index:M,total:g,path:I.filePath,completed:f})),I}return V}catch(B){try{e("progress:error",{path:T.path,message:String(B?.message||B)})}catch{}try{e("progress:done",{index:M,total:g,path:T.path,completed:f,error:!0})}catch{}throw B}});return R.push(xe),{...j,skipProgressDone:!0}}return j}catch(j){if(String(j?.message||j||"error").includes("cancelled"))throw j;try{let U=L.join(r,T.path.replace(/\\/g,L.sep));try{D.unlinkSync(U)}catch{}let J=await q();if(A&&J?.mergeAndVerifyAsync){let B=J.mergeAndVerifyAsync().then(V=>(V?.filePath&&(f+=1,e("progress:done",{index:M,total:g,path:V.filePath,completed:f})),V)).catch(V=>{try{let I=L.join(r,T.path.replace(/\\/g,L.sep)),ie=D.readdirSync(L.dirname(I)),ee=L.basename(I);ie.forEach(Ce=>{if(Ce.startsWith(ee+".part"))try{D.unlinkSync(L.join(L.dirname(I),Ce))}catch{}})}catch{}try{e("progress:error",{path:T.path,message:String(V?.message||V)})}catch{}try{e("progress:done",{index:M,total:g,path:T.path,completed:f,error:!0})}catch{}throw V});return R.push(B),{...J,skipProgressDone:!0}}return J}catch(U){try{e("progress:error",{path:T.path,message:String(U?.message||U)})}catch{}try{e("progress:done",{index:M,total:g,path:T.path,completed:f,error:!0})}catch{}throw U}}})(),G.set(F,Z));let Pe;try{Pe=await Z}finally{ve||G.delete(F)}Pe?.skipProgressDone||(f+=1,e("progress:done",{index:M,total:g,path:T.path,completed:f})),await W(10)}}let $=Array.from({length:Math.max(1,E)},()=>P());if(await Promise.all($),R.length>0){let T=(await Promise.allSettled(R)).filter(M=>M.status==="rejected");if(T.length>0)for(let M of T)console.error("Verification failed:",M.reason?.message||M.reason)}}if(await v(u,0,Math.max(1,s)),G.size>0)try{await Promise.all([...G.values()])}catch{}await v(m,u.length,1,!0)}import ue from"node:fs";import Qe from"node:path";import{app as Ze}from"electron";var Me=Ze.getPath("userData"),Ne=Qe.join(Me,"settings.json");function fe(){try{let o=ue.readFileSync(Ne,"utf-8");return JSON.parse(o)}catch{return{}}}function et(o){ue.mkdirSync(Me,{recursive:!0}),ue.writeFileSync(Ne,JSON.stringify(o,null,2),"utf-8")}function pe(o,t=void 0){return fe()[o]??t}function re(o,t){let r=fe();r[o]=t,et(r)}function K(){return fe()}var Ie=tt(import.meta.url),{autoUpdater:z}=Ie("electron-updater"),Ve=Ie("electron-log"),ot=rt(import.meta.url),Y=p.dirname(ot);var k,H=null,me=new Set,se=new Map,oe=new Map,ge="r5v",ae=[];function je(o){try{return(o||[]).filter(t=>typeof t=="string"&&t.startsWith(`${ge}://`))}catch{return[]}}function ke(o){try{let t=new URL(o);if(t.hostname==="mod"&&t.pathname==="/install"){let r=t.searchParams.get("name")||"",e=t.searchParams.get("version")||"",n=t.searchParams.get("downloadUrl")?.split(",")||"";if(k&&k.webContents&&!k.webContents.isLoading())try{k.webContents.send("deeplink:mod-install",{url:o,name:r,version:e,downloadUrls:n})}catch{}else ae.push(o)}}catch{}}function at(){for(;ae.length;){let o=ae.shift();ke(o)}}var it=_.requestSingleInstanceLock();it?_.on("second-instance",(o,t)=>{try{je(t).forEach(e=>ke(e)),k&&(k.isMinimized()&&k.restore(),k.focus())}catch{}}):_.quit();_.on("open-url",(o,t)=>{o.preventDefault(),ke(t)});async function Be(){let o=pe("windowState",{width:1150,height:800,x:void 0,y:void 0,isMaximized:!1});k=new ze({width:o.width,height:o.height,x:o.x,y:o.y,minWidth:1150,minHeight:800,frame:!1,titleBarStyle:"hidden",webPreferences:{preload:p.join(Y,"preload.cjs"),contextIsolation:!0,nodeIntegration:!1},show:!1,icon:p.join(Y,"..","public","icon.png")});let t=process.env.VITE_DEV_SERVER_URL;if(t)await k.loadURL(t);else{let a=p.join(Y,"..","dist","index.html");await k.loadFile(a)}k.webContents.setWindowOpenHandler(({url:a})=>{try{ye.openExternal(a)}catch{}return{action:"deny"}}),k.webContents.on("will-navigate",(a,i)=>{let h=i.startsWith("file:"),d=!!process.env.VITE_DEV_SERVER_URL&&i.startsWith(String(process.env.VITE_DEV_SERVER_URL));if(!h&&!d){a.preventDefault();try{ye.openExternal(i)}catch{}}});let r=()=>{k&&(k.isVisible()||k.show(),k.isFocused()||k.focus())};o.isMaximized&&k.maximize(),k.once("ready-to-show",r),k.webContents.once("did-finish-load",r);let e=setTimeout(r,1e3);k.on("show",()=>clearTimeout(e));function n(){if(!k)return;let a=k.getBounds(),i=k.isMaximized();re("windowState",{width:a.width,height:a.height,x:a.x,y:a.y,isMaximized:i})}k.on("resize",n),k.on("move",n),k.on("maximize",n),k.on("unmaximize",n),(!!process.env.VITE_DEV_SERVER_URL||process.env.NODE_ENV==="development")&&k.webContents.openDevTools({mode:"detach"}),k.webContents.on("before-input-event",(a,i)=>{i.control&&i.shift&&i.key.toLowerCase()==="i"&&(k.webContents.toggleDevTools(),a.preventDefault())}),k.webContents.on("did-fail-load",(a,i,h,d)=>{console.error("Load failed",{errorCode:i,errorDesc:h,validatedURL:d}),Se.showErrorBox("Load failed",`${h} (code ${i})
URL: ${d}`),k.show()})}_.on("window-all-closed",()=>{process.platform!=="darwin"&&_.quit()});_.whenReady().then(()=>{try{process.defaultApp&&process.platform==="win32"?_.setAsDefaultProtocolClient(ge,process.execPath,[process.argv[1]]):_.setAsDefaultProtocolClient(ge)}catch{}let o=p.resolve(_.getAppPath(),".."),t=p.join(o,"cache");Ue.registerFileProtocol("r5v",(e,n)=>{try{let s=new URL(e.url),a=decodeURIComponent(s.pathname).replace(/^\//,""),i=p.normalize(p.join(t,a));n({path:i})}catch{n({error:-6})}});let r=p.join(Y,"..","dist");Ue.interceptFileProtocol("file",(e,n)=>{try{let s=new URL(e.url),a=decodeURIComponent(s.pathname),i=a.replace(/\\/g,"/"),h=i.indexOf("/_astro/");if(h!==-1){let d=i.substring(h+8),l=p.join(r,"_astro",d);return n({path:l})}if(i.endsWith("/favicon.svg")||/\/favicon\.svg$/i.test(i)){let d=p.join(r,"favicon.svg");return n({path:d})}if(i.startsWith("/")){let d=i.replace(/^\/+/,""),l=p.join(r,d);try{return y.accessSync(l),n({path:l})}catch{}}return n({path:a})}catch{return n({error:-6})}}),Be();try{je(process.argv).forEach(e=>ae.push(e))}catch{}try{k?.webContents?.once("did-finish-load",at)}catch{}try{z.autoDownload=!1;try{z.logger=Ve,Ve.transports.file.level="info"}catch{}z.on("error",e=>{try{k?.webContents.send("update:error",{message:String(e?.stack||e?.message||e)})}catch{}}),z.on("update-available",e=>{try{k?.webContents.send("update:available",e)}catch{}}),z.on("update-not-available",e=>{try{k?.webContents.send("update:not-available",e)}catch{}}),z.on("download-progress",e=>{try{k?.webContents.send("update:download-progress",e)}catch{}}),z.on("update-downloaded",e=>{try{k?.webContents.send("update:downloaded",e)}catch{}})}catch{}_.on("activate",()=>{ze.getAllWindows().length===0&&Be()})});C.handle("update:check",async()=>{try{return{ok:!0,result:(await z.checkForUpdates())?.updateInfo||null}}catch(o){return{ok:!1,error:String(o?.message||o)}}});C.handle("update:download",async()=>{try{return await z.downloadUpdate(),{ok:!0}}catch(o){return{ok:!1,error:String(o?.message||o)}}});C.handle("update:quitAndInstall",async()=>{try{return setImmediate(()=>z.quitAndInstall(!1,!0)),{ok:!0}}catch(o){return{ok:!1,error:String(o?.message||o)}}});C.handle("app:getVersion",async()=>{try{return _.getVersion()}catch{return"0.0.0"}});C.handle("app:getBaseDir",async()=>{try{return p.resolve(_.getAppPath(),"..")}catch{return""}});C.handle("app:getLauncherInstallRoot",async()=>{try{let o=process.env.LOCALAPPDATA||p.join(_.getPath("home"),"AppData","Local");return p.join(o,"Programs","r5vlauncher")}catch{return""}});function ct(o){try{let t=p.join(o,"mods.vdf"),r=y.readFileSync(t,"utf-8"),e={},n=/"([^"]+)"\s*"([01])"/g,s;for(;s=n.exec(r);){let a=s[1];a&&a!=="ModList"&&(e[a]=s[2]==="1")}return e}catch{return{}}}function Ee(o){try{let t=p.join(o,"mods.vdf"),r=y.readFileSync(t,"utf-8"),e={},n=[],s=/"([^"]+)"\s*"([01])"/g,a;for(;a=s.exec(r);){let i=a[1];!i||i==="ModList"||(i in e||n.push(i),e[i]=a[2]==="1")}return{map:e,order:n}}catch{return{map:{},order:[]}}}function we(o){try{let t=y.readFileSync(o,"utf-8"),r=t.match(/"id"\s*"([^"]+)"/i),e=t.match(/"name"\s*"([^"]+)"/i),n=r?r[1]:null,s=e?e[1]:null;return{id:n,name:s}}catch{return{id:null,name:null}}}function lt(o,t){let r=['"ModList"',"{"];for(let[e,n]of Object.entries(t))r.push(`	"${e}"		"${n?"1":"0"}"`);r.push("}"),y.mkdirSync(o,{recursive:!0}),y.writeFileSync(p.join(o,"mods.vdf"),r.join(`
`),"utf-8")}function We(o,t,r){let e=new Set,n=['"ModList"',"{"],s=a=>{n.push(`	"${a}"		"${r[a]?"1":"0"}"`),e.add(a)};for(let a of Array.isArray(t)?t:[])Object.prototype.hasOwnProperty.call(r,a)&&!e.has(a)&&s(a);for(let a of Object.keys(r))e.has(a)||s(a);n.push("}"),y.mkdirSync(o,{recursive:!0}),y.writeFileSync(p.join(o,"mods.vdf"),n.join(`
`),"utf-8")}C.handle("mods:listInstalled",async(o,{installDir:t})=>{try{let r=p.join(t,"mods"),{map:e,order:n}=Ee(r),s=[],a=y.existsSync(r)?y.readdirSync(r,{withFileTypes:!0}):[];for(let h of a){if(!h.isDirectory())continue;let d=p.join(r,h.name),l=p.join(d,"manifest.json"),u=p.join(d,"mod.vdf"),m=p.join(d,"icon.png"),w=null;try{w=JSON.parse(y.readFileSync(l,"utf-8"))}catch{}let g=we(u),f=g.id||w?.name||h.name,x=null;try{x=`data:image/png;base64,${y.readFileSync(m).toString("base64")}`}catch{}s.push({id:f,name:w?.name||g.name||h.name,folder:h.name,version:w?.version_number||null,description:w?.description||"",enabled:f?!!e[f]:!1,hasManifest:y.existsSync(l),iconDataUrl:x})}let i=new Map(n.map((h,d)=>[h,d]));return s.sort((h,d)=>{let l=h.id!=null&&i.has(h.id)?i.get(h.id):Number.MAX_SAFE_INTEGER,u=d.id!=null&&i.has(d.id)?i.get(d.id):Number.MAX_SAFE_INTEGER;return l!==u?l-u:String(h.name||"").localeCompare(String(d.name||""))}),{ok:!0,mods:s}}catch(r){return{ok:!1,error:String(r?.message||r)}}});C.handle("mods:setEnabled",async(o,{installDir:t,name:r,enabled:e})=>{try{let n=p.join(t,"mods"),{map:s}=Ee(n);return s[r]=!!e,We(n,void 0,s),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});C.handle("mods:reorder",async(o,{installDir:t,orderIds:r})=>{try{let e=p.join(t,"mods"),{map:n,order:s}=Ee(e),a=Array.isArray(r)?r.filter(l=>typeof l=="string"&&l&&Object.prototype.hasOwnProperty.call(n,l)):[],i=new Set(a),h=s.filter(l=>Object.prototype.hasOwnProperty.call(n,l)&&!i.has(l)),d=[...a,...h];return We(e,d,n),{ok:!0}}catch(e){return{ok:!1,error:String(e?.message||e)}}});C.handle("mods:uninstall",async(o,{installDir:t,folder:r})=>{try{let e=p.join(t,"mods"),n=p.join(e,r);return y.rmSync(n,{recursive:!0,force:!0}),{ok:!0}}catch(e){return{ok:!1,error:String(e?.message||e)}}});C.handle("mods:fetchAll",async(o,{query:t})=>{let r="https://thunderstore.io/c/r5valkyrie/api/v1/package-listing-index/",e=s=>new Promise((a,i)=>{Q.get(s,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"*/*"}},d=>{if(d.statusCode&&d.statusCode>=300&&d.statusCode<400&&d.headers.location){d.resume();let u=d.headers.location.startsWith("http")?d.headers.location:new URL(d.headers.location,s).toString();return a(e(u))}if(d.statusCode!==200)return d.resume(),i(new Error(`HTTP ${d.statusCode}`));let l=[];d.on("data",u=>l.push(Buffer.isBuffer(u)?u:Buffer.from(u))),d.on("end",()=>a(Buffer.concat(l)))}).on("error",i)}),n=s=>{try{return nt.gunzipSync(s)}catch{return s}};try{let s=await e(r),a=JSON.parse(n(s).toString("utf8")),i=Array.isArray(a)?a:[],h=6,d=[],l=0;await Promise.all(Array.from({length:h}).map(async()=>{for(;l<i.length;){let m=l++,w=i[m];try{let g=await e(w),f=n(g).toString("utf8"),x=JSON.parse(f);Array.isArray(x)&&d.push(...x)}catch{}}}));let u=d;if(t&&String(t).trim()){let m=String(t).toLowerCase();u=u.filter(w=>String(w?.name||"").toLowerCase().includes(m)||String(w?.full_name||"").toLowerCase().includes(m))}return{ok:!0,mods:u}}catch(s){try{let i=await e("https://thunderstore.io/c/r5valkyrie/api/v1/package/"),h=JSON.parse(i.toString("utf8")),d=Array.isArray(h)?h:[];if(t&&String(t).trim()){let l=String(t).toLowerCase();d=d.filter(u=>String(u?.name||"").toLowerCase().includes(l)||String(u?.full_name||"").toLowerCase().includes(l))}return{ok:!0,mods:d}}catch(a){return{ok:!1,error:String(a?.message||s?.message||a||s)}}}});C.handle("mods:install",async(o,{installDir:t,name:r,downloadUrl:e})=>{if(!e.startsWith("https://thunderstore.io"))return{ok:!1,error:"Download URL does not point to Thunderstore"};try{let n=String(r||"").trim();if(!n)return{ok:!1,error:"Invalid mod name"};if(me.has(n))return{ok:!0};me.add(n);let s=p.join(t,"mods");y.mkdirSync(s,{recursive:!0});let a=p.join(s,`.__mod_${Date.now()}.zip`),i=(u,m=0)=>new Promise((w,g)=>{if(m>5)return g(new Error("Too many redirects"));let f=y.createWriteStream(a);Q.get(u,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"application/octet-stream,*/*;q=0.8",Referer:"https://thunderstore.io/",Connection:"keep-alive"}},v=>{if(v.statusCode&&v.statusCode>=300&&v.statusCode<400&&v.headers.location){v.resume(),f.close(()=>{});try{y.unlinkSync(a)}catch{}let b=v.headers.location.startsWith("http")?v.headers.location:new URL(v.headers.location,u).toString();return w(i(b,m+1))}if(v.statusCode!==200){f.close(()=>{});try{y.unlinkSync(a)}catch{}return v.resume(),g(new Error(`HTTP ${v.statusCode}`))}let S=Number(v.headers["content-length"]||0),c=0,E=Date.now(),A=b=>{try{o?.sender?.send("mods:progress",{key:r,phase:b,received:c,total:S})}catch{}};v.on("data",b=>{c+=Buffer.isBuffer(b)?b.length:Buffer.byteLength(String(b));let R=Date.now();R-E>150&&(E=R,A("downloading"))}),v.pipe(f),f.on("finish",()=>{A("downloading"),f.close(w)})}).on("error",v=>{try{y.unlinkSync(a)}catch{}g(v)})});await i(e);try{o?.sender?.send("mods:progress",{key:r,phase:"extracting"})}catch{}let h=p.join(s,r);try{y.rmSync(h,{recursive:!0,force:!0})}catch{}y.mkdirSync(h,{recursive:!0}),await new Promise((u,m)=>{let w=ne("powershell.exe",["-NoProfile","-NonInteractive","-Command",`Expand-Archive -LiteralPath "${a}" -DestinationPath "${h}" -Force`],{stdio:"ignore"});w.on("exit",g=>g===0?u():m(new Error(`Expand-Archive failed ${g}`))),w.on("error",m)});try{y.unlinkSync(a)}catch{}let d=null;try{let u=p.join(h,"mod.vdf");if(y.existsSync(u))d=we(u).id;else{let m=y.readdirSync(h,{withFileTypes:!0});for(let w of m)if(w.isDirectory()){let g=p.join(h,w.name,"mod.vdf");if(y.existsSync(g)&&(d=we(g).id,d))break}}}catch{}let l=ct(s);l[d||r]=!0,lt(s,l);try{o?.sender?.send("mods:progress",{key:r,phase:"done"})}catch{}return{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}finally{try{me.delete(String(r||""))}catch{}}});C.handle("mods:watch",async(o,{installDir:t})=>{try{let r=p.join(t,"mods");if(!y.existsSync(r))return{ok:!0};let e=r;if(se.has(e))return{ok:!0};let n=y.watch(r,{persistent:!0},(s,a)=>{let i=e;clearTimeout(oe.get(i));let h=setTimeout(()=>{try{k?.webContents?.send("mods:changed",{installDir:t})}catch{}},300);oe.set(i,h)});return se.set(e,n),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});C.handle("mods:unwatch",async(o,{installDir:t})=>{try{let e=p.join(t,"mods"),n=se.get(e);if(n){try{n.close()}catch{}se.delete(e)}let s=oe.get(e);return s&&(clearTimeout(s),oe.delete(e)),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});C.handle("mods:iconDataUrl",async(o,{installDir:t,folder:r})=>{try{let e=p.join(t,"mods",r,"icon.png");return await y.promises.access(e),{ok:!0,dataUrl:`data:image/png;base64,${(await y.promises.readFile(e)).toString("base64")}`}}catch(e){return{ok:!1,error:String(e?.message||e)}}});C.handle("select-directory",async()=>{let o=await Se.showOpenDialog({properties:["openDirectory","createDirectory"]});return o.canceled||o.filePaths.length===0?null:o.filePaths[0]});C.handle("settings:get",()=>K());C.handle("settings:set",(o,{key:t,value:r})=>re(t,r));C.handle("download:checksums",async(o,{baseUrl:t})=>$e(t));C.handle("download:all",async(o,{baseUrl:t,checksums:r,installDir:e,includeOptional:n,concurrency:s,partConcurrency:a,channelName:i,mode:h})=>{let d=(l,u)=>o.sender.send(l,u);try{if(!(String(h||"install").toLowerCase()==="install")){let u=p.join(e,"mods","mods.vdf");if(y.existsSync(u)){let w=(Array.isArray(r?.files)?r.files:[]).filter(g=>{try{return String(g?.path||g?.name||"").replace(/\\/g,"/").toLowerCase()!=="mods/mods.vdf"}catch{return!0}});r={...r||{},files:w}}}}catch{}H=Re(),X=!1;try{await _e(t,r,e,d,!!n,Number(s)||4,Number(a)||4,H,()=>X);try{let l=pe("channels",{})||{};l[String(i||"default")]={installDir:e,gameVersion:r?.game_version||null,gameBaseUrl:t,lastUpdatedAt:Date.now()},re("channels",l)}catch(l){console.error("Failed to persist channel info",l)}}finally{H=null}return!0});C.handle("default-install-dir",(o,{channelName:t})=>{let e=K()?.customBaseDir,n;if(e&&typeof e=="string"&&e.trim())n=e;else{let s=process.env.LOCALAPPDATA||p.join(_.getPath("home"),"AppData","Local");n=p.join(s,"Programs","R5VLibrary")}return t?p.join(n,t):n});C.handle("scan-custom-channels",async(o,{officialChannelNames:t,channelsSettings:r})=>{try{let e=[],n=new Set((t||[]).map(l=>l.toLowerCase())),s=new Set,a=async l=>{try{return await y.promises.access(p.join(l,"r5apex.exe")),!0}catch{try{return await y.promises.access(p.join(l,"r5apex_ds.exe")),!0}catch{return!1}}},h=K()?.customBaseDir,d;if(h&&typeof h=="string"&&h.trim())d=h;else{let l=process.env.LOCALAPPDATA||p.join(_.getPath("home"),"AppData","Local");d=p.join(l,"Programs","R5VLibrary")}try{await y.promises.access(d);let l=await y.promises.readdir(d,{withFileTypes:!0});for(let u of l){if(!u.isDirectory())continue;let m=u.name,w=p.join(d,m),g=w.toLowerCase();s.has(g)||n.has(m.toLowerCase())||await a(w)&&(e.push({name:m,installDir:w,isCustom:!0}),s.add(g))}}catch{}if(r&&typeof r=="object")for(let[l,u]of Object.entries(r)){if(!u||typeof u!="object")continue;let m=u.installDir;if(!m||typeof m!="string")continue;let w=m.toLowerCase();if(!s.has(w)&&await a(m)){let g=p.basename(m);n.has(g.toLowerCase())||(e.push({name:g,installDir:m,isCustom:!0}),s.add(w))}}if(r&&typeof r=="object"){let l=new Set;for(let u of Object.values(r))if(u&&typeof u=="object"&&u.installDir){let m=p.dirname(u.installDir);l.add(m)}for(let u of l)try{let m=await y.promises.readdir(u,{withFileTypes:!0});for(let w of m){if(!w.isDirectory())continue;let g=w.name,f=p.join(u,g),x=f.toLowerCase();s.has(x)||n.has(g.toLowerCase())||await a(f)&&(e.push({name:g,installDir:f,isCustom:!0}),s.add(x))}}catch{}}return e}catch(e){return console.error("Error scanning for custom channels:",e),[]}});C.handle("open-folder",async(o,{folderPath:t})=>{try{if(!t)return{ok:!1,error:"No folder path provided"};try{await y.promises.access(t)}catch{return{ok:!1,error:"Folder does not exist"}}return await ye.openPath(t),{ok:!0}}catch(r){return console.error("Error opening folder:",r),{ok:!1,error:String(r)}}});C.handle("set-download-speed-limit",async(o,{bytesPerSecond:t})=>{try{let r=Number(t)||0;return Le(r),{ok:!0}}catch(r){return console.error("Error setting download speed limit:",r),{ok:!1,error:String(r)}}});C.handle("launcher:config",async(o,{url:t})=>(e=>new Promise((n,s)=>{Q.get(e,a=>{if(a.statusCode!==200){s(new Error(`HTTP ${a.statusCode} for ${e}`)),a.resume();return}let i="";a.setEncoding("utf8"),a.on("data",h=>i+=h),a.on("end",()=>{try{n(JSON.parse(i))}catch(h){s(h)}})}).on("error",s)}))(t));C.handle("eula:get",async()=>{let o="https://playvalkyrie.org/api/eula",t=r=>new Promise((e,n)=>{Q.get(r,s=>{if(s.statusCode!==200){n(new Error(`HTTP ${s.statusCode}`)),s.resume();return}let a=[];s.on("data",i=>a.push(Buffer.isBuffer(i)?i:Buffer.from(i))),s.on("end",()=>{try{let i=Buffer.concat(a).toString("utf8");e(JSON.parse(i))}catch(i){n(i)}})}).on("error",n)});try{return{ok:!0,json:await t(o)}}catch(r){return{ok:!1,error:String(r?.message||r)}}});C.handle("video:cache",async(o,{filename:t})=>{try{let e=`https://blaze.playvalkyrie.org/video_backgrounds/${t}`,n=p.join(p.resolve(_.getAppPath(),".."),"cache"),s=p.join(n,"videos"),a=p.join(s,t),i=p.join(Y,"..","dist"),h=p.join(i,t);await y.promises.mkdir(s,{recursive:!0});try{if((await y.promises.stat(a)).size>0){try{await y.promises.access(h)}catch{await y.promises.copyFile(a,h)}return`./${t}`}else await y.promises.unlink(a)}catch{}return await new Promise((d,l)=>{let u=y.createWriteStream(a),m=Q.get(e,w=>{if(w.statusCode!==200){u.close(()=>{}),y.unlink(a,()=>{}),l(new Error(`HTTP ${w.statusCode} for video ${t}`)),w.resume();return}w.pipe(u),u.on("finish",()=>u.close(d)),u.on("error",g=>{y.unlink(a,()=>l(g))})});m.on("error",w=>{u.close(()=>{}),y.unlink(a,()=>{}),l(w)}),m.setTimeout(3e4,()=>{m.destroy(),u.close(()=>{}),y.unlink(a,()=>{}),l(new Error(`Video download timeout for ${t}`))})}),await y.promises.copyFile(a,h),`./${t}`}catch(r){throw console.error(`Video cache error for ${t}:`,r),r}});C.handle("fs:is-installed-in-dir",async(o,{path:t})=>{let r=!1,e=!1,n=!1;try{await y.promises.access(p.join(t,"r5apex.exe")),r=!0}catch{}try{await y.promises.access(p.join(t,"r5apex_ds.exe")),e=!0}catch{}try{let s=async(a,i=0)=>{if(i>3)return!1;try{let h=await y.promises.readdir(a,{withFileTypes:!0});for(let d of h)if(d.isFile()){let l=d.name.toLowerCase();if(l.endsWith(".part0")||l.endsWith(".part1")||l.endsWith(".part2")||l.endsWith(".part3")||l.endsWith(".part4")||l.endsWith(".part5")||l.endsWith(".download")||/\.part\d+$/.test(l))return!0}else if(d.isDirectory()&&!d.name.startsWith(".")&&await s(p.join(a,d.name),i+1))return!0}catch{}return!1};n=await s(t)}catch{}return{isInstalled:r||e,needsRepair:n}});var X=!1;C.handle("download:pause",async()=>{X=!0;try{k?.webContents.send("progress:paused",{})}catch{}return!0});C.handle("download:resume",async()=>{X=!1;try{k?.webContents.send("progress:resumed",{})}catch{}return!0});C.handle("download:cancel",async()=>{try{he(H)}catch{}H=null,X=!1;try{k?.webContents.send("progress:cancelled",{})}catch{}return!0});C.handle("select-file",async(o,{filters:t})=>{let r=await Se.showOpenDialog({properties:["openFile"],filters:Array.isArray(t)?t:void 0});return r.canceled||r.filePaths.length===0?null:r.filePaths[0]});C.handle("game:launch",async(o,{channelName:t,installDir:r,mode:e,argsString:n})=>{try{if(!r)throw new Error("Missing installDir");let s=String(e).toUpperCase()==="SERVER"?"r5apex_ds.exe":"r5apex.exe",a=p.join(r,s);await y.promises.access(a).catch(()=>{throw new Error(`Executable not found: ${a}`)});let h=(l=>!l||typeof l!="string"?[]:(l.match(/(?:[^\s\"]+|\"[^\"]*\")+/g)||[]).map(m=>m.replace(/^\"|\"$/g,"")))(n);return ne(a,h,{cwd:r,detached:!0,stdio:"ignore",env:{...process.env}}).unref(),{ok:!0}}catch(s){return{ok:!1,error:String(s?.message||s)}}});C.handle("fix-folder-permissions",async(o,{selectedChannel:t})=>{let r=[],e=K().channels[t].installDir;try{if(!e)return{ok:!1,error:"No folder path provided"};let n=p.resolve(e).replace(/\//g,"\\");if(!n||n.length<3)return{ok:!1,error:`Invalid path format: ${e}`};let s=n.length>=3&&n[1]===":"?n.slice(3):n;if(/[<>:"|?*]/.test(s))return{ok:!1,error:`Path contains invalid characters: ${n}`};let h=st.userInfo().username,d=p.join(process.resourcesPath,"elevate.exe"),l=y.existsSync(d);try{y.mkdirSync(n,{recursive:!0})}catch{}let u=[{exe:"icacls",args:[n,"/grant",`${h}:F`,"/t","/q"],desc:`Grant permissions to current user (${h})`},{exe:"icacls",args:[n,"/grant","Everyone:F","/t","/q"],desc:"Grant Everyone full permissions"},{exe:"icacls",args:[n,"/grant","Users:F","/t","/q"],desc:"Grant Users full permissions"}];for(let m=0;m<u.length;m++){let{exe:w,args:g,desc:f}=u[m];try{let x=await new Promise((v,S)=>{let c,E,A;l?(E=[d,["-wait",w,...g]],A={stdio:["ignore","pipe","pipe"],windowsHide:!0}):(E=[w,g],A={stdio:["ignore","pipe","pipe"],windowsHide:!0});try{c=ne(E[0],E[1],A)}catch(P){console.error("[Permission Fix] Spawn failed:",P),S(P);return}let b="",R="";c.stdout&&c.stdout.on("data",P=>{b+=P.toString()}),c.stderr&&c.stderr.on("data",P=>{R+=P.toString()}),c.on("exit",(P,$)=>{v({code:P,stdout:b,stderr:R,signal:$})}),c.on("error",P=>{S(P)}),setTimeout(()=>{try{c.kill()}catch{}S(new Error("Command timeout"))},3e4)});if(x.code!==0){let v=x.stderr||x.stdout||"Unknown error";if(!(v.includes("duplicate")||v.includes("already")||x.code===1332)){let c=`${f} failed (code ${x.code}): ${v}`;r.push(c)}}}catch(x){let v=`${f} error: ${x.message}`;r.push(v)}}try{let m=p.join(n,"test_write.tmp");y.writeFileSync(m,"test"),y.unlinkSync(m)}catch(m){let w=`Write test failed: ${m.message}`;r.push(w);try{if(y.mkdirSync(n,{recursive:!0}),(await new Promise(f=>{let x=ne("cmd",["/c",`icacls "${n}" /grant "%USERNAME%":F /q`],{stdio:"ignore",windowsHide:!0});x.on("exit",v=>f({code:v})),x.on("error",()=>f({code:1})),setTimeout(()=>{try{x.kill()}catch{}f({code:1})},5e3)})).code===0){let f=p.join(n,"test_write2.tmp");return y.writeFileSync(f,"test"),y.unlinkSync(f),{ok:!0,warnings:r}}}catch{}return{ok:!1,error:w,details:r}}return r.length>0?{ok:!0,warnings:r}:{ok:!0}}catch(n){let s=`Unexpected error: ${n?.message||n}`;return r.push(s),{ok:!1,error:s,details:r}}});C.handle("fs:delete-folder",async(o,{folderPath:t})=>{try{if(!t)return{ok:!1,error:"No folder path provided"};let r=p.resolve(t),e=r.toLowerCase(),n=["c:\\","c:\\windows","c:\\program files","c:\\program files (x86)","c:\\users"];if(n.some(s=>e===s||e.startsWith(s+"\\")&&e.split("\\").length<=3)&&e.split("\\").length<=3&&n.includes(e.split("\\").slice(0,3).join("\\")))return{ok:!1,error:"Cannot delete system folders"};try{await y.promises.access(r)}catch{return{ok:!0}}return await y.promises.rm(r,{recursive:!0,force:!0}),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});C.on("window:minimize",()=>{k?.minimize()});C.on("window:maximize",()=>{k&&(k.isMaximized()?k.unmaximize():k.maximize())});C.on("window:close",()=>{k?.close()});_.on("before-quit",()=>{if(H)try{he(H)}catch{}});
