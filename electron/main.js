import{app as D,BrowserWindow as Ne,ipcMain as x,dialog as ge,protocol as $e,shell as fe}from"electron";import{createRequire as Qe}from"node:module";import m from"node:path";import{fileURLToPath as Ye,pathToFileURL as Et}from"node:url";import Y from"node:https";import y from"node:fs";import Ze from"node:zlib";import{spawn as re}from"node:child_process";import et from"node:os";import C from"node:fs";import b from"node:path";import Fe from"node:crypto";import{pipeline as je}from"node:stream";import{promisify as Be}from"node:util";import ce from"node:https";var We=Be(je);function ae(n){return String(n||"").replace(/\\/g,"/").replace(/^\/+/,"")}function Ce(n){return String(n||"").replace(/\\/g,"/").toLowerCase()}var K=new Map,Pe=new ce.Agent({keepAlive:!0,maxSockets:64,maxFreeSockets:32,keepAliveMsecs:6e4,scheduling:"fifo"});function O(n){return new Promise((t,r)=>{let e=Fe.createHash("sha256"),o=C.createReadStream(n);o.on("error",r),o.on("end",()=>t(e.digest("hex"))),o.on("data",a=>e.update(a))})}function Ae(n){C.mkdirSync(n,{recursive:!0})}function qe(n){return new Promise((t,r)=>{let e=ce.get(n,{agent:Pe},o=>{if(o.statusCode!==200){r(new Error(`HTTP ${o.statusCode} for ${n}`)),o.resume();return}let a="";o.setEncoding("utf8"),o.on("data",s=>a+=s),o.on("end",()=>{try{t(JSON.parse(a))}catch(s){r(s)}})});e.on("error",r),e.setTimeout(3e4,()=>{e.destroy(),r(new Error("JSON fetch timeout"))})})}function j(n){return new Promise(t=>setTimeout(t,n))}function be(){return{cancelled:!1,requests:new Set}}function ie(n){if(n){n.cancelled=!0;for(let t of n.requests)try{t.destroy(new Error("cancelled"))}catch{}n.requests.clear()}}var He=new Set(["ECONNRESET","ETIMEDOUT","EAI_AGAIN","ECONNABORTED","ENETRESET","EHOSTUNREACH","ENETUNREACH","EPIPE","ENOTFOUND","ECONNREFUSED","EHOSTDOWN","ENETDOWN"]);async function J(n,t,r,e=1,o,a=0,s=0){return new Promise((c,h)=>{Ae(b.dirname(t));let i=C.createWriteStream(t,{flags:a>0?"a":"w"});if(o?.cancelled)return i.close(()=>{}),h(new Error("cancelled"));let l={agent:Pe};a>0&&(l.headers={Range:`bytes=${a}-`});let p=ce.get(n,l,d=>{if(d.statusCode!==200&&!(a>0&&d.statusCode===206)){if(i.close(()=>{}),a>0&&d.statusCode===200){try{C.unlinkSync(t)}catch{}let f=Math.min(2e3*e,1e4);d.resume();try{p.destroy(new Error("restart:range-ignored"))}catch{}return j(f).then(()=>c(J(n,t,r,e+1,o,0,s)))}if(C.unlink(t,()=>{}),d.statusCode&&[429,500,502,503,504].includes(d.statusCode)&&e<5){let f=Math.min(2e3*e,1e4);return d.resume(),j(f).then(()=>c(J(n,t,r,e+1,o,a,s)))}h(new Error(`HTTP ${d.statusCode} for ${n}`)),d.resume();return}let g=Number(d.headers["content-length"]||0),E=s>0?s:a>0?a+g:g,u=0,v=Date.now(),S=e<=2?3e4:45e3,k=setInterval(()=>{if(!o?.cancelled&&Date.now()-v>S)try{let f=new Error("stalled");f.code="ETIMEDOUT",p.destroy(f)}catch{}},1e4);d.on("data",f=>{u+=f.length,v=Date.now(),r&&r(Math.min(a+u,E||a+u),E||0)}),d.on("aborted",async()=>{let f=new Promise(P=>i.close(()=>P()));try{clearInterval(k)}catch{}try{await f}catch{}if(e<5){let P=Math.min(2e3*e,1e4);return j(P).then(()=>c(J(n,t,r,e+1,o,a+u,s)))}h(new Error("response aborted"))}),We(d,i).then(()=>{try{clearInterval(k)}catch{}c()}).catch(f=>{try{clearInterval(k)}catch{}h(f)})});if(o?.requests.add(p),p.on("socket",d=>{try{d.setKeepAlive(!0,6e4),d.setNoDelay(!0),d.setRecvBufferSize&&d.setRecvBufferSize(64*1024),d.setSendBufferSize&&d.setSendBufferSize(64*1024)}catch{}}),p.on("close",()=>o?.requests.delete(p)),p.setTimeout(9e4,()=>{try{let d=new Error("Request timeout");d.code="ETIMEDOUT",p.destroy(d)}catch{}}),o?.cancelled)try{p.destroy(new Error("cancelled"))}catch{}p.on("error",async d=>{let g=d?.code,E=e<8&&g&&He.has(String(g)),u=new Promise(v=>{try{i.close(()=>v())}catch{v()}});try{await u}catch{}if(E){let v=Math.min(1e3*Math.pow(1.5,e),15e3),S=Math.random()*1e3,k=v+S,f=a;try{f=C.statSync(t).size}catch{}return j(k).then(()=>c(J(n,t,r,e+1,o,f,s)))}h(d)})})}async function Oe(n,t,r){try{let e=C.statSync(n);return r&&Number(r)>0&&e.size!==Number(r)?!1:(await O(n)).toLowerCase()===String(t).toLowerCase()}catch{return!1}}async function De(n){let t=`${n.replace(/\/$/,"")}/checksums.json`;return qe(t)}async function Je(n,t,r,e,o=4,a){let s=ae(t.path).split("/").join(b.sep),c=b.join(r,s);if(Ae(b.dirname(c)),await Oe(c,t.checksum,t.size))return e("progress:skip",{path:t.path}),{downloadComplete:!0,verificationComplete:!0,targetPath:c};if(a?.cancelled)throw new Error("cancelled");if(Array.isArray(t.parts)&&t.parts.length>0){let i=t.parts.length,l=new Array(i),p=0,d=new Set;async function g(){for(;;){let u=p++;if(u>=i)return;if(d.has(u))continue;d.add(u);let v=t.parts[u],S=ae(v.path),k=`${n.replace(/\/$/,"")}/${S}`,f=`${c}.part${u}`;try{if(C.existsSync(f))if((await O(f)).toLowerCase()===String(v.checksum).toLowerCase()){e("progress:part",{path:t.path,part:u,totalParts:i,received:Number(v.size||0),total:Number(v.size||0)}),l[u]=f;continue}else try{C.unlinkSync(f)}catch{}}catch{}let P=0;for(;;){if(a?.cancelled)throw new Error("cancelled");P+=1;let A=0,L=0;try{let I=0;try{I=C.statSync(f).size}catch{}let N=Number(v.size||0);if(N>0&&I>N)try{C.unlinkSync(f),I=0}catch{}await J(k,f,(_,B)=>{let W=Math.max(0,_-L);L=_;try{W>0&&e("progress:bytes",{delta:W})}catch{}A+=W;let H=N||B||0;e("progress:part",{path:t.path,part:u,totalParts:i,received:Math.min(_,H||_),total:H})},1,a,I,N)}catch{try{C.unlinkSync(f)}catch{}try{A>0&&e("progress:bytes",{delta:-A})}catch{}try{e("progress:part:reset",{path:t.path,part:u,totalParts:i})}catch{}let N=Math.min(2e3*P,1e4);await j(N);continue}if((await O(f)).toLowerCase()===String(v.checksum).toLowerCase())break;try{C.unlinkSync(f)}catch{}try{A>0&&e("progress:bytes",{delta:-A})}catch{}try{e("progress:part:reset",{path:t.path,part:u,totalParts:i})}catch{}let T=Math.min(2e3*P,1e4);await j(T)}l[u]=f}}let E=Array.from({length:Math.max(1,o)},()=>g());return await Promise.all(E),{downloadComplete:!0,verificationComplete:!1,targetPath:c,mergeAndVerifyAsync:async()=>{e("progress:merge:start",{path:t.path,parts:l.length});let u=C.createWriteStream(c);for(let S=0;S<l.length;S++){let k=l[S];e("progress:merge:part",{path:t.path,part:S,totalParts:l.length}),await new Promise((f,P)=>{let A=C.createReadStream(k);A.on("error",P),u.on("error",P),A.on("end",()=>{try{C.unlinkSync(k)}catch{}f()}),A.pipe(u,{end:!1})})}await new Promise((S,k)=>{u.on("error",k),u.on("finish",S),u.end()});try{e("progress:merge:done",{path:t.path})}catch{}if(e("progress:verify",{path:t.path}),(await O(c)).toLowerCase()!==String(t.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${t.path}`);try{let S=C.readdirSync(b.dirname(c)),k=b.basename(c);S.forEach(f=>{if(f.startsWith(k+".part"))try{C.unlinkSync(b.join(b.dirname(c),f))}catch{}})}catch{}return{verificationComplete:!0,targetPath:c,filePath:t.path}}}}else{let i=ae(t.path),l=`${n.replace(/\/$/,"")}/${i}`,p=0;for(;;){p+=1;let d=0,g=0,E=`${c}.download`,u=0;try{u=C.statSync(E).size}catch{}let v=Number(t.size||0);if(v>0&&u>v)try{C.unlinkSync(E),u=0}catch{}if(await J(l,E,(k,f)=>{let P=Math.max(0,k-g);g=k;try{P>0&&e("progress:bytes",{delta:P})}catch{}d+=P;let A=v||f||0;e("progress:file",{path:t.path,received:Math.min(k,A||k),total:A})},1,a,u,v),(await O(E)).toLowerCase()===String(t.checksum).toLowerCase())break;try{C.unlinkSync(E)}catch{}try{d>0&&e("progress:bytes",{delta:-d})}catch{}if(p>=2)throw new Error(`Checksum mismatch for ${t.path}`)}try{C.unlinkSync(c)}catch{}C.renameSync(`${c}.download`,c)}if(e("progress:verify",{path:t.path}),(await O(c)).toLowerCase()!==String(t.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${t.path}`);return{downloadComplete:!0,verificationComplete:!0,targetPath:c}}async function Le(n,t,r,e,o=!1,a=4,s=4,c,h){let i=new Set,l=[];for(let k of t.files||[]){if(!(o||!k.optional))continue;let f=Ce(k.path);f&&(i.has(f)||(i.add(f),l.push(k)))}let p=l.filter(k=>!(Array.isArray(k.parts)&&k.parts.length>0)),d=l.filter(k=>Array.isArray(k.parts)&&k.parts.length>0),g=p.concat(d),E=g.length,u=0,v=g.reduce((k,f)=>{let P=Number(f.size||0);return P>0?k+P:Array.isArray(f.parts)&&f.parts.length?k+f.parts.reduce((A,L)=>A+Number(L.size||0),0):k},0);try{e("progress:bytes:total",{totalBytes:v})}catch{}async function S(k,f,P,A=!1){let L=0,M=[];async function T(){for(;;){for(;h&&h();)if(await j(100),c?.cancelled)return;let N=L++;if(N>=k.length)return;let _=k[N],B=f+N,W=Ce(_.path),H=async()=>Je(n,_,r,e,s,c),ke=!1,Z=K.get(W);Z?ke=!0:(e("progress:start",{index:B,total:E,path:_.path,completed:u}),Z=(async()=>{try{let F=await H();if(A&&F?.mergeAndVerifyAsync){let ve=F.mergeAndVerifyAsync().then($=>($?.filePath&&(u+=1,e("progress:done",{index:B,total:E,path:$.filePath,completed:u})),$)).catch($=>{if(String($?.message||$||"error").includes("cancelled"))throw $;try{let U=b.join(r,_.path.replace(/\\/g,b.sep));try{C.unlinkSync(U)}catch{}try{let R=C.readdirSync(b.dirname(U)),z=b.basename(U);R.forEach(ee=>{if(ee.startsWith(z+".part"))try{C.unlinkSync(b.join(b.dirname(U),ee))}catch{}})}catch{}return H().then(R=>R.mergeAndVerifyAsync?R.mergeAndVerifyAsync().then(z=>(z?.filePath&&(u+=1,e("progress:done",{index:B,total:E,path:z.filePath,completed:u})),z)):R)}catch(U){try{e("progress:error",{path:_.path,message:String(U?.message||U)})}catch{}throw U}});return M.push(ve),{...F,skipProgressDone:!0}}return F}catch(F){if(String(F?.message||F||"error").includes("cancelled"))throw F;try{let $=b.join(r,_.path.replace(/\\/g,b.sep));try{C.unlinkSync($)}catch{}let G=await H();if(A&&G?.mergeAndVerifyAsync){let U=G.mergeAndVerifyAsync().then(R=>(R?.filePath&&(u+=1,e("progress:done",{index:B,total:E,path:R.filePath,completed:u})),R)).catch(R=>{try{let z=b.join(r,_.path.replace(/\\/g,b.sep)),ee=C.readdirSync(b.dirname(z)),ze=b.basename(z);ee.forEach(xe=>{if(xe.startsWith(ze+".part"))try{C.unlinkSync(b.join(b.dirname(z),xe))}catch{}})}catch{}try{e("progress:error",{path:_.path,message:String(R?.message||R)})}catch{}throw R});return M.push(U),{...G,skipProgressDone:!0}}return G}catch($){try{e("progress:error",{path:_.path,message:String($?.message||$)})}catch{}throw $}}})(),K.set(W,Z));let Ee;try{Ee=await Z}finally{ke||K.delete(W)}Ee?.skipProgressDone||(u+=1,e("progress:done",{index:B,total:E,path:_.path,completed:u})),await j(10)}}let I=Array.from({length:Math.max(1,P)},()=>T());await Promise.all(I),M.length>0&&await Promise.all(M)}if(await S(p,0,Math.max(1,a)),K.size>0)try{await Promise.all([...K.values()])}catch{}await S(d,p.length,1,!0)}import le from"node:fs";import Ge from"node:path";import{app as Ke}from"electron";var _e=Ke.getPath("userData"),Te=Ge.join(_e,"settings.json");function de(){try{let n=le.readFileSync(Te,"utf-8");return JSON.parse(n)}catch{return{}}}function Xe(n){le.mkdirSync(_e,{recursive:!0}),le.writeFileSync(Te,JSON.stringify(n,null,2),"utf-8")}function he(n,t=void 0){return de()[n]??t}function te(n,t){let r=de();r[n]=t,Xe(r)}function ue(){return de()}var Ue=Qe(import.meta.url),{autoUpdater:V}=Ue("electron-updater"),Re=Ue("electron-log"),tt=Ye(import.meta.url),X=m.dirname(tt);var w,q=null,pe=new Set,ne=new Map,oe=new Map,me="r5v",se=[];function Ve(n){try{return(n||[]).filter(t=>typeof t=="string"&&t.startsWith(`${me}://`))}catch{return[]}}function we(n){try{let t=new URL(n);if(t.hostname==="mod"&&t.pathname==="/install"){let r=t.searchParams.get("name")||"",e=t.searchParams.get("version")||"",o=t.searchParams.get("downloadUrl")?.split(",")||"";if(w&&w.webContents&&!w.webContents.isLoading())try{w.webContents.send("deeplink:mod-install",{url:n,name:r,version:e,downloadUrls:o})}catch{}else se.push(n)}}catch{}}function rt(){for(;se.length;){let n=se.shift();we(n)}}var nt=D.requestSingleInstanceLock();nt?D.on("second-instance",(n,t)=>{try{Ve(t).forEach(e=>we(e)),w&&(w.isMinimized()&&w.restore(),w.focus())}catch{}}):D.quit();D.on("open-url",(n,t)=>{n.preventDefault(),we(t)});async function Me(){let n=he("windowState",{width:1150,height:800,x:void 0,y:void 0,isMaximized:!1});w=new Ne({width:n.width,height:n.height,x:n.x,y:n.y,minWidth:1150,minHeight:800,frame:!1,titleBarStyle:"hidden",webPreferences:{preload:m.join(X,"preload.cjs"),contextIsolation:!0,nodeIntegration:!1},show:!1,icon:m.join(X,"..","public","icon.png")});let t=process.env.VITE_DEV_SERVER_URL;if(t)await w.loadURL(t);else{let s=m.join(X,"..","dist","index.html");await w.loadFile(s)}w.webContents.setWindowOpenHandler(({url:s})=>{try{fe.openExternal(s)}catch{}return{action:"deny"}}),w.webContents.on("will-navigate",(s,c)=>{let h=c.startsWith("file:"),i=!!process.env.VITE_DEV_SERVER_URL&&c.startsWith(String(process.env.VITE_DEV_SERVER_URL));if(!h&&!i){s.preventDefault();try{fe.openExternal(c)}catch{}}});let r=()=>{w&&(w.isVisible()||w.show(),w.isFocused()||w.focus())};n.isMaximized&&w.maximize(),w.once("ready-to-show",r),w.webContents.once("did-finish-load",r);let e=setTimeout(r,1e3);w.on("show",()=>clearTimeout(e));function o(){if(!w)return;let s=w.getBounds(),c=w.isMaximized();te("windowState",{width:s.width,height:s.height,x:s.x,y:s.y,isMaximized:c})}w.on("resize",o),w.on("move",o),w.on("maximize",o),w.on("unmaximize",o),(!!process.env.VITE_DEV_SERVER_URL||process.env.NODE_ENV==="development")&&w.webContents.openDevTools({mode:"detach"}),w.webContents.on("did-fail-load",(s,c,h,i)=>{console.error("Load failed",{errorCode:c,errorDesc:h,validatedURL:i}),ge.showErrorBox("Load failed",`${h} (code ${c})
URL: ${i}`),w.show()})}D.on("window-all-closed",()=>{process.platform!=="darwin"&&D.quit()});D.whenReady().then(()=>{try{process.defaultApp&&process.platform==="win32"?D.setAsDefaultProtocolClient(me,process.execPath,[process.argv[1]]):D.setAsDefaultProtocolClient(me)}catch{}let n=m.resolve(D.getAppPath(),".."),t=m.join(n,"cache");$e.registerFileProtocol("r5v",(e,o)=>{try{let a=new URL(e.url),s=decodeURIComponent(a.pathname).replace(/^\//,""),c=m.normalize(m.join(t,s));o({path:c})}catch{o({error:-6})}});let r=m.join(X,"..","dist");$e.interceptFileProtocol("file",(e,o)=>{try{let a=new URL(e.url),s=decodeURIComponent(a.pathname),c=s.replace(/\\/g,"/"),h=c.indexOf("/_astro/");if(h!==-1){let i=c.substring(h+8),l=m.join(r,"_astro",i);return o({path:l})}if(c.endsWith("/favicon.svg")||/\/favicon\.svg$/i.test(c)){let i=m.join(r,"favicon.svg");return o({path:i})}if(c.startsWith("/")){let i=c.replace(/^\/+/,""),l=m.join(r,i);try{return y.accessSync(l),o({path:l})}catch{}}return o({path:s})}catch{return o({error:-6})}}),Me();try{Ve(process.argv).forEach(e=>se.push(e))}catch{}try{w?.webContents?.once("did-finish-load",rt)}catch{}try{V.autoDownload=!1;try{V.logger=Re,Re.transports.file.level="info"}catch{}V.on("error",e=>{try{w?.webContents.send("update:error",{message:String(e?.stack||e?.message||e)})}catch{}}),V.on("update-available",e=>{try{w?.webContents.send("update:available",e)}catch{}}),V.on("update-not-available",e=>{try{w?.webContents.send("update:not-available",e)}catch{}}),V.on("download-progress",e=>{try{w?.webContents.send("update:download-progress",e)}catch{}}),V.on("update-downloaded",e=>{try{w?.webContents.send("update:downloaded",e)}catch{}})}catch{}D.on("activate",()=>{Ne.getAllWindows().length===0&&Me()})});x.handle("update:check",async()=>{try{return{ok:!0,result:(await V.checkForUpdates())?.updateInfo||null}}catch(n){return{ok:!1,error:String(n?.message||n)}}});x.handle("update:download",async()=>{try{return await V.downloadUpdate(),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});x.handle("update:quitAndInstall",async()=>{try{return setImmediate(()=>V.quitAndInstall(!1,!0)),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});x.handle("app:getVersion",async()=>{try{return D.getVersion()}catch{return"0.0.0"}});x.handle("app:getBaseDir",async()=>{try{return m.resolve(D.getAppPath(),"..")}catch{return""}});x.handle("app:getLauncherInstallRoot",async()=>{try{let n=process.env.LOCALAPPDATA||m.join(D.getPath("home"),"AppData","Local");return m.join(n,"Programs","r5vlauncher")}catch{return""}});function ot(n){try{let t=m.join(n,"mods.vdf"),r=y.readFileSync(t,"utf-8"),e={},o=/"([^"]+)"\s*"([01])"/g,a;for(;a=o.exec(r);){let s=a[1];s&&s!=="ModList"&&(e[s]=a[2]==="1")}return e}catch{return{}}}function Se(n){try{let t=m.join(n,"mods.vdf"),r=y.readFileSync(t,"utf-8"),e={},o=[],a=/"([^"]+)"\s*"([01])"/g,s;for(;s=a.exec(r);){let c=s[1];!c||c==="ModList"||(c in e||o.push(c),e[c]=s[2]==="1")}return{map:e,order:o}}catch{return{map:{},order:[]}}}function ye(n){try{let t=y.readFileSync(n,"utf-8"),r=t.match(/"id"\s*"([^"]+)"/i),e=t.match(/"name"\s*"([^"]+)"/i),o=r?r[1]:null,a=e?e[1]:null;return{id:o,name:a}}catch{return{id:null,name:null}}}function st(n,t){let r=['"ModList"',"{"];for(let[e,o]of Object.entries(t))r.push(`	"${e}"		"${o?"1":"0"}"`);r.push("}"),y.mkdirSync(n,{recursive:!0}),y.writeFileSync(m.join(n,"mods.vdf"),r.join(`
`),"utf-8")}function Ie(n,t,r){let e=new Set,o=['"ModList"',"{"],a=s=>{o.push(`	"${s}"		"${r[s]?"1":"0"}"`),e.add(s)};for(let s of Array.isArray(t)?t:[])Object.prototype.hasOwnProperty.call(r,s)&&!e.has(s)&&a(s);for(let s of Object.keys(r))e.has(s)||a(s);o.push("}"),y.mkdirSync(n,{recursive:!0}),y.writeFileSync(m.join(n,"mods.vdf"),o.join(`
`),"utf-8")}x.handle("mods:listInstalled",async(n,{installDir:t})=>{try{let r=m.join(t,"mods"),{map:e,order:o}=Se(r),a=[],s=y.existsSync(r)?y.readdirSync(r,{withFileTypes:!0}):[];for(let h of s){if(!h.isDirectory())continue;let i=m.join(r,h.name),l=m.join(i,"manifest.json"),p=m.join(i,"mod.vdf"),d=m.join(i,"icon.png"),g=null;try{g=JSON.parse(y.readFileSync(l,"utf-8"))}catch{}let E=ye(p),u=E.id||g?.name||h.name,v=null;try{v=`data:image/png;base64,${y.readFileSync(d).toString("base64")}`}catch{}a.push({id:u,name:g?.name||E.name||h.name,folder:h.name,version:g?.version_number||null,description:g?.description||"",enabled:u?!!e[u]:!1,hasManifest:y.existsSync(l),iconDataUrl:v})}let c=new Map(o.map((h,i)=>[h,i]));return a.sort((h,i)=>{let l=h.id!=null&&c.has(h.id)?c.get(h.id):Number.MAX_SAFE_INTEGER,p=i.id!=null&&c.has(i.id)?c.get(i.id):Number.MAX_SAFE_INTEGER;return l!==p?l-p:String(h.name||"").localeCompare(String(i.name||""))}),{ok:!0,mods:a}}catch(r){return{ok:!1,error:String(r?.message||r)}}});x.handle("mods:setEnabled",async(n,{installDir:t,name:r,enabled:e})=>{try{let o=m.join(t,"mods"),{map:a}=Se(o);return a[r]=!!e,Ie(o,void 0,a),{ok:!0}}catch(o){return{ok:!1,error:String(o?.message||o)}}});x.handle("mods:reorder",async(n,{installDir:t,orderIds:r})=>{try{let e=m.join(t,"mods"),{map:o,order:a}=Se(e),s=Array.isArray(r)?r.filter(l=>typeof l=="string"&&l&&Object.prototype.hasOwnProperty.call(o,l)):[],c=new Set(s),h=a.filter(l=>Object.prototype.hasOwnProperty.call(o,l)&&!c.has(l)),i=[...s,...h];return Ie(e,i,o),{ok:!0}}catch(e){return{ok:!1,error:String(e?.message||e)}}});x.handle("mods:uninstall",async(n,{installDir:t,folder:r})=>{try{let e=m.join(t,"mods"),o=m.join(e,r);return y.rmSync(o,{recursive:!0,force:!0}),{ok:!0}}catch(e){return{ok:!1,error:String(e?.message||e)}}});x.handle("mods:fetchAll",async(n,{query:t})=>{let r="https://thunderstore.io/c/r5valkyrie/api/v1/package-listing-index/",e=a=>new Promise((s,c)=>{Y.get(a,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"*/*"}},i=>{if(i.statusCode&&i.statusCode>=300&&i.statusCode<400&&i.headers.location){i.resume();let p=i.headers.location.startsWith("http")?i.headers.location:new URL(i.headers.location,a).toString();return s(e(p))}if(i.statusCode!==200)return i.resume(),c(new Error(`HTTP ${i.statusCode}`));let l=[];i.on("data",p=>l.push(Buffer.isBuffer(p)?p:Buffer.from(p))),i.on("end",()=>s(Buffer.concat(l)))}).on("error",c)}),o=a=>{try{return Ze.gunzipSync(a)}catch{return a}};try{let a=await e(r),s=JSON.parse(o(a).toString("utf8")),c=Array.isArray(s)?s:[],h=6,i=[],l=0;await Promise.all(Array.from({length:h}).map(async()=>{for(;l<c.length;){let d=l++,g=c[d];try{let E=await e(g),u=o(E).toString("utf8"),v=JSON.parse(u);Array.isArray(v)&&i.push(...v)}catch{}}}));let p=i;if(t&&String(t).trim()){let d=String(t).toLowerCase();p=p.filter(g=>String(g?.name||"").toLowerCase().includes(d)||String(g?.full_name||"").toLowerCase().includes(d))}return{ok:!0,mods:p}}catch(a){try{let c=await e("https://thunderstore.io/c/r5valkyrie/api/v1/package/"),h=JSON.parse(c.toString("utf8")),i=Array.isArray(h)?h:[];if(t&&String(t).trim()){let l=String(t).toLowerCase();i=i.filter(p=>String(p?.name||"").toLowerCase().includes(l)||String(p?.full_name||"").toLowerCase().includes(l))}return{ok:!0,mods:i}}catch(s){return{ok:!1,error:String(s?.message||a?.message||s||a)}}}});x.handle("mods:install",async(n,{installDir:t,name:r,downloadUrl:e})=>{if(!e.startsWith("https://thunderstore.io"))return{ok:!1,error:"Download URL does not point to Thunderstore"};try{let o=String(r||"").trim();if(!o)return{ok:!1,error:"Invalid mod name"};if(pe.has(o))return{ok:!0};pe.add(o);let a=m.join(t,"mods");y.mkdirSync(a,{recursive:!0});let s=m.join(a,`.__mod_${Date.now()}.zip`),c=(p,d=0)=>new Promise((g,E)=>{if(d>5)return E(new Error("Too many redirects"));let u=y.createWriteStream(s);Y.get(p,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"application/octet-stream,*/*;q=0.8",Referer:"https://thunderstore.io/",Connection:"keep-alive"}},S=>{if(S.statusCode&&S.statusCode>=300&&S.statusCode<400&&S.headers.location){S.resume(),u.close(()=>{});try{y.unlinkSync(s)}catch{}let L=S.headers.location.startsWith("http")?S.headers.location:new URL(S.headers.location,p).toString();return g(c(L,d+1))}if(S.statusCode!==200){u.close(()=>{});try{y.unlinkSync(s)}catch{}return S.resume(),E(new Error(`HTTP ${S.statusCode}`))}let k=Number(S.headers["content-length"]||0),f=0,P=Date.now(),A=L=>{try{n?.sender?.send("mods:progress",{key:r,phase:L,received:f,total:k})}catch{}};S.on("data",L=>{f+=Buffer.isBuffer(L)?L.length:Buffer.byteLength(String(L));let M=Date.now();M-P>150&&(P=M,A("downloading"))}),S.pipe(u),u.on("finish",()=>{A("downloading"),u.close(g)})}).on("error",S=>{try{y.unlinkSync(s)}catch{}E(S)})});await c(e);try{n?.sender?.send("mods:progress",{key:r,phase:"extracting"})}catch{}let h=m.join(a,r);try{y.rmSync(h,{recursive:!0,force:!0})}catch{}y.mkdirSync(h,{recursive:!0}),await new Promise((p,d)=>{let g=re("powershell.exe",["-NoProfile","-NonInteractive","-Command",`Expand-Archive -LiteralPath "${s}" -DestinationPath "${h}" -Force`],{stdio:"ignore"});g.on("exit",E=>E===0?p():d(new Error(`Expand-Archive failed ${E}`))),g.on("error",d)});try{y.unlinkSync(s)}catch{}let i=null;try{let p=m.join(h,"mod.vdf");if(y.existsSync(p))i=ye(p).id;else{let d=y.readdirSync(h,{withFileTypes:!0});for(let g of d)if(g.isDirectory()){let E=m.join(h,g.name,"mod.vdf");if(y.existsSync(E)&&(i=ye(E).id,i))break}}}catch{}let l=ot(a);l[i||r]=!0,st(a,l);try{n?.sender?.send("mods:progress",{key:r,phase:"done"})}catch{}return{ok:!0}}catch(o){return{ok:!1,error:String(o?.message||o)}}finally{try{pe.delete(String(r||""))}catch{}}});x.handle("mods:watch",async(n,{installDir:t})=>{try{let r=m.join(t,"mods");if(!y.existsSync(r))return{ok:!0};let e=r;if(ne.has(e))return{ok:!0};let o=y.watch(r,{persistent:!0},(a,s)=>{let c=e;clearTimeout(oe.get(c));let h=setTimeout(()=>{try{w?.webContents?.send("mods:changed",{installDir:t})}catch{}},300);oe.set(c,h)});return ne.set(e,o),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});x.handle("mods:unwatch",async(n,{installDir:t})=>{try{let e=m.join(t,"mods"),o=ne.get(e);if(o){try{o.close()}catch{}ne.delete(e)}let a=oe.get(e);return a&&(clearTimeout(a),oe.delete(e)),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});x.handle("mods:iconDataUrl",async(n,{installDir:t,folder:r})=>{try{let e=m.join(t,"mods",r,"icon.png");return await y.promises.access(e),{ok:!0,dataUrl:`data:image/png;base64,${(await y.promises.readFile(e)).toString("base64")}`}}catch(e){return{ok:!1,error:String(e?.message||e)}}});x.handle("select-directory",async()=>{let n=await ge.showOpenDialog({properties:["openDirectory","createDirectory"]});return n.canceled||n.filePaths.length===0?null:n.filePaths[0]});x.handle("settings:get",()=>ue());x.handle("settings:set",(n,{key:t,value:r})=>te(t,r));x.handle("download:checksums",async(n,{baseUrl:t})=>De(t));x.handle("download:all",async(n,{baseUrl:t,checksums:r,installDir:e,includeOptional:o,concurrency:a,partConcurrency:s,channelName:c,mode:h})=>{let i=(l,p)=>n.sender.send(l,p);try{if(!(String(h||"install").toLowerCase()==="install")){let p=m.join(e,"mods","mods.vdf");if(y.existsSync(p)){let g=(Array.isArray(r?.files)?r.files:[]).filter(E=>{try{return String(E?.path||E?.name||"").replace(/\\/g,"/").toLowerCase()!=="mods/mods.vdf"}catch{return!0}});r={...r||{},files:g}}}}catch{}q=be(),Q=!1;try{await Le(t,r,e,i,!!o,Number(a)||4,Number(s)||4,q,()=>Q);try{let l=he("channels",{})||{};l[String(c||"default")]={installDir:e,gameVersion:r?.game_version||null,gameBaseUrl:t,lastUpdatedAt:Date.now()},te("channels",l)}catch(l){console.error("Failed to persist channel info",l)}}finally{q=null}return!0});x.handle("default-install-dir",(n,{channelName:t})=>{let r=process.env.LOCALAPPDATA||m.join(D.getPath("home"),"AppData","Local"),e=m.join(r,"Programs","R5VLibrary");return t?m.join(e,t):e});x.handle("scan-custom-channels",async(n,{officialChannelNames:t})=>{try{let r=process.env.LOCALAPPDATA||m.join(D.getPath("home"),"AppData","Local"),e=m.join(r,"Programs","R5VLibrary");try{await y.promises.access(e)}catch{return[]}let o=await y.promises.readdir(e,{withFileTypes:!0}),a=[],s=new Set((t||[]).map(c=>c.toLowerCase()));for(let c of o){if(!c.isDirectory())continue;let h=c.name,i=m.join(e,h);if(s.has(h.toLowerCase()))continue;let l=!1;try{await y.promises.access(m.join(i,"r5apex.exe")),l=!0}catch{try{await y.promises.access(m.join(i,"r5apex_ds.exe")),l=!0}catch{}}l&&a.push({name:h,installDir:i,isCustom:!0})}return a}catch(r){return console.error("Error scanning for custom channels:",r),[]}});x.handle("open-folder",async(n,{folderPath:t})=>{try{if(!t)return{ok:!1,error:"No folder path provided"};try{await y.promises.access(t)}catch{return{ok:!1,error:"Folder does not exist"}}return await fe.openPath(t),{ok:!0}}catch(r){return console.error("Error opening folder:",r),{ok:!1,error:String(r)}}});x.handle("launcher:config",async(n,{url:t})=>(e=>new Promise((o,a)=>{Y.get(e,s=>{if(s.statusCode!==200){a(new Error(`HTTP ${s.statusCode} for ${e}`)),s.resume();return}let c="";s.setEncoding("utf8"),s.on("data",h=>c+=h),s.on("end",()=>{try{o(JSON.parse(c))}catch(h){a(h)}})}).on("error",a)}))(t));x.handle("eula:get",async()=>{let n="https://playvalkyrie.org/api/eula",t=r=>new Promise((e,o)=>{Y.get(r,a=>{if(a.statusCode!==200){o(new Error(`HTTP ${a.statusCode}`)),a.resume();return}let s=[];a.on("data",c=>s.push(Buffer.isBuffer(c)?c:Buffer.from(c))),a.on("end",()=>{try{let c=Buffer.concat(s).toString("utf8");e(JSON.parse(c))}catch(c){o(c)}})}).on("error",o)});try{return{ok:!0,json:await t(n)}}catch(r){return{ok:!1,error:String(r?.message||r)}}});x.handle("video:cache",async(n,{filename:t})=>{try{let e=`https://blaze.playvalkyrie.org/video_backgrounds/${t}`,o=m.join(m.resolve(D.getAppPath(),".."),"cache"),a=m.join(o,"videos"),s=m.join(a,t),c=m.join(X,"..","dist"),h=m.join(c,t);await y.promises.mkdir(a,{recursive:!0});try{if((await y.promises.stat(s)).size>0){try{await y.promises.access(h)}catch{await y.promises.copyFile(s,h)}return`./${t}`}else await y.promises.unlink(s)}catch{}return await new Promise((i,l)=>{let p=y.createWriteStream(s),d=Y.get(e,g=>{if(g.statusCode!==200){p.close(()=>{}),y.unlink(s,()=>{}),l(new Error(`HTTP ${g.statusCode} for video ${t}`)),g.resume();return}g.pipe(p),p.on("finish",()=>p.close(i)),p.on("error",E=>{y.unlink(s,()=>l(E))})});d.on("error",g=>{p.close(()=>{}),y.unlink(s,()=>{}),l(g)}),d.setTimeout(3e4,()=>{d.destroy(),p.close(()=>{}),y.unlink(s,()=>{}),l(new Error(`Video download timeout for ${t}`))})}),await y.promises.copyFile(s,h),`./${t}`}catch(r){throw console.error(`Video cache error for ${t}:`,r),r}});x.handle("fs:is-installed-in-dir",async(n,{path:t})=>{let r=!1,e=!1;try{await y.promises.access(m.join(t,"r5apex.exe")),r=!0}catch{}try{await y.promises.access(m.join(t,"r5apex_ds.exe")),e=!0}catch{}return r||e});var Q=!1;x.handle("download:pause",async()=>{Q=!0;try{w?.webContents.send("progress:paused",{})}catch{}return!0});x.handle("download:resume",async()=>{Q=!1;try{w?.webContents.send("progress:resumed",{})}catch{}return!0});x.handle("download:cancel",async()=>{try{ie(q)}catch{}q=null,Q=!1;try{w?.webContents.send("progress:cancelled",{})}catch{}return!0});x.handle("select-file",async(n,{filters:t})=>{let r=await ge.showOpenDialog({properties:["openFile"],filters:Array.isArray(t)?t:void 0});return r.canceled||r.filePaths.length===0?null:r.filePaths[0]});x.handle("game:launch",async(n,{channelName:t,installDir:r,mode:e,argsString:o})=>{try{if(!r)throw new Error("Missing installDir");let a=String(e).toUpperCase()==="SERVER"?"r5apex_ds.exe":"r5apex.exe",s=m.join(r,a);await y.promises.access(s).catch(()=>{throw new Error(`Executable not found: ${s}`)});let h=(l=>!l||typeof l!="string"?[]:(l.match(/(?:[^\s\"]+|\"[^\"]*\")+/g)||[]).map(d=>d.replace(/^\"|\"$/g,"")))(o);return re(s,h,{cwd:r,detached:!0,stdio:"ignore",env:{...process.env}}).unref(),{ok:!0}}catch(a){return{ok:!1,error:String(a?.message||a)}}});x.handle("fix-folder-permissions",async(n,{selectedChannel:t})=>{let r=[],e=ue().channels[t].installDir;try{if(!e)return{ok:!1,error:"No folder path provided"};let o=m.resolve(e).replace(/\//g,"\\");if(!o||o.length<3)return{ok:!1,error:`Invalid path format: ${e}`};let a=o.length>=3&&o[1]===":"?o.slice(3):o;if(/[<>:"|?*]/.test(a))return{ok:!1,error:`Path contains invalid characters: ${o}`};let h=et.userInfo().username,i=m.join(process.resourcesPath,"elevate.exe"),l=y.existsSync(i);try{y.mkdirSync(o,{recursive:!0})}catch{}let p=[{exe:"icacls",args:[o,"/grant",`${h}:F`,"/t","/q"],desc:`Grant permissions to current user (${h})`},{exe:"icacls",args:[o,"/grant","Everyone:F","/t","/q"],desc:"Grant Everyone full permissions"},{exe:"icacls",args:[o,"/grant","Users:F","/t","/q"],desc:"Grant Users full permissions"}];for(let d=0;d<p.length;d++){let{exe:g,args:E,desc:u}=p[d];try{let v=await new Promise((S,k)=>{let f,P,A;l?(P=[i,["-wait",g,...E]],A={stdio:["ignore","pipe","pipe"],windowsHide:!0}):(P=[g,E],A={stdio:["ignore","pipe","pipe"],windowsHide:!0});try{f=re(P[0],P[1],A)}catch(T){console.error("[Permission Fix] Spawn failed:",T),k(T);return}let L="",M="";f.stdout&&f.stdout.on("data",T=>{L+=T.toString()}),f.stderr&&f.stderr.on("data",T=>{M+=T.toString()}),f.on("exit",(T,I)=>{S({code:T,stdout:L,stderr:M,signal:I})}),f.on("error",T=>{k(T)}),setTimeout(()=>{try{f.kill()}catch{}k(new Error("Command timeout"))},3e4)});if(v.code!==0){let S=v.stderr||v.stdout||"Unknown error";if(!(S.includes("duplicate")||S.includes("already")||v.code===1332)){let f=`${u} failed (code ${v.code}): ${S}`;r.push(f)}}}catch(v){let S=`${u} error: ${v.message}`;r.push(S)}}try{let d=m.join(o,"test_write.tmp");y.writeFileSync(d,"test"),y.unlinkSync(d)}catch(d){let g=`Write test failed: ${d.message}`;r.push(g);try{if(y.mkdirSync(o,{recursive:!0}),(await new Promise(u=>{let v=re("cmd",["/c",`icacls "${o}" /grant "%USERNAME%":F /q`],{stdio:"ignore",windowsHide:!0});v.on("exit",S=>u({code:S})),v.on("error",()=>u({code:1})),setTimeout(()=>{try{v.kill()}catch{}u({code:1})},5e3)})).code===0){let u=m.join(o,"test_write2.tmp");return y.writeFileSync(u,"test"),y.unlinkSync(u),{ok:!0,warnings:r}}}catch{}return{ok:!1,error:g,details:r}}return r.length>0?{ok:!0,warnings:r}:{ok:!0}}catch(o){let a=`Unexpected error: ${o?.message||o}`;return r.push(a),{ok:!1,error:a,details:r}}});x.on("window:minimize",()=>{w?.minimize()});x.on("window:maximize",()=>{w&&(w.isMaximized()?w.unmaximize():w.maximize())});x.on("window:close",()=>{w?.close()});D.on("before-quit",()=>{if(q)try{ie(q)}catch{}});
