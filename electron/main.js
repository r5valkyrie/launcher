import{app as b,BrowserWindow as Ie,ipcMain as P,dialog as Se,protocol as Ne,shell as ye}from"electron";import{createRequire as et}from"node:module";import p from"node:path";import{fileURLToPath as tt,pathToFileURL as Pt}from"node:url";import Y from"node:https";import m from"node:fs";import rt from"node:zlib";import{spawn as re}from"node:child_process";import nt from"node:os";import A from"node:fs";import D from"node:path";import We from"node:crypto";import{pipeline as qe}from"node:stream";import{promisify as He}from"node:util";import le from"node:https";var Oe=He(qe);function ae(n){return String(n||"").replace(/\\/g,"/").replace(/^\/+/,"")}function Ae(n){return String(n||"").replace(/\\/g,"/").toLowerCase()}var K=new Map,De=new le.Agent({keepAlive:!0,maxSockets:64,maxFreeSockets:32,keepAliveMsecs:6e4,scheduling:"fifo"}),ie=class{constructor(){this.maxBytesPerSecond=0,this.tokens=0,this.lastRefill=Date.now()}setMaxSpeed(e){this.maxBytesPerSecond=Math.max(0,e),this.tokens=this.maxBytesPerSecond}isEnabled(){return this.maxBytesPerSecond>0}async consumeTokens(e){if(this.maxBytesPerSecond<=0)return;let r=Date.now(),t=(r-this.lastRefill)/1e3;if(this.tokens=Math.min(this.maxBytesPerSecond,this.tokens+t*this.maxBytesPerSecond),this.lastRefill=r,e>this.tokens){let o=(e-this.tokens)/this.maxBytesPerSecond*1e3;await B(o),this.tokens=0}else this.tokens-=e}},ce=new ie;function be(n){ce.setMaxSpeed(n)}function O(n){return new Promise((e,r)=>{let t=We.createHash("sha256"),s=A.createReadStream(n);s.on("error",r),s.on("end",()=>e(t.digest("hex"))),s.on("data",o=>t.update(o))})}function Le(n){A.mkdirSync(n,{recursive:!0})}function Je(n){return new Promise((e,r)=>{let t=le.get(n,{agent:De},s=>{if(s.statusCode!==200){r(new Error(`HTTP ${s.statusCode} for ${n}`)),s.resume();return}let o="";s.setEncoding("utf8"),s.on("data",a=>o+=a),s.on("end",()=>{try{e(JSON.parse(o))}catch(a){r(a)}})});t.on("error",r),t.setTimeout(3e4,()=>{t.destroy(),r(new Error("JSON fetch timeout"))})})}function B(n){return new Promise(e=>setTimeout(e,n))}function _e(){return{cancelled:!1,requests:new Set}}function de(n){if(n){n.cancelled=!0;for(let e of n.requests)try{e.destroy(new Error("cancelled"))}catch{}n.requests.clear()}}var Ge=new Set(["ECONNRESET","ETIMEDOUT","EAI_AGAIN","ECONNABORTED","ENETRESET","EHOSTUNREACH","ENETUNREACH","EPIPE","ENOTFOUND","ECONNREFUSED","EHOSTDOWN","ENETDOWN"]);async function J(n,e,r,t=1,s,o=0,a=0){return new Promise((i,h)=>{Le(D.dirname(e));let c=A.createWriteStream(e,{flags:o>0?"a":"w"});if(s?.cancelled)return c.close(()=>{}),h(new Error("cancelled"));let d={agent:De};o>0&&(d.headers={Range:`bytes=${o}-`});let f=le.get(n,d,l=>{if(l.statusCode!==200&&!(o>0&&l.statusCode===206)){if(c.close(()=>{}),o>0&&l.statusCode===200){try{A.unlinkSync(e)}catch{}let v=Math.min(2e3*t,1e4);l.resume();try{f.destroy(new Error("restart:range-ignored"))}catch{}return B(v).then(()=>i(J(n,e,r,t+1,s,0,a)))}if(A.unlink(e,()=>{}),l.statusCode&&[429,500,502,503,504].includes(l.statusCode)&&t<5){let v=Math.min(2e3*t,1e4);return l.resume(),B(v).then(()=>i(J(n,e,r,t+1,s,o,a)))}h(new Error(`HTTP ${l.statusCode} for ${n}`)),l.resume();return}let g=Number(l.headers["content-length"]||0),k=a>0?a:o>0?o+g:g,u=0,E=Date.now(),S=Date.now(),x=t<=2?3e4:45e3,y=setInterval(()=>{if(!s?.cancelled&&Date.now()-S>x)try{let v=new Error("stalled");v.code="ETIMEDOUT",f.destroy(v)}catch{}},1e4);l.on("data",async v=>{S=Date.now(),u+=v.length,E=Date.now(),r&&r(Math.min(o+u,k||o+u),k||0),ce.isEnabled()&&(l.pause(),await ce.consumeTokens(v.length),l.resume())}),l.on("aborted",async()=>{let v=new Promise(C=>c.close(()=>C()));try{clearInterval(y)}catch{}try{await v}catch{}if(t<5){let C=Math.min(2e3*t,1e4);return B(C).then(()=>i(J(n,e,r,t+1,s,o+u,a)))}h(new Error("response aborted"))}),Oe(l,c).then(()=>{try{clearInterval(y)}catch{}i()}).catch(v=>{try{clearInterval(y)}catch{}h(v)})});if(s?.requests.add(f),f.on("socket",l=>{try{l.setKeepAlive(!0,6e4),l.setNoDelay(!0),l.setRecvBufferSize&&l.setRecvBufferSize(64*1024),l.setSendBufferSize&&l.setSendBufferSize(64*1024)}catch{}}),f.on("close",()=>s?.requests.delete(f)),f.setTimeout(9e4,()=>{try{let l=new Error("Request timeout");l.code="ETIMEDOUT",f.destroy(l)}catch{}}),s?.cancelled)try{f.destroy(new Error("cancelled"))}catch{}f.on("error",async l=>{let g=l?.code,k=t<8&&g&&Ge.has(String(g)),u=new Promise(E=>{try{c.close(()=>E())}catch{E()}});try{await u}catch{}if(k){let E=Math.min(1e3*Math.pow(1.5,t),15e3),S=Math.random()*1e3,x=E+S,y=o;try{y=A.statSync(e).size}catch{}return B(x).then(()=>i(J(n,e,r,t+1,s,y,a)))}h(l)})})}async function Ke(n,e,r){try{let t=A.statSync(n);return r&&Number(r)>0&&t.size!==Number(r)?!1:(await O(n)).toLowerCase()===String(e).toLowerCase()}catch{return!1}}async function Te(n){let e=`${n.replace(/\/$/,"")}/checksums.json`;return Je(e)}async function Xe(n,e,r,t,s=4,o){let a=ae(e.path).split("/").join(D.sep),i=D.join(r,a);if(Le(D.dirname(i)),await Ke(i,e.checksum,e.size))return t("progress:skip",{path:e.path}),{downloadComplete:!0,verificationComplete:!0,targetPath:i};if(o?.cancelled)throw new Error("cancelled");if(Array.isArray(e.parts)&&e.parts.length>0){let c=e.parts.length,d=new Array(c),f=0,l=new Set;async function g(){for(;;){let u=f++;if(u>=c)return;if(l.has(u))continue;l.add(u);let E=e.parts[u],S=ae(E.path),x=`${n.replace(/\/$/,"")}/${S}`,y=`${i}.part${u}`;try{if(A.existsSync(y))if((await O(y)).toLowerCase()===String(E.checksum).toLowerCase()){t("progress:part",{path:e.path,part:u,totalParts:c,received:Number(E.size||0),total:Number(E.size||0)}),d[u]=y;continue}else try{A.unlinkSync(y)}catch{}}catch{}let v=0;for(;;){if(o?.cancelled)throw new Error("cancelled");v+=1;let C=0,L=0;try{let I=0;try{I=A.statSync(y).size}catch{}let N=Number(E.size||0);if(N>0&&I>N)try{A.unlinkSync(y),I=0}catch{}await J(x,y,(_,j)=>{let W=Math.max(0,_-L);L=_;try{W>0&&t("progress:bytes",{delta:W})}catch{}C+=W;let H=N||j||0;t("progress:part",{path:e.path,part:u,totalParts:c,received:Math.min(_,H||_),total:H})},1,o,I,N)}catch{try{A.unlinkSync(y)}catch{}try{C>0&&t("progress:bytes",{delta:-C})}catch{}try{t("progress:part:reset",{path:e.path,part:u,totalParts:c})}catch{}let N=Math.min(2e3*v,1e4);await B(N);continue}if((await O(y)).toLowerCase()===String(E.checksum).toLowerCase())break;try{A.unlinkSync(y)}catch{}try{C>0&&t("progress:bytes",{delta:-C})}catch{}try{t("progress:part:reset",{path:e.path,part:u,totalParts:c})}catch{}let T=Math.min(2e3*v,1e4);await B(T)}d[u]=y}}let k=Array.from({length:Math.max(1,s)},()=>g());return await Promise.all(k),{downloadComplete:!0,verificationComplete:!1,targetPath:i,mergeAndVerifyAsync:async()=>{t("progress:merge:start",{path:e.path,parts:d.length});let u=A.createWriteStream(i);for(let S=0;S<d.length;S++){let x=d[S];t("progress:merge:part",{path:e.path,part:S,totalParts:d.length}),await new Promise((y,v)=>{let C=A.createReadStream(x);C.on("error",v),u.on("error",v),C.on("end",()=>{try{A.unlinkSync(x)}catch{}y()}),C.pipe(u,{end:!1})})}await new Promise((S,x)=>{u.on("error",x),u.on("finish",S),u.end()});try{t("progress:merge:done",{path:e.path})}catch{}if(t("progress:verify",{path:e.path}),(await O(i)).toLowerCase()!==String(e.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${e.path}`);try{let S=A.readdirSync(D.dirname(i)),x=D.basename(i);S.forEach(y=>{if(y.startsWith(x+".part"))try{A.unlinkSync(D.join(D.dirname(i),y))}catch{}})}catch{}return{verificationComplete:!0,targetPath:i,filePath:e.path}}}}else{let c=ae(e.path),d=`${n.replace(/\/$/,"")}/${c}`,f=0;for(;;){f+=1;let l=0,g=0,k=`${i}.download`,u=0;try{u=A.statSync(k).size}catch{}let E=Number(e.size||0);if(E>0&&u>E)try{A.unlinkSync(k),u=0}catch{}if(await J(d,k,(x,y)=>{let v=Math.max(0,x-g);g=x;try{v>0&&t("progress:bytes",{delta:v})}catch{}l+=v;let C=E||y||0;t("progress:file",{path:e.path,received:Math.min(x,C||x),total:C})},1,o,u,E),(await O(k)).toLowerCase()===String(e.checksum).toLowerCase())break;try{A.unlinkSync(k)}catch{}try{l>0&&t("progress:bytes",{delta:-l})}catch{}if(f>=2)throw new Error(`Checksum mismatch for ${e.path}`)}try{A.unlinkSync(i)}catch{}A.renameSync(`${i}.download`,i)}if(t("progress:verify",{path:e.path}),(await O(i)).toLowerCase()!==String(e.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${e.path}`);return{downloadComplete:!0,verificationComplete:!0,targetPath:i}}async function Me(n,e,r,t,s=!1,o=4,a=4,i,h){let c=new Set,d=[];for(let x of e.files||[]){if(!(s||!x.optional))continue;let y=Ae(x.path);y&&(c.has(y)||(c.add(y),d.push(x)))}let f=d.filter(x=>!(Array.isArray(x.parts)&&x.parts.length>0)),l=d.filter(x=>Array.isArray(x.parts)&&x.parts.length>0),g=f.concat(l),k=g.length,u=0,E=g.reduce((x,y)=>{let v=Number(y.size||0);return v>0?x+v:Array.isArray(y.parts)&&y.parts.length?x+y.parts.reduce((C,L)=>C+Number(L.size||0),0):x},0);try{t("progress:bytes:total",{totalBytes:E})}catch{}async function S(x,y,v,C=!1){let L=0,$=[];async function T(){for(;;){for(;h&&h();)if(await B(100),i?.cancelled)return;let N=L++;if(N>=x.length)return;let _=x[N],j=y+N,W=Ae(_.path),H=async()=>Xe(n,_,r,t,a,i),Ee=!1,Z=K.get(W);Z?Ee=!0:(t("progress:start",{index:j,total:k,path:_.path,completed:u}),Z=(async()=>{try{let F=await H();if(C&&F?.mergeAndVerifyAsync){let Pe=F.mergeAndVerifyAsync().then(M=>(M?.filePath&&(u+=1,t("progress:done",{index:j,total:k,path:M.filePath,completed:u})),M)).catch(M=>{if(String(M?.message||M||"error").includes("cancelled"))throw M;try{let U=D.join(r,_.path.replace(/\\/g,D.sep));try{A.unlinkSync(U)}catch{}try{let R=A.readdirSync(D.dirname(U)),z=D.basename(U);R.forEach(ee=>{if(ee.startsWith(z+".part"))try{A.unlinkSync(D.join(D.dirname(U),ee))}catch{}})}catch{}return H().then(R=>R.mergeAndVerifyAsync?R.mergeAndVerifyAsync().then(z=>(z?.filePath&&(u+=1,t("progress:done",{index:j,total:k,path:z.filePath,completed:u})),z)):R)}catch(U){try{t("progress:error",{path:_.path,message:String(U?.message||U)})}catch{}throw U}});return $.push(Pe),{...F,skipProgressDone:!0}}return F}catch(F){if(String(F?.message||F||"error").includes("cancelled"))throw F;try{let M=D.join(r,_.path.replace(/\\/g,D.sep));try{A.unlinkSync(M)}catch{}let G=await H();if(C&&G?.mergeAndVerifyAsync){let U=G.mergeAndVerifyAsync().then(R=>(R?.filePath&&(u+=1,t("progress:done",{index:j,total:k,path:R.filePath,completed:u})),R)).catch(R=>{try{let z=D.join(r,_.path.replace(/\\/g,D.sep)),ee=A.readdirSync(D.dirname(z)),je=D.basename(z);ee.forEach(Ce=>{if(Ce.startsWith(je+".part"))try{A.unlinkSync(D.join(D.dirname(z),Ce))}catch{}})}catch{}try{t("progress:error",{path:_.path,message:String(R?.message||R)})}catch{}throw R});return $.push(U),{...G,skipProgressDone:!0}}return G}catch(M){try{t("progress:error",{path:_.path,message:String(M?.message||M)})}catch{}throw M}}})(),K.set(W,Z));let ve;try{ve=await Z}finally{Ee||K.delete(W)}ve?.skipProgressDone||(u+=1,t("progress:done",{index:j,total:k,path:_.path,completed:u})),await B(10)}}let I=Array.from({length:Math.max(1,v)},()=>T());await Promise.all(I),$.length>0&&await Promise.all($)}if(await S(f,0,Math.max(1,o)),K.size>0)try{await Promise.all([...K.values()])}catch{}await S(l,f.length,1,!0)}import he from"node:fs";import Qe from"node:path";import{app as Ye}from"electron";var Re=Ye.getPath("userData"),$e=Qe.join(Re,"settings.json");function ue(){try{let n=he.readFileSync($e,"utf-8");return JSON.parse(n)}catch{return{}}}function Ze(n){he.mkdirSync(Re,{recursive:!0}),he.writeFileSync($e,JSON.stringify(n,null,2),"utf-8")}function fe(n,e=void 0){return ue()[n]??e}function te(n,e){let r=ue();r[n]=e,Ze(r)}function pe(){return ue()}var ze=et(import.meta.url),{autoUpdater:V}=ze("electron-updater"),Ue=ze("electron-log"),st=tt(import.meta.url),X=p.dirname(st);var w,q=null,me=new Set,ne=new Map,se=new Map,ge="r5v",oe=[];function Be(n){try{return(n||[]).filter(e=>typeof e=="string"&&e.startsWith(`${ge}://`))}catch{return[]}}function ke(n){try{let e=new URL(n);if(e.hostname==="mod"&&e.pathname==="/install"){let r=e.searchParams.get("name")||"",t=e.searchParams.get("version")||"",s=e.searchParams.get("downloadUrl")?.split(",")||"";if(w&&w.webContents&&!w.webContents.isLoading())try{w.webContents.send("deeplink:mod-install",{url:n,name:r,version:t,downloadUrls:s})}catch{}else oe.push(n)}}catch{}}function ot(){for(;oe.length;){let n=oe.shift();ke(n)}}var at=b.requestSingleInstanceLock();at?b.on("second-instance",(n,e)=>{try{Be(e).forEach(t=>ke(t)),w&&(w.isMinimized()&&w.restore(),w.focus())}catch{}}):b.quit();b.on("open-url",(n,e)=>{n.preventDefault(),ke(e)});async function Ve(){let n=fe("windowState",{width:1150,height:800,x:void 0,y:void 0,isMaximized:!1});w=new Ie({width:n.width,height:n.height,x:n.x,y:n.y,minWidth:1150,minHeight:800,frame:!1,titleBarStyle:"hidden",webPreferences:{preload:p.join(X,"preload.cjs"),contextIsolation:!0,nodeIntegration:!1},show:!1,icon:p.join(X,"..","public","icon.png")});let e=process.env.VITE_DEV_SERVER_URL;if(e)await w.loadURL(e);else{let a=p.join(X,"..","dist","index.html");await w.loadFile(a)}w.webContents.setWindowOpenHandler(({url:a})=>{try{ye.openExternal(a)}catch{}return{action:"deny"}}),w.webContents.on("will-navigate",(a,i)=>{let h=i.startsWith("file:"),c=!!process.env.VITE_DEV_SERVER_URL&&i.startsWith(String(process.env.VITE_DEV_SERVER_URL));if(!h&&!c){a.preventDefault();try{ye.openExternal(i)}catch{}}});let r=()=>{w&&(w.isVisible()||w.show(),w.isFocused()||w.focus())};n.isMaximized&&w.maximize(),w.once("ready-to-show",r),w.webContents.once("did-finish-load",r);let t=setTimeout(r,1e3);w.on("show",()=>clearTimeout(t));function s(){if(!w)return;let a=w.getBounds(),i=w.isMaximized();te("windowState",{width:a.width,height:a.height,x:a.x,y:a.y,isMaximized:i})}w.on("resize",s),w.on("move",s),w.on("maximize",s),w.on("unmaximize",s),(!!process.env.VITE_DEV_SERVER_URL||process.env.NODE_ENV==="development")&&w.webContents.openDevTools({mode:"detach"}),w.webContents.on("did-fail-load",(a,i,h,c)=>{console.error("Load failed",{errorCode:i,errorDesc:h,validatedURL:c}),Se.showErrorBox("Load failed",`${h} (code ${i})
URL: ${c}`),w.show()})}b.on("window-all-closed",()=>{process.platform!=="darwin"&&b.quit()});b.whenReady().then(()=>{try{process.defaultApp&&process.platform==="win32"?b.setAsDefaultProtocolClient(ge,process.execPath,[process.argv[1]]):b.setAsDefaultProtocolClient(ge)}catch{}let n=p.resolve(b.getAppPath(),".."),e=p.join(n,"cache");Ne.registerFileProtocol("r5v",(t,s)=>{try{let o=new URL(t.url),a=decodeURIComponent(o.pathname).replace(/^\//,""),i=p.normalize(p.join(e,a));s({path:i})}catch{s({error:-6})}});let r=p.join(X,"..","dist");Ne.interceptFileProtocol("file",(t,s)=>{try{let o=new URL(t.url),a=decodeURIComponent(o.pathname),i=a.replace(/\\/g,"/"),h=i.indexOf("/_astro/");if(h!==-1){let c=i.substring(h+8),d=p.join(r,"_astro",c);return s({path:d})}if(i.endsWith("/favicon.svg")||/\/favicon\.svg$/i.test(i)){let c=p.join(r,"favicon.svg");return s({path:c})}if(i.startsWith("/")){let c=i.replace(/^\/+/,""),d=p.join(r,c);try{return m.accessSync(d),s({path:d})}catch{}}return s({path:a})}catch{return s({error:-6})}}),Ve();try{Be(process.argv).forEach(t=>oe.push(t))}catch{}try{w?.webContents?.once("did-finish-load",ot)}catch{}try{V.autoDownload=!1;try{V.logger=Ue,Ue.transports.file.level="info"}catch{}V.on("error",t=>{try{w?.webContents.send("update:error",{message:String(t?.stack||t?.message||t)})}catch{}}),V.on("update-available",t=>{try{w?.webContents.send("update:available",t)}catch{}}),V.on("update-not-available",t=>{try{w?.webContents.send("update:not-available",t)}catch{}}),V.on("download-progress",t=>{try{w?.webContents.send("update:download-progress",t)}catch{}}),V.on("update-downloaded",t=>{try{w?.webContents.send("update:downloaded",t)}catch{}})}catch{}b.on("activate",()=>{Ie.getAllWindows().length===0&&Ve()})});P.handle("update:check",async()=>{try{return{ok:!0,result:(await V.checkForUpdates())?.updateInfo||null}}catch(n){return{ok:!1,error:String(n?.message||n)}}});P.handle("update:download",async()=>{try{return await V.downloadUpdate(),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});P.handle("update:quitAndInstall",async()=>{try{return setImmediate(()=>V.quitAndInstall(!1,!0)),{ok:!0}}catch(n){return{ok:!1,error:String(n?.message||n)}}});P.handle("app:getVersion",async()=>{try{return b.getVersion()}catch{return"0.0.0"}});P.handle("app:getBaseDir",async()=>{try{return p.resolve(b.getAppPath(),"..")}catch{return""}});P.handle("app:getLauncherInstallRoot",async()=>{try{let n=process.env.LOCALAPPDATA||p.join(b.getPath("home"),"AppData","Local");return p.join(n,"Programs","r5vlauncher")}catch{return""}});function it(n){try{let e=p.join(n,"mods.vdf"),r=m.readFileSync(e,"utf-8"),t={},s=/"([^"]+)"\s*"([01])"/g,o;for(;o=s.exec(r);){let a=o[1];a&&a!=="ModList"&&(t[a]=o[2]==="1")}return t}catch{return{}}}function xe(n){try{let e=p.join(n,"mods.vdf"),r=m.readFileSync(e,"utf-8"),t={},s=[],o=/"([^"]+)"\s*"([01])"/g,a;for(;a=o.exec(r);){let i=a[1];!i||i==="ModList"||(i in t||s.push(i),t[i]=a[2]==="1")}return{map:t,order:s}}catch{return{map:{},order:[]}}}function we(n){try{let e=m.readFileSync(n,"utf-8"),r=e.match(/"id"\s*"([^"]+)"/i),t=e.match(/"name"\s*"([^"]+)"/i),s=r?r[1]:null,o=t?t[1]:null;return{id:s,name:o}}catch{return{id:null,name:null}}}function ct(n,e){let r=['"ModList"',"{"];for(let[t,s]of Object.entries(e))r.push(`	"${t}"		"${s?"1":"0"}"`);r.push("}"),m.mkdirSync(n,{recursive:!0}),m.writeFileSync(p.join(n,"mods.vdf"),r.join(`
`),"utf-8")}function Fe(n,e,r){let t=new Set,s=['"ModList"',"{"],o=a=>{s.push(`	"${a}"		"${r[a]?"1":"0"}"`),t.add(a)};for(let a of Array.isArray(e)?e:[])Object.prototype.hasOwnProperty.call(r,a)&&!t.has(a)&&o(a);for(let a of Object.keys(r))t.has(a)||o(a);s.push("}"),m.mkdirSync(n,{recursive:!0}),m.writeFileSync(p.join(n,"mods.vdf"),s.join(`
`),"utf-8")}P.handle("mods:listInstalled",async(n,{installDir:e})=>{try{let r=p.join(e,"mods"),{map:t,order:s}=xe(r),o=[],a=m.existsSync(r)?m.readdirSync(r,{withFileTypes:!0}):[];for(let h of a){if(!h.isDirectory())continue;let c=p.join(r,h.name),d=p.join(c,"manifest.json"),f=p.join(c,"mod.vdf"),l=p.join(c,"icon.png"),g=null;try{g=JSON.parse(m.readFileSync(d,"utf-8"))}catch{}let k=we(f),u=k.id||g?.name||h.name,E=null;try{E=`data:image/png;base64,${m.readFileSync(l).toString("base64")}`}catch{}o.push({id:u,name:g?.name||k.name||h.name,folder:h.name,version:g?.version_number||null,description:g?.description||"",enabled:u?!!t[u]:!1,hasManifest:m.existsSync(d),iconDataUrl:E})}let i=new Map(s.map((h,c)=>[h,c]));return o.sort((h,c)=>{let d=h.id!=null&&i.has(h.id)?i.get(h.id):Number.MAX_SAFE_INTEGER,f=c.id!=null&&i.has(c.id)?i.get(c.id):Number.MAX_SAFE_INTEGER;return d!==f?d-f:String(h.name||"").localeCompare(String(c.name||""))}),{ok:!0,mods:o}}catch(r){return{ok:!1,error:String(r?.message||r)}}});P.handle("mods:setEnabled",async(n,{installDir:e,name:r,enabled:t})=>{try{let s=p.join(e,"mods"),{map:o}=xe(s);return o[r]=!!t,Fe(s,void 0,o),{ok:!0}}catch(s){return{ok:!1,error:String(s?.message||s)}}});P.handle("mods:reorder",async(n,{installDir:e,orderIds:r})=>{try{let t=p.join(e,"mods"),{map:s,order:o}=xe(t),a=Array.isArray(r)?r.filter(d=>typeof d=="string"&&d&&Object.prototype.hasOwnProperty.call(s,d)):[],i=new Set(a),h=o.filter(d=>Object.prototype.hasOwnProperty.call(s,d)&&!i.has(d)),c=[...a,...h];return Fe(t,c,s),{ok:!0}}catch(t){return{ok:!1,error:String(t?.message||t)}}});P.handle("mods:uninstall",async(n,{installDir:e,folder:r})=>{try{let t=p.join(e,"mods"),s=p.join(t,r);return m.rmSync(s,{recursive:!0,force:!0}),{ok:!0}}catch(t){return{ok:!1,error:String(t?.message||t)}}});P.handle("mods:fetchAll",async(n,{query:e})=>{let r="https://thunderstore.io/c/r5valkyrie/api/v1/package-listing-index/",t=o=>new Promise((a,i)=>{Y.get(o,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"*/*"}},c=>{if(c.statusCode&&c.statusCode>=300&&c.statusCode<400&&c.headers.location){c.resume();let f=c.headers.location.startsWith("http")?c.headers.location:new URL(c.headers.location,o).toString();return a(t(f))}if(c.statusCode!==200)return c.resume(),i(new Error(`HTTP ${c.statusCode}`));let d=[];c.on("data",f=>d.push(Buffer.isBuffer(f)?f:Buffer.from(f))),c.on("end",()=>a(Buffer.concat(d)))}).on("error",i)}),s=o=>{try{return rt.gunzipSync(o)}catch{return o}};try{let o=await t(r),a=JSON.parse(s(o).toString("utf8")),i=Array.isArray(a)?a:[],h=6,c=[],d=0;await Promise.all(Array.from({length:h}).map(async()=>{for(;d<i.length;){let l=d++,g=i[l];try{let k=await t(g),u=s(k).toString("utf8"),E=JSON.parse(u);Array.isArray(E)&&c.push(...E)}catch{}}}));let f=c;if(e&&String(e).trim()){let l=String(e).toLowerCase();f=f.filter(g=>String(g?.name||"").toLowerCase().includes(l)||String(g?.full_name||"").toLowerCase().includes(l))}return{ok:!0,mods:f}}catch(o){try{let i=await t("https://thunderstore.io/c/r5valkyrie/api/v1/package/"),h=JSON.parse(i.toString("utf8")),c=Array.isArray(h)?h:[];if(e&&String(e).trim()){let d=String(e).toLowerCase();c=c.filter(f=>String(f?.name||"").toLowerCase().includes(d)||String(f?.full_name||"").toLowerCase().includes(d))}return{ok:!0,mods:c}}catch(a){return{ok:!1,error:String(a?.message||o?.message||a||o)}}}});P.handle("mods:install",async(n,{installDir:e,name:r,downloadUrl:t})=>{if(!t.startsWith("https://thunderstore.io"))return{ok:!1,error:"Download URL does not point to Thunderstore"};try{let s=String(r||"").trim();if(!s)return{ok:!1,error:"Invalid mod name"};if(me.has(s))return{ok:!0};me.add(s);let o=p.join(e,"mods");m.mkdirSync(o,{recursive:!0});let a=p.join(o,`.__mod_${Date.now()}.zip`),i=(f,l=0)=>new Promise((g,k)=>{if(l>5)return k(new Error("Too many redirects"));let u=m.createWriteStream(a);Y.get(f,{headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"application/octet-stream,*/*;q=0.8",Referer:"https://thunderstore.io/",Connection:"keep-alive"}},S=>{if(S.statusCode&&S.statusCode>=300&&S.statusCode<400&&S.headers.location){S.resume(),u.close(()=>{});try{m.unlinkSync(a)}catch{}let L=S.headers.location.startsWith("http")?S.headers.location:new URL(S.headers.location,f).toString();return g(i(L,l+1))}if(S.statusCode!==200){u.close(()=>{});try{m.unlinkSync(a)}catch{}return S.resume(),k(new Error(`HTTP ${S.statusCode}`))}let x=Number(S.headers["content-length"]||0),y=0,v=Date.now(),C=L=>{try{n?.sender?.send("mods:progress",{key:r,phase:L,received:y,total:x})}catch{}};S.on("data",L=>{y+=Buffer.isBuffer(L)?L.length:Buffer.byteLength(String(L));let $=Date.now();$-v>150&&(v=$,C("downloading"))}),S.pipe(u),u.on("finish",()=>{C("downloading"),u.close(g)})}).on("error",S=>{try{m.unlinkSync(a)}catch{}k(S)})});await i(t);try{n?.sender?.send("mods:progress",{key:r,phase:"extracting"})}catch{}let h=p.join(o,r);try{m.rmSync(h,{recursive:!0,force:!0})}catch{}m.mkdirSync(h,{recursive:!0}),await new Promise((f,l)=>{let g=re("powershell.exe",["-NoProfile","-NonInteractive","-Command",`Expand-Archive -LiteralPath "${a}" -DestinationPath "${h}" -Force`],{stdio:"ignore"});g.on("exit",k=>k===0?f():l(new Error(`Expand-Archive failed ${k}`))),g.on("error",l)});try{m.unlinkSync(a)}catch{}let c=null;try{let f=p.join(h,"mod.vdf");if(m.existsSync(f))c=we(f).id;else{let l=m.readdirSync(h,{withFileTypes:!0});for(let g of l)if(g.isDirectory()){let k=p.join(h,g.name,"mod.vdf");if(m.existsSync(k)&&(c=we(k).id,c))break}}}catch{}let d=it(o);d[c||r]=!0,ct(o,d);try{n?.sender?.send("mods:progress",{key:r,phase:"done"})}catch{}return{ok:!0}}catch(s){return{ok:!1,error:String(s?.message||s)}}finally{try{me.delete(String(r||""))}catch{}}});P.handle("mods:watch",async(n,{installDir:e})=>{try{let r=p.join(e,"mods");if(!m.existsSync(r))return{ok:!0};let t=r;if(ne.has(t))return{ok:!0};let s=m.watch(r,{persistent:!0},(o,a)=>{let i=t;clearTimeout(se.get(i));let h=setTimeout(()=>{try{w?.webContents?.send("mods:changed",{installDir:e})}catch{}},300);se.set(i,h)});return ne.set(t,s),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});P.handle("mods:unwatch",async(n,{installDir:e})=>{try{let t=p.join(e,"mods"),s=ne.get(t);if(s){try{s.close()}catch{}ne.delete(t)}let o=se.get(t);return o&&(clearTimeout(o),se.delete(t)),{ok:!0}}catch(r){return{ok:!1,error:String(r?.message||r)}}});P.handle("mods:iconDataUrl",async(n,{installDir:e,folder:r})=>{try{let t=p.join(e,"mods",r,"icon.png");return await m.promises.access(t),{ok:!0,dataUrl:`data:image/png;base64,${(await m.promises.readFile(t)).toString("base64")}`}}catch(t){return{ok:!1,error:String(t?.message||t)}}});P.handle("select-directory",async()=>{let n=await Se.showOpenDialog({properties:["openDirectory","createDirectory"]});return n.canceled||n.filePaths.length===0?null:n.filePaths[0]});P.handle("settings:get",()=>pe());P.handle("settings:set",(n,{key:e,value:r})=>te(e,r));P.handle("download:checksums",async(n,{baseUrl:e})=>Te(e));P.handle("download:all",async(n,{baseUrl:e,checksums:r,installDir:t,includeOptional:s,concurrency:o,partConcurrency:a,channelName:i,mode:h})=>{let c=(d,f)=>n.sender.send(d,f);try{if(!(String(h||"install").toLowerCase()==="install")){let f=p.join(t,"mods","mods.vdf");if(m.existsSync(f)){let g=(Array.isArray(r?.files)?r.files:[]).filter(k=>{try{return String(k?.path||k?.name||"").replace(/\\/g,"/").toLowerCase()!=="mods/mods.vdf"}catch{return!0}});r={...r||{},files:g}}}}catch{}q=_e(),Q=!1;try{await Me(e,r,t,c,!!s,Number(o)||4,Number(a)||4,q,()=>Q);try{let d=fe("channels",{})||{};d[String(i||"default")]={installDir:t,gameVersion:r?.game_version||null,gameBaseUrl:e,lastUpdatedAt:Date.now()},te("channels",d)}catch(d){console.error("Failed to persist channel info",d)}}finally{q=null}return!0});P.handle("default-install-dir",(n,{channelName:e})=>{let r=process.env.LOCALAPPDATA||p.join(b.getPath("home"),"AppData","Local"),t=p.join(r,"Programs","R5VLibrary");return e?p.join(t,e):t});P.handle("scan-custom-channels",async(n,{officialChannelNames:e})=>{try{let r=process.env.LOCALAPPDATA||p.join(b.getPath("home"),"AppData","Local"),t=p.join(r,"Programs","R5VLibrary");try{await m.promises.access(t)}catch{return[]}let s=await m.promises.readdir(t,{withFileTypes:!0}),o=[],a=new Set((e||[]).map(i=>i.toLowerCase()));for(let i of s){if(!i.isDirectory())continue;let h=i.name,c=p.join(t,h);if(a.has(h.toLowerCase()))continue;let d=!1;try{await m.promises.access(p.join(c,"r5apex.exe")),d=!0}catch{try{await m.promises.access(p.join(c,"r5apex_ds.exe")),d=!0}catch{}}d&&o.push({name:h,installDir:c,isCustom:!0})}return o}catch(r){return console.error("Error scanning for custom channels:",r),[]}});P.handle("open-folder",async(n,{folderPath:e})=>{try{if(!e)return{ok:!1,error:"No folder path provided"};try{await m.promises.access(e)}catch{return{ok:!1,error:"Folder does not exist"}}return await ye.openPath(e),{ok:!0}}catch(r){return console.error("Error opening folder:",r),{ok:!1,error:String(r)}}});P.handle("set-download-speed-limit",async(n,{bytesPerSecond:e})=>{try{let r=Number(e)||0;return be(r),{ok:!0}}catch(r){return console.error("Error setting download speed limit:",r),{ok:!1,error:String(r)}}});P.handle("launcher:config",async(n,{url:e})=>(t=>new Promise((s,o)=>{Y.get(t,a=>{if(a.statusCode!==200){o(new Error(`HTTP ${a.statusCode} for ${t}`)),a.resume();return}let i="";a.setEncoding("utf8"),a.on("data",h=>i+=h),a.on("end",()=>{try{s(JSON.parse(i))}catch(h){o(h)}})}).on("error",o)}))(e));P.handle("eula:get",async()=>{let n="https://playvalkyrie.org/api/eula",e=r=>new Promise((t,s)=>{Y.get(r,o=>{if(o.statusCode!==200){s(new Error(`HTTP ${o.statusCode}`)),o.resume();return}let a=[];o.on("data",i=>a.push(Buffer.isBuffer(i)?i:Buffer.from(i))),o.on("end",()=>{try{let i=Buffer.concat(a).toString("utf8");t(JSON.parse(i))}catch(i){s(i)}})}).on("error",s)});try{return{ok:!0,json:await e(n)}}catch(r){return{ok:!1,error:String(r?.message||r)}}});P.handle("video:cache",async(n,{filename:e})=>{try{let t=`https://blaze.playvalkyrie.org/video_backgrounds/${e}`,s=p.join(p.resolve(b.getAppPath(),".."),"cache"),o=p.join(s,"videos"),a=p.join(o,e),i=p.join(X,"..","dist"),h=p.join(i,e);await m.promises.mkdir(o,{recursive:!0});try{if((await m.promises.stat(a)).size>0){try{await m.promises.access(h)}catch{await m.promises.copyFile(a,h)}return`./${e}`}else await m.promises.unlink(a)}catch{}return await new Promise((c,d)=>{let f=m.createWriteStream(a),l=Y.get(t,g=>{if(g.statusCode!==200){f.close(()=>{}),m.unlink(a,()=>{}),d(new Error(`HTTP ${g.statusCode} for video ${e}`)),g.resume();return}g.pipe(f),f.on("finish",()=>f.close(c)),f.on("error",k=>{m.unlink(a,()=>d(k))})});l.on("error",g=>{f.close(()=>{}),m.unlink(a,()=>{}),d(g)}),l.setTimeout(3e4,()=>{l.destroy(),f.close(()=>{}),m.unlink(a,()=>{}),d(new Error(`Video download timeout for ${e}`))})}),await m.promises.copyFile(a,h),`./${e}`}catch(r){throw console.error(`Video cache error for ${e}:`,r),r}});P.handle("fs:is-installed-in-dir",async(n,{path:e})=>{let r=!1,t=!1;try{await m.promises.access(p.join(e,"r5apex.exe")),r=!0}catch{}try{await m.promises.access(p.join(e,"r5apex_ds.exe")),t=!0}catch{}return r||t});var Q=!1;P.handle("download:pause",async()=>{Q=!0;try{w?.webContents.send("progress:paused",{})}catch{}return!0});P.handle("download:resume",async()=>{Q=!1;try{w?.webContents.send("progress:resumed",{})}catch{}return!0});P.handle("download:cancel",async()=>{try{de(q)}catch{}q=null,Q=!1;try{w?.webContents.send("progress:cancelled",{})}catch{}return!0});P.handle("select-file",async(n,{filters:e})=>{let r=await Se.showOpenDialog({properties:["openFile"],filters:Array.isArray(e)?e:void 0});return r.canceled||r.filePaths.length===0?null:r.filePaths[0]});P.handle("game:launch",async(n,{channelName:e,installDir:r,mode:t,argsString:s})=>{try{if(!r)throw new Error("Missing installDir");let o=String(t).toUpperCase()==="SERVER"?"r5apex_ds.exe":"r5apex.exe",a=p.join(r,o);await m.promises.access(a).catch(()=>{throw new Error(`Executable not found: ${a}`)});let h=(d=>!d||typeof d!="string"?[]:(d.match(/(?:[^\s\"]+|\"[^\"]*\")+/g)||[]).map(l=>l.replace(/^\"|\"$/g,"")))(s);return re(a,h,{cwd:r,detached:!0,stdio:"ignore",env:{...process.env}}).unref(),{ok:!0}}catch(o){return{ok:!1,error:String(o?.message||o)}}});P.handle("fix-folder-permissions",async(n,{selectedChannel:e})=>{let r=[],t=pe().channels[e].installDir;try{if(!t)return{ok:!1,error:"No folder path provided"};let s=p.resolve(t).replace(/\//g,"\\");if(!s||s.length<3)return{ok:!1,error:`Invalid path format: ${t}`};let o=s.length>=3&&s[1]===":"?s.slice(3):s;if(/[<>:"|?*]/.test(o))return{ok:!1,error:`Path contains invalid characters: ${s}`};let h=nt.userInfo().username,c=p.join(process.resourcesPath,"elevate.exe"),d=m.existsSync(c);try{m.mkdirSync(s,{recursive:!0})}catch{}let f=[{exe:"icacls",args:[s,"/grant",`${h}:F`,"/t","/q"],desc:`Grant permissions to current user (${h})`},{exe:"icacls",args:[s,"/grant","Everyone:F","/t","/q"],desc:"Grant Everyone full permissions"},{exe:"icacls",args:[s,"/grant","Users:F","/t","/q"],desc:"Grant Users full permissions"}];for(let l=0;l<f.length;l++){let{exe:g,args:k,desc:u}=f[l];try{let E=await new Promise((S,x)=>{let y,v,C;d?(v=[c,["-wait",g,...k]],C={stdio:["ignore","pipe","pipe"],windowsHide:!0}):(v=[g,k],C={stdio:["ignore","pipe","pipe"],windowsHide:!0});try{y=re(v[0],v[1],C)}catch(T){console.error("[Permission Fix] Spawn failed:",T),x(T);return}let L="",$="";y.stdout&&y.stdout.on("data",T=>{L+=T.toString()}),y.stderr&&y.stderr.on("data",T=>{$+=T.toString()}),y.on("exit",(T,I)=>{S({code:T,stdout:L,stderr:$,signal:I})}),y.on("error",T=>{x(T)}),setTimeout(()=>{try{y.kill()}catch{}x(new Error("Command timeout"))},3e4)});if(E.code!==0){let S=E.stderr||E.stdout||"Unknown error";if(!(S.includes("duplicate")||S.includes("already")||E.code===1332)){let y=`${u} failed (code ${E.code}): ${S}`;r.push(y)}}}catch(E){let S=`${u} error: ${E.message}`;r.push(S)}}try{let l=p.join(s,"test_write.tmp");m.writeFileSync(l,"test"),m.unlinkSync(l)}catch(l){let g=`Write test failed: ${l.message}`;r.push(g);try{if(m.mkdirSync(s,{recursive:!0}),(await new Promise(u=>{let E=re("cmd",["/c",`icacls "${s}" /grant "%USERNAME%":F /q`],{stdio:"ignore",windowsHide:!0});E.on("exit",S=>u({code:S})),E.on("error",()=>u({code:1})),setTimeout(()=>{try{E.kill()}catch{}u({code:1})},5e3)})).code===0){let u=p.join(s,"test_write2.tmp");return m.writeFileSync(u,"test"),m.unlinkSync(u),{ok:!0,warnings:r}}}catch{}return{ok:!1,error:g,details:r}}return r.length>0?{ok:!0,warnings:r}:{ok:!0}}catch(s){let o=`Unexpected error: ${s?.message||s}`;return r.push(o),{ok:!1,error:o,details:r}}});P.on("window:minimize",()=>{w?.minimize()});P.on("window:maximize",()=>{w&&(w.isMaximized()?w.unmaximize():w.maximize())});P.on("window:close",()=>{w?.close()});b.on("before-quit",()=>{if(q)try{de(q)}catch{}});
