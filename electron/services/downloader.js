import o from"node:fs";import u from"node:path";import at from"node:crypto";import{pipeline as nt}from"node:stream";import{promisify as st}from"node:util";import K from"node:https";var ct=st(nt);function Y(s){return String(s||"").replace(/\\/g,"/").replace(/^\/+/,"")}function O(s){return String(s||"").replace(/\\/g,"/").toLowerCase()}var b=new Map,j=new K.Agent({keepAlive:!0,maxSockets:64,maxFreeSockets:32,keepAliveMsecs:6e4,scheduling:"fifo"}),_=class{constructor(){this.maxBytesPerSecond=0,this.tokens=0,this.lastRefill=Date.now()}setMaxSpeed(e){this.maxBytesPerSecond=Math.max(0,e),this.tokens=this.maxBytesPerSecond}async consumeTokens(e){if(this.maxBytesPerSecond<=0)return;let l=Date.now(),r=(l-this.lastRefill)/1e3;if(this.tokens=Math.min(this.maxBytesPerSecond,this.tokens+r*this.maxBytesPerSecond),this.lastRefill=l,e>this.tokens){let c=(e-this.tokens)/this.maxBytesPerSecond*1e3;await z(c),this.tokens=0}else this.tokens-=e}},tt=new _;function wt(s){tt.setMaxSpeed(s)}function U(s){return new Promise((e,l)=>{let r=at.createHash("sha256"),d=o.createReadStream(s);d.on("error",l),d.on("end",()=>e(r.digest("hex"))),d.on("data",c=>r.update(c))})}function et(s){o.mkdirSync(s,{recursive:!0})}function ot(s){return new Promise((e,l)=>{let r=K.get(s,{agent:j},d=>{if(d.statusCode!==200){l(new Error(`HTTP ${d.statusCode} for ${s}`)),d.resume();return}let c="";d.setEncoding("utf8"),d.on("data",N=>c+=N),d.on("end",()=>{try{e(JSON.parse(c))}catch(N){l(N)}})});r.on("error",l),r.setTimeout(3e4,()=>{r.destroy(),l(new Error("JSON fetch timeout"))})})}function z(s){return new Promise(e=>setTimeout(e,s))}function mt(){return{cancelled:!1,requests:new Set}}function St(s){if(s){s.cancelled=!0;for(let e of s.requests)try{e.destroy(new Error("cancelled"))}catch{}s.requests.clear()}}var it=new Set(["ECONNRESET","ETIMEDOUT","EAI_AGAIN","ECONNABORTED","ENETRESET","EHOSTUNREACH","ENETUNREACH","EPIPE","ENOTFOUND","ECONNREFUSED","EHOSTDOWN","ENETDOWN","EPERM","EBUSY","EACCES"]);async function J(s,e,l,r=1,d,c=0,N=0){return new Promise((p,M)=>{et(u.dirname(e));let m;try{m=o.createWriteStream(e,{flags:c>0?"a":"w"})}catch(t){if(r<8&&(t.code==="EPERM"||t.code==="EBUSY"||t.code==="EACCES")){let f=Math.min(1e3*r,5e3);return z(f).then(()=>p(J(s,e,l,r+1,d,c,N)))}return M(t)}if(d?.cancelled)return m.close(()=>{}),M(new Error("cancelled"));let w=!1,R=t=>{w||(w=!0,p(t))},C=t=>{w||(w=!0,M(t))},$={agent:j};c>0&&($.headers={Range:`bytes=${c}-`});let g=0,n=null,S=()=>new Promise(t=>{try{m.close(()=>t())}catch{t()}}),y=async(t,f=!1)=>{try{n&&clearInterval(n)}catch{}try{await S()}catch{}if(await z(100),f)try{o.unlinkSync(e)}catch{}if(r<8){let i=Math.min(1e3*Math.pow(1.5,r),15e3),k=Math.random()*1e3,v=i+k;return await z(v),R(J(s,e,l,r+1,d,t,N)),!0}return!1},a=K.get(s,$,t=>{if(t.statusCode!==200&&!(c>0&&t.statusCode===206)){if(w=!0,c>0&&t.statusCode===200){t.resume(),y(0,!0).then(h=>{h||M(new Error(`HTTP ${t.statusCode} for ${s}`))});return}if(c>0&&t.statusCode===416){t.resume(),y(0,!0).then(h=>{h||M(new Error(`HTTP ${t.statusCode} for ${s}`))});return}if(t.statusCode&&[429,500,502,503,504].includes(t.statusCode)&&r<5){t.resume(),y(c,!1).then(h=>{h||M(new Error(`HTTP ${t.statusCode} for ${s}`))});return}S().then(()=>{o.unlink(e,()=>{}),M(new Error(`HTTP ${t.statusCode} for ${s}`))}),t.resume();return}let f=Number(t.headers["content-length"]||0),i=N>0?N:c>0?c+f:f,k=Date.now(),v=r<=2?3e4:45e3;n=setInterval(()=>{if(!d?.cancelled&&Date.now()-k>v)try{let h=new Error("stalled");h.code="ETIMEDOUT",a.destroy(h)}catch{}},1e4),t.on("data",async h=>{await tt.consumeTokens(h.length),g+=h.length,k=Date.now(),l&&l(Math.min(c+g,i||c+g),i||0)}),t.on("aborted",async()=>{await y(c+g)||C(new Error("response aborted"))}),ct(t,m).then(()=>{try{n&&clearInterval(n)}catch{}R()}).catch(async h=>{try{n&&clearInterval(n)}catch{}let P=String(h?.message||h||"").toLowerCase();(P.includes("aborted")||P.includes("socket")||P.includes("closed"))&&await y(c+g)||C(h)})});if(d?.requests.add(a),a.on("socket",t=>{try{t.setKeepAlive(!0,6e4),t.setNoDelay(!0),t.setRecvBufferSize&&t.setRecvBufferSize(64*1024),t.setSendBufferSize&&t.setSendBufferSize(64*1024)}catch{}}),a.on("close",()=>d?.requests.delete(a)),a.setTimeout(9e4,()=>{try{let t=new Error("Request timeout");t.code="ETIMEDOUT",a.destroy(t)}catch{}}),d?.cancelled)try{a.destroy(new Error("cancelled"))}catch{}a.on("error",async t=>{let f=t?.code,i=String(t?.message||"").toLowerCase(),k=i.includes("aborted")||i.includes("socket")||i.includes("closed");if(r<8&&(k||f&&it.has(String(f)))){let h=c;try{h=o.statSync(e).size}catch{}await y(h)||C(t)}else{let h=new Promise(P=>{try{m.close(()=>P())}catch{P()}});try{await h}catch{}C(t)}})})}async function ht(s,e,l){try{let r=o.statSync(s);return l&&Number(l)>0&&r.size!==Number(l)?!1:(await U(s)).toLowerCase()===String(e).toLowerCase()}catch{return!1}}async function Et(s){let e=`${s.replace(/\/$/,"")}/checksums.json`;return ot(e)}async function lt(s,e,l,r,d=4,c){let N=Y(e.path).split("/").join(u.sep),p=u.join(l,N);if(et(u.dirname(p)),await ht(p,e.checksum,e.size))return r("progress:skip",{path:e.path}),{downloadComplete:!0,verificationComplete:!0,targetPath:p};if(c?.cancelled)throw new Error("cancelled");if(Array.isArray(e.parts)&&e.parts.length>0){let m=e.parts.length,w=new Array(m),R=0,C=new Set;async function $(){for(;;){let n=R++;if(n>=m)return;if(C.has(n))continue;C.add(n);let S=e.parts[n],y=Y(S.path),a=`${s.replace(/\/$/,"")}/${y}`,t=`${p}.part${n}`;try{if(o.existsSync(t))if((await U(t)).toLowerCase()===String(S.checksum).toLowerCase()){r("progress:part",{path:e.path,part:n,totalParts:m,received:Number(S.size||0),total:Number(S.size||0)}),w[n]=t;continue}else try{o.unlinkSync(t)}catch{}}catch{}let f=0;for(;;){if(c?.cancelled)throw new Error("cancelled");f+=1;let i=0,k=0;try{let P=0;try{P=o.statSync(t).size}catch{}let T=Number(S.size||0);if(T>0&&P>T)try{o.unlinkSync(t),P=0}catch{}await J(a,t,(E,H)=>{let I=Math.max(0,E-k);k=E;try{I>0&&r("progress:bytes",{delta:I})}catch{}i+=I;let q=T||H||0;r("progress:part",{path:e.path,part:n,totalParts:m,received:Math.min(E,q||E),total:q})},1,c,P,T)}catch{try{o.unlinkSync(t)}catch{}try{i>0&&r("progress:bytes",{delta:-i})}catch{}try{r("progress:part:reset",{path:e.path,part:n,totalParts:m})}catch{}let T=Math.min(2e3*f,1e4);await z(T);continue}if((await U(t)).toLowerCase()===String(S.checksum).toLowerCase())break;try{o.unlinkSync(t)}catch{}try{i>0&&r("progress:bytes",{delta:-i})}catch{}try{r("progress:part:reset",{path:e.path,part:n,totalParts:m})}catch{}let h=Math.min(2e3*f,1e4);await z(h)}w[n]=t}}let g=Array.from({length:Math.max(1,d)},()=>$());return await Promise.all(g),{downloadComplete:!0,verificationComplete:!1,targetPath:p,mergeAndVerifyAsync:async()=>{r("progress:merge:start",{path:e.path,parts:w.length});let n=o.createWriteStream(p);for(let y=0;y<w.length;y++){let a=w[y];r("progress:merge:part",{path:e.path,part:y,totalParts:w.length}),await new Promise((t,f)=>{let i=o.createReadStream(a);i.on("error",f),n.on("error",f),i.on("end",()=>{try{o.unlinkSync(a)}catch{}t()}),i.pipe(n,{end:!1})})}await new Promise((y,a)=>{n.on("error",a),n.on("finish",y),n.end()});try{r("progress:merge:done",{path:e.path})}catch{}if(r("progress:verify",{path:e.path}),(await U(p)).toLowerCase()!==String(e.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${e.path}`);try{let y=o.readdirSync(u.dirname(p)),a=u.basename(p);y.forEach(t=>{if(t.startsWith(a+".part"))try{o.unlinkSync(u.join(u.dirname(p),t))}catch{}})}catch{}return{verificationComplete:!0,targetPath:p,filePath:e.path}}}}else{let m=Y(e.path),w=`${s.replace(/\/$/,"")}/${m}`,R=0;for(;;){R+=1;let C=0,$=0,g=`${p}.download`,n=0;try{n=o.statSync(g).size}catch{}let S=Number(e.size||0);if(S>0&&n>S)try{o.unlinkSync(g),n=0}catch{}if(await J(w,g,(a,t)=>{let f=Math.max(0,a-$);$=a;try{f>0&&r("progress:bytes",{delta:f})}catch{}C+=f;let i=S||t||0;r("progress:file",{path:e.path,received:Math.min(a,i||a),total:i})},1,c,n,S),(await U(g)).toLowerCase()===String(e.checksum).toLowerCase())break;try{o.unlinkSync(g)}catch{}try{C>0&&r("progress:bytes",{delta:-C})}catch{}if(R>=2)throw new Error(`Checksum mismatch for ${e.path}`)}try{o.unlinkSync(p)}catch{}o.renameSync(`${p}.download`,p)}if(r("progress:verify",{path:e.path}),(await U(p)).toLowerCase()!==String(e.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${e.path}`);return{downloadComplete:!0,verificationComplete:!0,targetPath:p}}async function Ct(s,e,l,r,d=!1,c=4,N=4,p,M){let m=new Set,w=[];for(let a of e.files||[]){if(!(d||!a.optional))continue;let t=O(a.path);t&&(m.has(t)||(m.add(t),w.push(a)))}let R=w.filter(a=>!(Array.isArray(a.parts)&&a.parts.length>0)),C=w.filter(a=>Array.isArray(a.parts)&&a.parts.length>0),$=R.concat(C),g=$.length,n=0,S=$.reduce((a,t)=>{let f=Number(t.size||0);return f>0?a+f:Array.isArray(t.parts)&&t.parts.length?a+t.parts.reduce((i,k)=>i+Number(k.size||0),0):a},0);try{r("progress:bytes:total",{totalBytes:S})}catch{}async function y(a,t,f,i=!1){let k=0,v=[];async function h(){for(;;){for(;M&&M();)if(await z(100),p?.cancelled)return;let T=k++;if(T>=a.length)return;let E=a[T],H=t+T,I=O(E.path),q=async()=>lt(s,E,l,r,N,p),Q=!1,W=b.get(I);W?Q=!0:(r("progress:start",{index:H,total:g,path:E.path,completed:n}),W=(async()=>{try{let D=await q();if(i&&D?.mergeAndVerifyAsync){let Z=D.mergeAndVerifyAsync().then(A=>(A?.filePath&&(n+=1,r("progress:done",{index:H,total:g,path:A.filePath,completed:n})),A)).catch(A=>{if(String(A?.message||A||"error").includes("cancelled"))throw A;try{let B=u.join(l,E.path.replace(/\\/g,u.sep));try{o.unlinkSync(B)}catch{}try{let x=o.readdirSync(u.dirname(B)),L=u.basename(B);x.forEach(G=>{if(G.startsWith(L+".part"))try{o.unlinkSync(u.join(u.dirname(B),G))}catch{}})}catch{}return q().then(x=>x.mergeAndVerifyAsync?x.mergeAndVerifyAsync().then(L=>(L?.filePath&&(n+=1,r("progress:done",{index:H,total:g,path:L.filePath,completed:n})),L)):x)}catch(B){try{r("progress:error",{path:E.path,message:String(B?.message||B)})}catch{}throw B}});return v.push(Z),{...D,skipProgressDone:!0}}return D}catch(D){if(String(D?.message||D||"error").includes("cancelled"))throw D;try{let A=u.join(l,E.path.replace(/\\/g,u.sep));try{o.unlinkSync(A)}catch{}let V=await q();if(i&&V?.mergeAndVerifyAsync){let B=V.mergeAndVerifyAsync().then(x=>(x?.filePath&&(n+=1,r("progress:done",{index:H,total:g,path:x.filePath,completed:n})),x)).catch(x=>{try{let L=u.join(l,E.path.replace(/\\/g,u.sep)),G=o.readdirSync(u.dirname(L)),rt=u.basename(L);G.forEach(F=>{if(F.startsWith(rt+".part"))try{o.unlinkSync(u.join(u.dirname(L),F))}catch{}})}catch{}try{r("progress:error",{path:E.path,message:String(x?.message||x)})}catch{}throw x});return v.push(B),{...V,skipProgressDone:!0}}return V}catch(A){try{r("progress:error",{path:E.path,message:String(A?.message||A)})}catch{}throw A}}})(),b.set(I,W));let X;try{X=await W}finally{Q||b.delete(I)}X?.skipProgressDone||(n+=1,r("progress:done",{index:H,total:g,path:E.path,completed:n})),await z(10)}}let P=Array.from({length:Math.max(1,f)},()=>h());await Promise.all(P),v.length>0&&await Promise.all(v)}if(await y(R,0,Math.max(1,c)),b.size>0)try{await Promise.all([...b.values()])}catch{}await y(C,R.length,1,!0)}export{St as cancelToken,mt as createCancelToken,Ct as downloadAll,lt as downloadFileObject,Et as fetchChecksums,wt as setGlobalDownloadSpeed};
