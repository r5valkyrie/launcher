import i from"node:fs";import u from"node:path";import at from"node:crypto";import{pipeline as nt}from"node:stream";import{promisify as st}from"node:util";import Q from"node:https";var ot=st(nt);function Y(n){return String(n||"").replace(/\\/g,"/").replace(/^\/+/,"")}function j(n){return String(n||"").replace(/\\/g,"/").toLowerCase()}var b=new Map,tt=new Q.Agent({keepAlive:!0,maxSockets:64,maxFreeSockets:32,keepAliveMsecs:6e4,scheduling:"fifo"}),ct={"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"application/octet-stream, */*;q=0.8","Accept-Encoding":"identity",Connection:"keep-alive","Cache-Control":"no-transform"},K=class{constructor(){this.maxBytesPerSecond=0,this.tokens=0,this.lastRefill=Date.now()}setMaxSpeed(e){this.maxBytesPerSecond=Math.max(0,e),this.tokens=this.maxBytesPerSecond}async consumeTokens(e){if(this.maxBytesPerSecond<=0)return;let f=Date.now(),r=(f-this.lastRefill)/1e3;if(this.tokens=Math.min(this.maxBytesPerSecond,this.tokens+r*this.maxBytesPerSecond),this.lastRefill=f,e>this.tokens){let o=(e-this.tokens)/this.maxBytesPerSecond*1e3;await z(o),this.tokens=0}else this.tokens-=e}},et=new K;function mt(n){et.setMaxSpeed(n)}function U(n){return new Promise((e,f)=>{let r=at.createHash("sha256"),p=i.createReadStream(n);p.on("error",f),p.on("end",()=>e(r.digest("hex"))),p.on("data",o=>r.update(o))})}function rt(n){try{i.mkdirSync(n,{recursive:!0})}catch(e){if(e?.code==="ENOENT"){let r=n.split(u.sep).filter(Boolean),p="";for(let o of r){p=p?u.join(p,o):o.includes(":")?o+u.sep:o;try{i.accessSync(p)}catch{throw new Error(`Cannot create directory: parent path "${p}" does not exist or is not accessible. Please ensure the drive is available and you have write permissions.`)}}}throw e}}function it(n){return new Promise((e,f)=>{let r={agent:tt,headers:{"User-Agent":"R5Valkyrie-Launcher/1.0",Accept:"application/json","Accept-Encoding":"identity",Connection:"keep-alive"}},p=Q.get(n,r,o=>{if(o.statusCode!==200){f(new Error(`HTTP ${o.statusCode} for ${n}`)),o.resume();return}let R="";o.setEncoding("utf8"),o.on("data",d=>R+=d),o.on("end",()=>{try{e(JSON.parse(R))}catch(d){f(d)}})});p.on("error",f),p.setTimeout(3e4,()=>{p.destroy(),f(new Error("JSON fetch timeout"))})})}function z(n){return new Promise(e=>setTimeout(e,n))}function St(){return{cancelled:!1,requests:new Set}}function Et(n){if(n){n.cancelled=!0;for(let e of n.requests)try{e.destroy(new Error("cancelled"))}catch{}n.requests.clear()}}var ht=new Set(["ECONNRESET","ETIMEDOUT","EAI_AGAIN","ECONNABORTED","ENETRESET","EHOSTUNREACH","ENETUNREACH","EPIPE","ENOTFOUND","ECONNREFUSED","EHOSTDOWN","ENETDOWN","EPERM","EBUSY","EACCES"]);async function G(n,e,f,r=1,p,o=0,R=0){return new Promise((d,$)=>{rt(u.dirname(e));let S;try{S=i.createWriteStream(e,{flags:o>0?"a":"w"})}catch(t){if(r<8&&(t.code==="EPERM"||t.code==="EBUSY"||t.code==="EACCES")){let c=Math.min(1e3*r,5e3);return z(c).then(()=>d(G(n,e,f,r+1,p,o,R)))}return $(t)}if(p?.cancelled)return S.close(()=>{}),$(new Error("cancelled"));let g=!1,M=t=>{g||(g=!0,d(t))},P=t=>{g||(g=!0,$(t))},L={agent:tt,headers:{...ct}};o>0&&(L.headers.Range=`bytes=${o}-`);let y=0,s=null,m=()=>new Promise(t=>{try{S.close(()=>t())}catch{t()}}),x=async(t,c=!1)=>{try{s&&clearInterval(s)}catch{}try{await m()}catch{}if(await z(100),c)try{i.unlinkSync(e)}catch{}if(r<8){let h=Math.min(1e3*Math.pow(1.5,r),15e3),C=Math.random()*1e3,A=h+C;return await z(A),M(G(n,e,f,r+1,p,t,R)),!0}return!1},a=Q.get(n,L,t=>{if(t.statusCode!==200&&!(o>0&&t.statusCode===206)){if(g=!0,o>0&&t.statusCode===200){t.resume(),x(0,!0).then(l=>{l||$(new Error(`HTTP ${t.statusCode} for ${n}`))});return}if(o>0&&t.statusCode===416){t.resume(),x(0,!0).then(l=>{l||$(new Error(`HTTP ${t.statusCode} for ${n}`))});return}if(t.statusCode&&[429,500,502,503,504].includes(t.statusCode)&&r<5){t.resume(),x(o,!1).then(l=>{l||$(new Error(`HTTP ${t.statusCode} for ${n}`))});return}m().then(()=>{i.unlink(e,()=>{}),$(new Error(`HTTP ${t.statusCode} for ${n}`))}),t.resume();return}let c=Number(t.headers["content-length"]||0),h=R>0?R:o>0?o+c:c,C=Date.now(),A=r<=2?3e4:45e3;s=setInterval(()=>{if(!p?.cancelled&&Date.now()-C>A)try{let l=new Error("stalled");l.code="ETIMEDOUT",a.destroy(l)}catch{}},1e4),t.on("data",async l=>{await et.consumeTokens(l.length),y+=l.length,C=Date.now(),f&&f(Math.min(o+y,h||o+y),h||0)}),t.on("aborted",async()=>{await x(o+y)||P(new Error("response aborted"))}),ot(t,S).then(()=>{try{s&&clearInterval(s)}catch{}M()}).catch(async l=>{try{s&&clearInterval(s)}catch{}let E=String(l?.message||l||"").toLowerCase();(E.includes("aborted")||E.includes("socket")||E.includes("closed"))&&await x(o+y)||P(l)})});if(p?.requests.add(a),a.on("socket",t=>{try{t.setKeepAlive(!0,6e4),t.setNoDelay(!0),t.setRecvBufferSize&&t.setRecvBufferSize(64*1024),t.setSendBufferSize&&t.setSendBufferSize(64*1024)}catch{}}),a.on("close",()=>p?.requests.delete(a)),a.setTimeout(9e4,()=>{try{let t=new Error("Request timeout");t.code="ETIMEDOUT",a.destroy(t)}catch{}}),p?.cancelled)try{a.destroy(new Error("cancelled"))}catch{}a.on("error",async t=>{let c=t?.code,h=String(t?.message||"").toLowerCase(),C=h.includes("aborted")||h.includes("socket")||h.includes("closed");if(r<8&&(C||c&&ht.has(String(c)))){let l=o;try{l=i.statSync(e).size}catch{}await x(l)||P(t)}else{let l=new Promise(E=>{try{S.close(()=>E())}catch{E()}});try{await l}catch{}P(t)}})})}async function lt(n,e,f){try{let r=i.statSync(n);return f&&Number(f)>0&&r.size!==Number(f)?!1:(await U(n)).toLowerCase()===String(e).toLowerCase()}catch{return!1}}async function Pt(n){let e=`${n.replace(/\/$/,"")}/checksums.json`;return it(e)}async function pt(n,e,f,r,p=4,o){let R=Y(e.path).split("/").join(u.sep),d=u.join(f,R);if(rt(u.dirname(d)),await lt(d,e.checksum,e.size))return r("progress:skip",{path:e.path}),{downloadComplete:!0,verificationComplete:!0,targetPath:d};if(o?.cancelled)throw new Error("cancelled");if(Array.isArray(e.parts)&&e.parts.length>0){let S=e.parts.length,g=new Array(S),M=0,P=new Set;async function L(){for(;;){let s=M++;if(s>=S)return;if(P.has(s))continue;P.add(s);let m=e.parts[s],x=Y(m.path),a=`${n.replace(/\/$/,"")}/${x}`,t=`${d}.part${s}`;try{if(i.existsSync(t))if((await U(t)).toLowerCase()===String(m.checksum).toLowerCase()){r("progress:part",{path:e.path,part:s,totalParts:S,received:Number(m.size||0),total:Number(m.size||0)}),g[s]=t;continue}else try{i.unlinkSync(t)}catch{}}catch{}let c=0;for(;;){if(o?.cancelled)throw new Error("cancelled");c+=1;let h=0,C=0;try{let E=0;try{E=i.statSync(t).size}catch{}let T=Number(m.size||0);if(T>0&&E>T)try{i.unlinkSync(t),E=0}catch{}await G(a,t,(w,k)=>{let V=Math.max(0,w-C);C=w;try{V>0&&r("progress:bytes",{delta:V})}catch{}h+=V;let q=T||k||0;r("progress:part",{path:e.path,part:s,totalParts:S,received:Math.min(w,q||w),total:q})},1,o,E,T)}catch{try{i.unlinkSync(t)}catch{}try{h>0&&r("progress:bytes",{delta:-h})}catch{}try{r("progress:part:reset",{path:e.path,part:s,totalParts:S})}catch{}let T=Math.min(2e3*c,1e4);await z(T);continue}if((await U(t)).toLowerCase()===String(m.checksum).toLowerCase())break;try{i.unlinkSync(t)}catch{}try{h>0&&r("progress:bytes",{delta:-h})}catch{}try{r("progress:part:reset",{path:e.path,part:s,totalParts:S})}catch{}let l=Math.min(2e3*c,1e4);await z(l)}g[s]=t}}let y=Array.from({length:Math.max(1,p)},()=>L());return await Promise.all(y),{downloadComplete:!0,verificationComplete:!1,targetPath:d,mergeAndVerifyAsync:async()=>{r("progress:merge:start",{path:e.path,parts:g.length});let s=5*60*1e3,m=async()=>{let a=i.createWriteStream(d),t=null;try{for(let c=0;c<g.length;c++){let h=g[c];if(!h)throw new Error(`Part ${c} path is undefined for ${e.path}`);r("progress:merge:part",{path:e.path,part:c,totalParts:g.length}),await new Promise((C,A)=>{if(!i.existsSync(h)){A(new Error(`Part file missing: ${h}`));return}let l=i.createReadStream(h);l.on("error",A),t||(t=E=>A(E),a.on("error",t)),l.on("end",()=>{try{i.unlinkSync(h)}catch{}C()}),l.pipe(a,{end:!1})})}await new Promise((c,h)=>{a.on("finish",c),a.end()})}catch(c){try{a.destroy()}catch{}throw c}};await Promise.race([m(),new Promise((a,t)=>setTimeout(()=>t(new Error(`Merge timeout for ${e.path}`)),s))]);try{r("progress:merge:done",{path:e.path})}catch{}if(r("progress:verify",{path:e.path}),(await U(d)).toLowerCase()!==String(e.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${e.path}`);try{let a=i.readdirSync(u.dirname(d)),t=u.basename(d);a.forEach(c=>{if(c.startsWith(t+".part"))try{i.unlinkSync(u.join(u.dirname(d),c))}catch{}})}catch{}return{verificationComplete:!0,targetPath:d,filePath:e.path}}}}else{let S=Y(e.path),g=`${n.replace(/\/$/,"")}/${S}`,M=0;for(;;){M+=1;let P=0,L=0,y=`${d}.download`,s=0;try{s=i.statSync(y).size}catch{}let m=Number(e.size||0);if(m>0&&s>m)try{i.unlinkSync(y),s=0}catch{}if(await G(g,y,(a,t)=>{let c=Math.max(0,a-L);L=a;try{c>0&&r("progress:bytes",{delta:c})}catch{}P+=c;let h=m||t||0;r("progress:file",{path:e.path,received:Math.min(a,h||a),total:h})},1,o,s,m),(await U(y)).toLowerCase()===String(e.checksum).toLowerCase())break;try{i.unlinkSync(y)}catch{}try{P>0&&r("progress:bytes",{delta:-P})}catch{}if(M>=2)throw new Error(`Checksum mismatch for ${e.path}`)}try{i.unlinkSync(d)}catch{}i.renameSync(`${d}.download`,d)}if(r("progress:verify",{path:e.path}),(await U(d)).toLowerCase()!==String(e.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${e.path}`);return{downloadComplete:!0,verificationComplete:!0,targetPath:d}}async function Ct(n,e,f,r,p=!1,o=4,R=4,d,$){let S=new Set,g=[];for(let a of e.files||[]){if(!(p||!a.optional))continue;let t=j(a.path);t&&(S.has(t)||(S.add(t),g.push(a)))}let M=g.filter(a=>!(Array.isArray(a.parts)&&a.parts.length>0)),P=g.filter(a=>Array.isArray(a.parts)&&a.parts.length>0),L=M.concat(P),y=L.length,s=0,m=L.reduce((a,t)=>{let c=Number(t.size||0);return c>0?a+c:Array.isArray(t.parts)&&t.parts.length?a+t.parts.reduce((h,C)=>h+Number(C.size||0),0):a},0);try{r("progress:bytes:total",{totalBytes:m})}catch{}async function x(a,t,c,h=!1){let C=0,A=[];async function l(){for(;;){for(;$&&$();)if(await z(100),d?.cancelled)return;let T=C++;if(T>=a.length)return;let w=a[T],k=t+T,V=j(w.path),q=async()=>pt(n,w,f,r,R,d),X=!1,W=b.get(V);W?X=!0:(r("progress:start",{index:k,total:y,path:w.path,completed:s}),W=(async()=>{try{let D=await q();if(h&&D?.mergeAndVerifyAsync){let F=D.mergeAndVerifyAsync().then(N=>(N?.filePath&&(s+=1,r("progress:done",{index:k,total:y,path:N.filePath,completed:s})),N)).catch(async N=>{if(String(N?.message||N||"error").includes("cancelled"))throw N;try{let B=u.join(f,w.path.replace(/\\/g,u.sep));try{i.unlinkSync(B)}catch{}try{let H=i.readdirSync(u.dirname(B)),J=u.basename(B);H.forEach(_=>{if(_.startsWith(J+".part"))try{i.unlinkSync(u.join(u.dirname(B),_))}catch{}})}catch{}let v=await q();if(v.mergeAndVerifyAsync){let H=await v.mergeAndVerifyAsync();return H?.filePath&&(s+=1,r("progress:done",{index:k,total:y,path:H.filePath,completed:s})),H}return v}catch(B){try{r("progress:error",{path:w.path,message:String(B?.message||B)})}catch{}try{r("progress:done",{index:k,total:y,path:w.path,completed:s,error:!0})}catch{}throw B}});return A.push(F),{...D,skipProgressDone:!0}}return D}catch(D){if(String(D?.message||D||"error").includes("cancelled"))throw D;try{let N=u.join(f,w.path.replace(/\\/g,u.sep));try{i.unlinkSync(N)}catch{}let I=await q();if(h&&I?.mergeAndVerifyAsync){let B=I.mergeAndVerifyAsync().then(v=>(v?.filePath&&(s+=1,r("progress:done",{index:k,total:y,path:v.filePath,completed:s})),v)).catch(v=>{try{let H=u.join(f,w.path.replace(/\\/g,u.sep)),J=i.readdirSync(u.dirname(H)),_=u.basename(H);J.forEach(O=>{if(O.startsWith(_+".part"))try{i.unlinkSync(u.join(u.dirname(H),O))}catch{}})}catch{}try{r("progress:error",{path:w.path,message:String(v?.message||v)})}catch{}try{r("progress:done",{index:k,total:y,path:w.path,completed:s,error:!0})}catch{}throw v});return A.push(B),{...I,skipProgressDone:!0}}return I}catch(N){try{r("progress:error",{path:w.path,message:String(N?.message||N)})}catch{}try{r("progress:done",{index:k,total:y,path:w.path,completed:s,error:!0})}catch{}throw N}}})(),b.set(V,W));let Z;try{Z=await W}finally{X||b.delete(V)}Z?.skipProgressDone||(s+=1,r("progress:done",{index:k,total:y,path:w.path,completed:s})),await z(10)}}let E=Array.from({length:Math.max(1,c)},()=>l());if(await Promise.all(E),A.length>0){let w=(await Promise.allSettled(A)).filter(k=>k.status==="rejected");if(w.length>0)for(let k of w)console.error("Verification failed:",k.reason?.message||k.reason)}}if(await x(M,0,Math.max(1,o)),b.size>0)try{await Promise.all([...b.values()])}catch{}await x(P,M.length,1,!0)}export{Et as cancelToken,St as createCancelToken,Ct as downloadAll,pt as downloadFileObject,Pt as fetchChecksums,mt as setGlobalDownloadSpeed};
