import i from"node:fs";import f from"node:path";import at from"node:crypto";import{pipeline as nt}from"node:stream";import{promisify as st}from"node:util";import K from"node:https";var ot=st(nt);function Y(s){return String(s||"").replace(/\\/g,"/").replace(/^\/+/,"")}function O(s){return String(s||"").replace(/\\/g,"/").toLowerCase()}var V=new Map,j=new K.Agent({keepAlive:!0,maxSockets:64,maxFreeSockets:32,keepAliveMsecs:6e4,scheduling:"fifo"}),_=class{constructor(){this.maxBytesPerSecond=0,this.tokens=0,this.lastRefill=Date.now()}setMaxSpeed(e){this.maxBytesPerSecond=Math.max(0,e),this.tokens=this.maxBytesPerSecond}async consumeTokens(e){if(this.maxBytesPerSecond<=0)return;let l=Date.now(),r=(l-this.lastRefill)/1e3;if(this.tokens=Math.min(this.maxBytesPerSecond,this.tokens+r*this.maxBytesPerSecond),this.lastRefill=l,e>this.tokens){let o=(e-this.tokens)/this.maxBytesPerSecond*1e3;await z(o),this.tokens=0}else this.tokens-=e}},tt=new _;function gt(s){tt.setMaxSpeed(s)}function q(s){return new Promise((e,l)=>{let r=at.createHash("sha256"),c=i.createReadStream(s);c.on("error",l),c.on("end",()=>e(r.digest("hex"))),c.on("data",o=>r.update(o))})}function et(s){try{i.mkdirSync(s,{recursive:!0})}catch(e){if(e?.code==="ENOENT"){let r=s.split(f.sep).filter(Boolean),c="";for(let o of r){c=c?f.join(c,o):o.includes(":")?o+f.sep:o;try{i.accessSync(c)}catch{throw new Error(`Cannot create directory: parent path "${c}" does not exist or is not accessible. Please ensure the drive is available and you have write permissions.`)}}}throw e}}function ct(s){return new Promise((e,l)=>{let r=K.get(s,{agent:j},c=>{if(c.statusCode!==200){l(new Error(`HTTP ${c.statusCode} for ${s}`)),c.resume();return}let o="";c.setEncoding("utf8"),c.on("data",N=>o+=N),c.on("end",()=>{try{e(JSON.parse(o))}catch(N){l(N)}})});r.on("error",l),r.setTimeout(3e4,()=>{r.destroy(),l(new Error("JSON fetch timeout"))})})}function z(s){return new Promise(e=>setTimeout(e,s))}function mt(){return{cancelled:!1,requests:new Set}}function St(s){if(s){s.cancelled=!0;for(let e of s.requests)try{e.destroy(new Error("cancelled"))}catch{}s.requests.clear()}}var it=new Set(["ECONNRESET","ETIMEDOUT","EAI_AGAIN","ECONNABORTED","ENETRESET","EHOSTUNREACH","ENETUNREACH","EPIPE","ENOTFOUND","ECONNREFUSED","EHOSTDOWN","ENETDOWN","EPERM","EBUSY","EACCES"]);async function J(s,e,l,r=1,c,o=0,N=0){return new Promise((u,M)=>{et(f.dirname(e));let m;try{m=i.createWriteStream(e,{flags:o>0?"a":"w"})}catch(t){if(r<8&&(t.code==="EPERM"||t.code==="EBUSY"||t.code==="EACCES")){let d=Math.min(1e3*r,5e3);return z(d).then(()=>u(J(s,e,l,r+1,c,o,N)))}return M(t)}if(c?.cancelled)return m.close(()=>{}),M(new Error("cancelled"));let g=!1,$=t=>{g||(g=!0,u(t))},P=t=>{g||(g=!0,M(t))},R={agent:j};o>0&&(R.headers={Range:`bytes=${o}-`});let w=0,n=null,S=()=>new Promise(t=>{try{m.close(()=>t())}catch{t()}}),y=async(t,d=!1)=>{try{n&&clearInterval(n)}catch{}try{await S()}catch{}if(await z(100),d)try{i.unlinkSync(e)}catch{}if(r<8){let h=Math.min(1e3*Math.pow(1.5,r),15e3),k=Math.random()*1e3,v=h+k;return await z(v),$(J(s,e,l,r+1,c,t,N)),!0}return!1},a=K.get(s,R,t=>{if(t.statusCode!==200&&!(o>0&&t.statusCode===206)){if(g=!0,o>0&&t.statusCode===200){t.resume(),y(0,!0).then(p=>{p||M(new Error(`HTTP ${t.statusCode} for ${s}`))});return}if(o>0&&t.statusCode===416){t.resume(),y(0,!0).then(p=>{p||M(new Error(`HTTP ${t.statusCode} for ${s}`))});return}if(t.statusCode&&[429,500,502,503,504].includes(t.statusCode)&&r<5){t.resume(),y(o,!1).then(p=>{p||M(new Error(`HTTP ${t.statusCode} for ${s}`))});return}S().then(()=>{i.unlink(e,()=>{}),M(new Error(`HTTP ${t.statusCode} for ${s}`))}),t.resume();return}let d=Number(t.headers["content-length"]||0),h=N>0?N:o>0?o+d:d,k=Date.now(),v=r<=2?3e4:45e3;n=setInterval(()=>{if(!c?.cancelled&&Date.now()-k>v)try{let p=new Error("stalled");p.code="ETIMEDOUT",a.destroy(p)}catch{}},1e4),t.on("data",async p=>{await tt.consumeTokens(p.length),w+=p.length,k=Date.now(),l&&l(Math.min(o+w,h||o+w),h||0)}),t.on("aborted",async()=>{await y(o+w)||P(new Error("response aborted"))}),ot(t,m).then(()=>{try{n&&clearInterval(n)}catch{}$()}).catch(async p=>{try{n&&clearInterval(n)}catch{}let C=String(p?.message||p||"").toLowerCase();(C.includes("aborted")||C.includes("socket")||C.includes("closed"))&&await y(o+w)||P(p)})});if(c?.requests.add(a),a.on("socket",t=>{try{t.setKeepAlive(!0,6e4),t.setNoDelay(!0),t.setRecvBufferSize&&t.setRecvBufferSize(64*1024),t.setSendBufferSize&&t.setSendBufferSize(64*1024)}catch{}}),a.on("close",()=>c?.requests.delete(a)),a.setTimeout(9e4,()=>{try{let t=new Error("Request timeout");t.code="ETIMEDOUT",a.destroy(t)}catch{}}),c?.cancelled)try{a.destroy(new Error("cancelled"))}catch{}a.on("error",async t=>{let d=t?.code,h=String(t?.message||"").toLowerCase(),k=h.includes("aborted")||h.includes("socket")||h.includes("closed");if(r<8&&(k||d&&it.has(String(d)))){let p=o;try{p=i.statSync(e).size}catch{}await y(p)||P(t)}else{let p=new Promise(C=>{try{m.close(()=>C())}catch{C()}});try{await p}catch{}P(t)}})})}async function ht(s,e,l){try{let r=i.statSync(s);return l&&Number(l)>0&&r.size!==Number(l)?!1:(await q(s)).toLowerCase()===String(e).toLowerCase()}catch{return!1}}async function Et(s){let e=`${s.replace(/\/$/,"")}/checksums.json`;return ct(e)}async function lt(s,e,l,r,c=4,o){let N=Y(e.path).split("/").join(f.sep),u=f.join(l,N);if(et(f.dirname(u)),await ht(u,e.checksum,e.size))return r("progress:skip",{path:e.path}),{downloadComplete:!0,verificationComplete:!0,targetPath:u};if(o?.cancelled)throw new Error("cancelled");if(Array.isArray(e.parts)&&e.parts.length>0){let m=e.parts.length,g=new Array(m),$=0,P=new Set;async function R(){for(;;){let n=$++;if(n>=m)return;if(P.has(n))continue;P.add(n);let S=e.parts[n],y=Y(S.path),a=`${s.replace(/\/$/,"")}/${y}`,t=`${u}.part${n}`;try{if(i.existsSync(t))if((await q(t)).toLowerCase()===String(S.checksum).toLowerCase()){r("progress:part",{path:e.path,part:n,totalParts:m,received:Number(S.size||0),total:Number(S.size||0)}),g[n]=t;continue}else try{i.unlinkSync(t)}catch{}}catch{}let d=0;for(;;){if(o?.cancelled)throw new Error("cancelled");d+=1;let h=0,k=0;try{let C=0;try{C=i.statSync(t).size}catch{}let T=Number(S.size||0);if(T>0&&C>T)try{i.unlinkSync(t),C=0}catch{}await J(a,t,(E,H)=>{let b=Math.max(0,E-k);k=E;try{b>0&&r("progress:bytes",{delta:b})}catch{}h+=b;let I=T||H||0;r("progress:part",{path:e.path,part:n,totalParts:m,received:Math.min(E,I||E),total:I})},1,o,C,T)}catch{try{i.unlinkSync(t)}catch{}try{h>0&&r("progress:bytes",{delta:-h})}catch{}try{r("progress:part:reset",{path:e.path,part:n,totalParts:m})}catch{}let T=Math.min(2e3*d,1e4);await z(T);continue}if((await q(t)).toLowerCase()===String(S.checksum).toLowerCase())break;try{i.unlinkSync(t)}catch{}try{h>0&&r("progress:bytes",{delta:-h})}catch{}try{r("progress:part:reset",{path:e.path,part:n,totalParts:m})}catch{}let p=Math.min(2e3*d,1e4);await z(p)}g[n]=t}}let w=Array.from({length:Math.max(1,c)},()=>R());return await Promise.all(w),{downloadComplete:!0,verificationComplete:!1,targetPath:u,mergeAndVerifyAsync:async()=>{r("progress:merge:start",{path:e.path,parts:g.length});let n=i.createWriteStream(u);for(let y=0;y<g.length;y++){let a=g[y];r("progress:merge:part",{path:e.path,part:y,totalParts:g.length}),await new Promise((t,d)=>{let h=i.createReadStream(a);h.on("error",d),n.on("error",d),h.on("end",()=>{try{i.unlinkSync(a)}catch{}t()}),h.pipe(n,{end:!1})})}await new Promise((y,a)=>{n.on("error",a),n.on("finish",y),n.end()});try{r("progress:merge:done",{path:e.path})}catch{}if(r("progress:verify",{path:e.path}),(await q(u)).toLowerCase()!==String(e.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${e.path}`);try{let y=i.readdirSync(f.dirname(u)),a=f.basename(u);y.forEach(t=>{if(t.startsWith(a+".part"))try{i.unlinkSync(f.join(f.dirname(u),t))}catch{}})}catch{}return{verificationComplete:!0,targetPath:u,filePath:e.path}}}}else{let m=Y(e.path),g=`${s.replace(/\/$/,"")}/${m}`,$=0;for(;;){$+=1;let P=0,R=0,w=`${u}.download`,n=0;try{n=i.statSync(w).size}catch{}let S=Number(e.size||0);if(S>0&&n>S)try{i.unlinkSync(w),n=0}catch{}if(await J(g,w,(a,t)=>{let d=Math.max(0,a-R);R=a;try{d>0&&r("progress:bytes",{delta:d})}catch{}P+=d;let h=S||t||0;r("progress:file",{path:e.path,received:Math.min(a,h||a),total:h})},1,o,n,S),(await q(w)).toLowerCase()===String(e.checksum).toLowerCase())break;try{i.unlinkSync(w)}catch{}try{P>0&&r("progress:bytes",{delta:-P})}catch{}if($>=2)throw new Error(`Checksum mismatch for ${e.path}`)}try{i.unlinkSync(u)}catch{}i.renameSync(`${u}.download`,u)}if(r("progress:verify",{path:e.path}),(await q(u)).toLowerCase()!==String(e.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${e.path}`);return{downloadComplete:!0,verificationComplete:!0,targetPath:u}}async function Pt(s,e,l,r,c=!1,o=4,N=4,u,M){let m=new Set,g=[];for(let a of e.files||[]){if(!(c||!a.optional))continue;let t=O(a.path);t&&(m.has(t)||(m.add(t),g.push(a)))}let $=g.filter(a=>!(Array.isArray(a.parts)&&a.parts.length>0)),P=g.filter(a=>Array.isArray(a.parts)&&a.parts.length>0),R=$.concat(P),w=R.length,n=0,S=R.reduce((a,t)=>{let d=Number(t.size||0);return d>0?a+d:Array.isArray(t.parts)&&t.parts.length?a+t.parts.reduce((h,k)=>h+Number(k.size||0),0):a},0);try{r("progress:bytes:total",{totalBytes:S})}catch{}async function y(a,t,d,h=!1){let k=0,v=[];async function p(){for(;;){for(;M&&M();)if(await z(100),u?.cancelled)return;let T=k++;if(T>=a.length)return;let E=a[T],H=t+T,b=O(E.path),I=async()=>lt(s,E,l,r,N,u),Q=!1,W=V.get(b);W?Q=!0:(r("progress:start",{index:H,total:w,path:E.path,completed:n}),W=(async()=>{try{let D=await I();if(h&&D?.mergeAndVerifyAsync){let Z=D.mergeAndVerifyAsync().then(A=>(A?.filePath&&(n+=1,r("progress:done",{index:H,total:w,path:A.filePath,completed:n})),A)).catch(A=>{if(String(A?.message||A||"error").includes("cancelled"))throw A;try{let B=f.join(l,E.path.replace(/\\/g,f.sep));try{i.unlinkSync(B)}catch{}try{let x=i.readdirSync(f.dirname(B)),L=f.basename(B);x.forEach(G=>{if(G.startsWith(L+".part"))try{i.unlinkSync(f.join(f.dirname(B),G))}catch{}})}catch{}return I().then(x=>x.mergeAndVerifyAsync?x.mergeAndVerifyAsync().then(L=>(L?.filePath&&(n+=1,r("progress:done",{index:H,total:w,path:L.filePath,completed:n})),L)):x)}catch(B){try{r("progress:error",{path:E.path,message:String(B?.message||B)})}catch{}throw B}});return v.push(Z),{...D,skipProgressDone:!0}}return D}catch(D){if(String(D?.message||D||"error").includes("cancelled"))throw D;try{let A=f.join(l,E.path.replace(/\\/g,f.sep));try{i.unlinkSync(A)}catch{}let U=await I();if(h&&U?.mergeAndVerifyAsync){let B=U.mergeAndVerifyAsync().then(x=>(x?.filePath&&(n+=1,r("progress:done",{index:H,total:w,path:x.filePath,completed:n})),x)).catch(x=>{try{let L=f.join(l,E.path.replace(/\\/g,f.sep)),G=i.readdirSync(f.dirname(L)),rt=f.basename(L);G.forEach(F=>{if(F.startsWith(rt+".part"))try{i.unlinkSync(f.join(f.dirname(L),F))}catch{}})}catch{}try{r("progress:error",{path:E.path,message:String(x?.message||x)})}catch{}throw x});return v.push(B),{...U,skipProgressDone:!0}}return U}catch(A){try{r("progress:error",{path:E.path,message:String(A?.message||A)})}catch{}throw A}}})(),V.set(b,W));let X;try{X=await W}finally{Q||V.delete(b)}X?.skipProgressDone||(n+=1,r("progress:done",{index:H,total:w,path:E.path,completed:n})),await z(10)}}let C=Array.from({length:Math.max(1,d)},()=>p());await Promise.all(C),v.length>0&&await Promise.all(v)}if(await y($,0,Math.max(1,o)),V.size>0)try{await Promise.all([...V.values()])}catch{}await y(P,$.length,1,!0)}export{St as cancelToken,mt as createCancelToken,Pt as downloadAll,lt as downloadFileObject,Et as fetchChecksums,gt as setGlobalDownloadSpeed};
