import i from"node:fs";import p from"node:path";import at from"node:crypto";import{pipeline as st}from"node:stream";import{promisify as nt}from"node:util";import Q from"node:https";var ot=nt(st);function Y(s){return String(s||"").replace(/\\/g,"/").replace(/^\/+/,"")}function j(s){return String(s||"").replace(/\\/g,"/").toLowerCase()}var b=new Map,tt=new Q.Agent({keepAlive:!0,maxSockets:64,maxFreeSockets:32,keepAliveMsecs:6e4,scheduling:"fifo"}),K=class{constructor(){this.maxBytesPerSecond=0,this.tokens=0,this.lastRefill=Date.now()}setMaxSpeed(e){this.maxBytesPerSecond=Math.max(0,e),this.tokens=this.maxBytesPerSecond}async consumeTokens(e){if(this.maxBytesPerSecond<=0)return;let f=Date.now(),r=(f-this.lastRefill)/1e3;if(this.tokens=Math.min(this.maxBytesPerSecond,this.tokens+r*this.maxBytesPerSecond),this.lastRefill=f,e>this.tokens){let c=(e-this.tokens)/this.maxBytesPerSecond*1e3;await z(c),this.tokens=0}else this.tokens-=e}},et=new K;function gt(s){et.setMaxSpeed(s)}function q(s){return new Promise((e,f)=>{let r=at.createHash("sha256"),h=i.createReadStream(s);h.on("error",f),h.on("end",()=>e(r.digest("hex"))),h.on("data",c=>r.update(c))})}function rt(s){try{i.mkdirSync(s,{recursive:!0})}catch(e){if(e?.code==="ENOENT"){let r=s.split(p.sep).filter(Boolean),h="";for(let c of r){h=h?p.join(h,c):c.includes(":")?c+p.sep:c;try{i.accessSync(h)}catch{throw new Error(`Cannot create directory: parent path "${h}" does not exist or is not accessible. Please ensure the drive is available and you have write permissions.`)}}}throw e}}function ct(s){return new Promise((e,f)=>{let r=Q.get(s,{agent:tt},h=>{if(h.statusCode!==200){f(new Error(`HTTP ${h.statusCode} for ${s}`)),h.resume();return}let c="";h.setEncoding("utf8"),h.on("data",$=>c+=$),h.on("end",()=>{try{e(JSON.parse(c))}catch($){f($)}})});r.on("error",f),r.setTimeout(3e4,()=>{r.destroy(),f(new Error("JSON fetch timeout"))})})}function z(s){return new Promise(e=>setTimeout(e,s))}function mt(){return{cancelled:!1,requests:new Set}}function St(s){if(s){s.cancelled=!0;for(let e of s.requests)try{e.destroy(new Error("cancelled"))}catch{}s.requests.clear()}}var it=new Set(["ECONNRESET","ETIMEDOUT","EAI_AGAIN","ECONNABORTED","ENETRESET","EHOSTUNREACH","ENETUNREACH","EPIPE","ENOTFOUND","ECONNREFUSED","EHOSTDOWN","ENETDOWN","EPERM","EBUSY","EACCES"]);async function G(s,e,f,r=1,h,c=0,$=0){return new Promise((u,R)=>{rt(p.dirname(e));let S;try{S=i.createWriteStream(e,{flags:c>0?"a":"w"})}catch(t){if(r<8&&(t.code==="EPERM"||t.code==="EBUSY"||t.code==="EACCES")){let o=Math.min(1e3*r,5e3);return z(o).then(()=>u(G(s,e,f,r+1,h,c,$)))}return R(t)}if(h?.cancelled)return S.close(()=>{}),R(new Error("cancelled"));let g=!1,M=t=>{g||(g=!0,u(t))},P=t=>{g||(g=!0,R(t))},B={agent:tt};c>0&&(B.headers={Range:`bytes=${c}-`});let y=0,n=null,m=()=>new Promise(t=>{try{S.close(()=>t())}catch{t()}}),x=async(t,o=!1)=>{try{n&&clearInterval(n)}catch{}try{await m()}catch{}if(await z(100),o)try{i.unlinkSync(e)}catch{}if(r<8){let l=Math.min(1e3*Math.pow(1.5,r),15e3),C=Math.random()*1e3,A=l+C;return await z(A),M(G(s,e,f,r+1,h,t,$)),!0}return!1},a=Q.get(s,B,t=>{if(t.statusCode!==200&&!(c>0&&t.statusCode===206)){if(g=!0,c>0&&t.statusCode===200){t.resume(),x(0,!0).then(d=>{d||R(new Error(`HTTP ${t.statusCode} for ${s}`))});return}if(c>0&&t.statusCode===416){t.resume(),x(0,!0).then(d=>{d||R(new Error(`HTTP ${t.statusCode} for ${s}`))});return}if(t.statusCode&&[429,500,502,503,504].includes(t.statusCode)&&r<5){t.resume(),x(c,!1).then(d=>{d||R(new Error(`HTTP ${t.statusCode} for ${s}`))});return}m().then(()=>{i.unlink(e,()=>{}),R(new Error(`HTTP ${t.statusCode} for ${s}`))}),t.resume();return}let o=Number(t.headers["content-length"]||0),l=$>0?$:c>0?c+o:o,C=Date.now(),A=r<=2?3e4:45e3;n=setInterval(()=>{if(!h?.cancelled&&Date.now()-C>A)try{let d=new Error("stalled");d.code="ETIMEDOUT",a.destroy(d)}catch{}},1e4),t.on("data",async d=>{await et.consumeTokens(d.length),y+=d.length,C=Date.now(),f&&f(Math.min(c+y,l||c+y),l||0)}),t.on("aborted",async()=>{await x(c+y)||P(new Error("response aborted"))}),ot(t,S).then(()=>{try{n&&clearInterval(n)}catch{}M()}).catch(async d=>{try{n&&clearInterval(n)}catch{}let E=String(d?.message||d||"").toLowerCase();(E.includes("aborted")||E.includes("socket")||E.includes("closed"))&&await x(c+y)||P(d)})});if(h?.requests.add(a),a.on("socket",t=>{try{t.setKeepAlive(!0,6e4),t.setNoDelay(!0),t.setRecvBufferSize&&t.setRecvBufferSize(64*1024),t.setSendBufferSize&&t.setSendBufferSize(64*1024)}catch{}}),a.on("close",()=>h?.requests.delete(a)),a.setTimeout(9e4,()=>{try{let t=new Error("Request timeout");t.code="ETIMEDOUT",a.destroy(t)}catch{}}),h?.cancelled)try{a.destroy(new Error("cancelled"))}catch{}a.on("error",async t=>{let o=t?.code,l=String(t?.message||"").toLowerCase(),C=l.includes("aborted")||l.includes("socket")||l.includes("closed");if(r<8&&(C||o&&it.has(String(o)))){let d=c;try{d=i.statSync(e).size}catch{}await x(d)||P(t)}else{let d=new Promise(E=>{try{S.close(()=>E())}catch{E()}});try{await d}catch{}P(t)}})})}async function ht(s,e,f){try{let r=i.statSync(s);return f&&Number(f)>0&&r.size!==Number(f)?!1:(await q(s)).toLowerCase()===String(e).toLowerCase()}catch{return!1}}async function Et(s){let e=`${s.replace(/\/$/,"")}/checksums.json`;return ct(e)}async function lt(s,e,f,r,h=4,c){let $=Y(e.path).split("/").join(p.sep),u=p.join(f,$);if(rt(p.dirname(u)),await ht(u,e.checksum,e.size))return r("progress:skip",{path:e.path}),{downloadComplete:!0,verificationComplete:!0,targetPath:u};if(c?.cancelled)throw new Error("cancelled");if(Array.isArray(e.parts)&&e.parts.length>0){let S=e.parts.length,g=new Array(S),M=0,P=new Set;async function B(){for(;;){let n=M++;if(n>=S)return;if(P.has(n))continue;P.add(n);let m=e.parts[n],x=Y(m.path),a=`${s.replace(/\/$/,"")}/${x}`,t=`${u}.part${n}`;try{if(i.existsSync(t))if((await q(t)).toLowerCase()===String(m.checksum).toLowerCase()){r("progress:part",{path:e.path,part:n,totalParts:S,received:Number(m.size||0),total:Number(m.size||0)}),g[n]=t;continue}else try{i.unlinkSync(t)}catch{}}catch{}let o=0;for(;;){if(c?.cancelled)throw new Error("cancelled");o+=1;let l=0,C=0;try{let E=0;try{E=i.statSync(t).size}catch{}let T=Number(m.size||0);if(T>0&&E>T)try{i.unlinkSync(t),E=0}catch{}await G(a,t,(w,k)=>{let I=Math.max(0,w-C);C=w;try{I>0&&r("progress:bytes",{delta:I})}catch{}l+=I;let V=T||k||0;r("progress:part",{path:e.path,part:n,totalParts:S,received:Math.min(w,V||w),total:V})},1,c,E,T)}catch{try{i.unlinkSync(t)}catch{}try{l>0&&r("progress:bytes",{delta:-l})}catch{}try{r("progress:part:reset",{path:e.path,part:n,totalParts:S})}catch{}let T=Math.min(2e3*o,1e4);await z(T);continue}if((await q(t)).toLowerCase()===String(m.checksum).toLowerCase())break;try{i.unlinkSync(t)}catch{}try{l>0&&r("progress:bytes",{delta:-l})}catch{}try{r("progress:part:reset",{path:e.path,part:n,totalParts:S})}catch{}let d=Math.min(2e3*o,1e4);await z(d)}g[n]=t}}let y=Array.from({length:Math.max(1,h)},()=>B());return await Promise.all(y),{downloadComplete:!0,verificationComplete:!1,targetPath:u,mergeAndVerifyAsync:async()=>{r("progress:merge:start",{path:e.path,parts:g.length});let n=5*60*1e3,m=async()=>{let a=i.createWriteStream(u),t=null;try{for(let o=0;o<g.length;o++){let l=g[o];if(!l)throw new Error(`Part ${o} path is undefined for ${e.path}`);r("progress:merge:part",{path:e.path,part:o,totalParts:g.length}),await new Promise((C,A)=>{if(!i.existsSync(l)){A(new Error(`Part file missing: ${l}`));return}let d=i.createReadStream(l);d.on("error",A),t||(t=E=>A(E),a.on("error",t)),d.on("end",()=>{try{i.unlinkSync(l)}catch{}C()}),d.pipe(a,{end:!1})})}await new Promise((o,l)=>{a.on("finish",o),a.end()})}catch(o){try{a.destroy()}catch{}throw o}};await Promise.race([m(),new Promise((a,t)=>setTimeout(()=>t(new Error(`Merge timeout for ${e.path}`)),n))]);try{r("progress:merge:done",{path:e.path})}catch{}if(r("progress:verify",{path:e.path}),(await q(u)).toLowerCase()!==String(e.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${e.path}`);try{let a=i.readdirSync(p.dirname(u)),t=p.basename(u);a.forEach(o=>{if(o.startsWith(t+".part"))try{i.unlinkSync(p.join(p.dirname(u),o))}catch{}})}catch{}return{verificationComplete:!0,targetPath:u,filePath:e.path}}}}else{let S=Y(e.path),g=`${s.replace(/\/$/,"")}/${S}`,M=0;for(;;){M+=1;let P=0,B=0,y=`${u}.download`,n=0;try{n=i.statSync(y).size}catch{}let m=Number(e.size||0);if(m>0&&n>m)try{i.unlinkSync(y),n=0}catch{}if(await G(g,y,(a,t)=>{let o=Math.max(0,a-B);B=a;try{o>0&&r("progress:bytes",{delta:o})}catch{}P+=o;let l=m||t||0;r("progress:file",{path:e.path,received:Math.min(a,l||a),total:l})},1,c,n,m),(await q(y)).toLowerCase()===String(e.checksum).toLowerCase())break;try{i.unlinkSync(y)}catch{}try{P>0&&r("progress:bytes",{delta:-P})}catch{}if(M>=2)throw new Error(`Checksum mismatch for ${e.path}`)}try{i.unlinkSync(u)}catch{}i.renameSync(`${u}.download`,u)}if(r("progress:verify",{path:e.path}),(await q(u)).toLowerCase()!==String(e.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${e.path}`);return{downloadComplete:!0,verificationComplete:!0,targetPath:u}}async function Pt(s,e,f,r,h=!1,c=4,$=4,u,R){let S=new Set,g=[];for(let a of e.files||[]){if(!(h||!a.optional))continue;let t=j(a.path);t&&(S.has(t)||(S.add(t),g.push(a)))}let M=g.filter(a=>!(Array.isArray(a.parts)&&a.parts.length>0)),P=g.filter(a=>Array.isArray(a.parts)&&a.parts.length>0),B=M.concat(P),y=B.length,n=0,m=B.reduce((a,t)=>{let o=Number(t.size||0);return o>0?a+o:Array.isArray(t.parts)&&t.parts.length?a+t.parts.reduce((l,C)=>l+Number(C.size||0),0):a},0);try{r("progress:bytes:total",{totalBytes:m})}catch{}async function x(a,t,o,l=!1){let C=0,A=[];async function d(){for(;;){for(;R&&R();)if(await z(100),u?.cancelled)return;let T=C++;if(T>=a.length)return;let w=a[T],k=t+T,I=j(w.path),V=async()=>lt(s,w,f,r,$,u),X=!1,W=b.get(I);W?X=!0:(r("progress:start",{index:k,total:y,path:w.path,completed:n}),W=(async()=>{try{let H=await V();if(l&&H?.mergeAndVerifyAsync){let F=H.mergeAndVerifyAsync().then(N=>(N?.filePath&&(n+=1,r("progress:done",{index:k,total:y,path:N.filePath,completed:n})),N)).catch(async N=>{if(String(N?.message||N||"error").includes("cancelled"))throw N;try{let L=p.join(f,w.path.replace(/\\/g,p.sep));try{i.unlinkSync(L)}catch{}try{let D=i.readdirSync(p.dirname(L)),J=p.basename(L);D.forEach(_=>{if(_.startsWith(J+".part"))try{i.unlinkSync(p.join(p.dirname(L),_))}catch{}})}catch{}let v=await V();if(v.mergeAndVerifyAsync){let D=await v.mergeAndVerifyAsync();return D?.filePath&&(n+=1,r("progress:done",{index:k,total:y,path:D.filePath,completed:n})),D}return v}catch(L){try{r("progress:error",{path:w.path,message:String(L?.message||L)})}catch{}try{r("progress:done",{index:k,total:y,path:w.path,completed:n,error:!0})}catch{}throw L}});return A.push(F),{...H,skipProgressDone:!0}}return H}catch(H){if(String(H?.message||H||"error").includes("cancelled"))throw H;try{let N=p.join(f,w.path.replace(/\\/g,p.sep));try{i.unlinkSync(N)}catch{}let U=await V();if(l&&U?.mergeAndVerifyAsync){let L=U.mergeAndVerifyAsync().then(v=>(v?.filePath&&(n+=1,r("progress:done",{index:k,total:y,path:v.filePath,completed:n})),v)).catch(v=>{try{let D=p.join(f,w.path.replace(/\\/g,p.sep)),J=i.readdirSync(p.dirname(D)),_=p.basename(D);J.forEach(O=>{if(O.startsWith(_+".part"))try{i.unlinkSync(p.join(p.dirname(D),O))}catch{}})}catch{}try{r("progress:error",{path:w.path,message:String(v?.message||v)})}catch{}try{r("progress:done",{index:k,total:y,path:w.path,completed:n,error:!0})}catch{}throw v});return A.push(L),{...U,skipProgressDone:!0}}return U}catch(N){try{r("progress:error",{path:w.path,message:String(N?.message||N)})}catch{}try{r("progress:done",{index:k,total:y,path:w.path,completed:n,error:!0})}catch{}throw N}}})(),b.set(I,W));let Z;try{Z=await W}finally{X||b.delete(I)}Z?.skipProgressDone||(n+=1,r("progress:done",{index:k,total:y,path:w.path,completed:n})),await z(10)}}let E=Array.from({length:Math.max(1,o)},()=>d());if(await Promise.all(E),A.length>0){let w=(await Promise.allSettled(A)).filter(k=>k.status==="rejected");if(w.length>0)for(let k of w)console.error("Verification failed:",k.reason?.message||k.reason)}}if(await x(M,0,Math.max(1,c)),b.size>0)try{await Promise.all([...b.values()])}catch{}await x(P,M.length,1,!0)}export{St as cancelToken,mt as createCancelToken,Pt as downloadAll,lt as downloadFileObject,Et as fetchChecksums,gt as setGlobalDownloadSpeed};
