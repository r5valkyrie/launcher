import i from"node:fs";import d from"node:path";import rt from"node:crypto";import{pipeline as nt}from"node:stream";import{promisify as st}from"node:util";import Q from"node:https";var ct=st(nt);function _(n){return String(n||"").replace(/\\/g,"/").replace(/^\/+/,"")}function j(n){return String(n||"").replace(/\\/g,"/").toLowerCase()}var U=new Map,tt=new Q.Agent({keepAlive:!0,maxSockets:64,maxFreeSockets:32,keepAliveMsecs:6e4,scheduling:"fifo"}),K=class{constructor(){this.maxBytesPerSecond=0,this.tokens=0,this.lastRefill=Date.now()}setMaxSpeed(t){this.maxBytesPerSecond=Math.max(0,t),this.tokens=this.maxBytesPerSecond}isEnabled(){return this.maxBytesPerSecond>0}async consumeTokens(t){if(this.maxBytesPerSecond<=0)return;let h=Date.now(),e=(h-this.lastRefill)/1e3;if(this.tokens=Math.min(this.maxBytesPerSecond,this.tokens+e*this.maxBytesPerSecond),this.lastRefill=h,t>this.tokens){let p=(t-this.tokens)/this.maxBytesPerSecond*1e3;await D(p),this.tokens=0}else this.tokens-=t}},Y=new K;function wt(n){Y.setMaxSpeed(n)}function I(n){return new Promise((t,h)=>{let e=rt.createHash("sha256"),l=i.createReadStream(n);l.on("error",h),l.on("end",()=>t(e.digest("hex"))),l.on("data",p=>e.update(p))})}function et(n){i.mkdirSync(n,{recursive:!0})}function ot(n){return new Promise((t,h)=>{let e=Q.get(n,{agent:tt},l=>{if(l.statusCode!==200){h(new Error(`HTTP ${l.statusCode} for ${n}`)),l.resume();return}let p="";l.setEncoding("utf8"),l.on("data",P=>p+=P),l.on("end",()=>{try{t(JSON.parse(p))}catch(P){h(P)}})});e.on("error",h),e.setTimeout(3e4,()=>{e.destroy(),h(new Error("JSON fetch timeout"))})})}function D(n){return new Promise(t=>setTimeout(t,n))}function mt(){return{cancelled:!1,requests:new Set}}function St(n){if(n){n.cancelled=!0;for(let t of n.requests)try{t.destroy(new Error("cancelled"))}catch{}n.requests.clear()}}var it=new Set(["ECONNRESET","ETIMEDOUT","EAI_AGAIN","ECONNABORTED","ENETRESET","EHOSTUNREACH","ENETUNREACH","EPIPE","ENOTFOUND","ECONNREFUSED","EHOSTDOWN","ENETDOWN"]);async function b(n,t,h,e=1,l,p=0,P=0){return new Promise((f,T)=>{et(d.dirname(t));let S=i.createWriteStream(t,{flags:p>0?"a":"w"});if(l?.cancelled)return S.close(()=>{}),T(new Error("cancelled"));let k={agent:tt};p>0&&(k.headers={Range:`bytes=${p}-`});let g=Q.get(n,k,r=>{if(r.statusCode!==200&&!(p>0&&r.statusCode===206)){if(S.close(()=>{}),p>0&&r.statusCode===200){try{i.unlinkSync(t)}catch{}let o=Math.min(2e3*e,1e4);r.resume();try{g.destroy(new Error("restart:range-ignored"))}catch{}return D(o).then(()=>f(b(n,t,h,e+1,l,0,P)))}if(i.unlink(t,()=>{}),r.statusCode&&[429,500,502,503,504].includes(r.statusCode)&&e<5){let o=Math.min(2e3*e,1e4);return r.resume(),D(o).then(()=>f(b(n,t,h,e+1,l,p,P)))}T(new Error(`HTTP ${r.statusCode} for ${n}`)),r.resume();return}let A=Number(r.headers["content-length"]||0),m=P>0?P:p>0?p+A:A,a=0,u=Date.now(),w=Date.now(),c=e<=2?3e4:45e3,s=setInterval(()=>{if(!l?.cancelled&&Date.now()-w>c)try{let o=new Error("stalled");o.code="ETIMEDOUT",g.destroy(o)}catch{}},1e4);r.on("data",async o=>{w=Date.now(),a+=o.length,u=Date.now(),h&&h(Math.min(p+a,m||p+a),m||0),Y.isEnabled()&&(r.pause(),await Y.consumeTokens(o.length),r.resume())}),r.on("aborted",async()=>{let o=new Promise(y=>S.close(()=>y()));try{clearInterval(s)}catch{}try{await o}catch{}if(e<5){let y=Math.min(2e3*e,1e4);return D(y).then(()=>f(b(n,t,h,e+1,l,p+a,P)))}T(new Error("response aborted"))}),ct(r,S).then(()=>{try{clearInterval(s)}catch{}f()}).catch(o=>{try{clearInterval(s)}catch{}T(o)})});if(l?.requests.add(g),g.on("socket",r=>{try{r.setKeepAlive(!0,6e4),r.setNoDelay(!0),r.setRecvBufferSize&&r.setRecvBufferSize(64*1024),r.setSendBufferSize&&r.setSendBufferSize(64*1024)}catch{}}),g.on("close",()=>l?.requests.delete(g)),g.setTimeout(9e4,()=>{try{let r=new Error("Request timeout");r.code="ETIMEDOUT",g.destroy(r)}catch{}}),l?.cancelled)try{g.destroy(new Error("cancelled"))}catch{}g.on("error",async r=>{let A=r?.code,m=e<8&&A&&it.has(String(A)),a=new Promise(u=>{try{S.close(()=>u())}catch{u()}});try{await a}catch{}if(m){let u=Math.min(1e3*Math.pow(1.5,e),15e3),w=Math.random()*1e3,c=u+w,s=p;try{s=i.statSync(t).size}catch{}return D(c).then(()=>f(b(n,t,h,e+1,l,s,P)))}T(r)})})}async function ht(n,t,h){try{let e=i.statSync(n);return h&&Number(h)>0&&e.size!==Number(h)?!1:(await I(n)).toLowerCase()===String(t).toLowerCase()}catch{return!1}}async function Et(n){let t=`${n.replace(/\/$/,"")}/checksums.json`;return ot(t)}async function lt(n,t,h,e,l=4,p){let P=_(t.path).split("/").join(d.sep),f=d.join(h,P);if(et(d.dirname(f)),await ht(f,t.checksum,t.size))return e("progress:skip",{path:t.path}),{downloadComplete:!0,verificationComplete:!0,targetPath:f};if(p?.cancelled)throw new Error("cancelled");if(Array.isArray(t.parts)&&t.parts.length>0){let S=t.parts.length,k=new Array(S),g=0,r=new Set;async function A(){for(;;){let a=g++;if(a>=S)return;if(r.has(a))continue;r.add(a);let u=t.parts[a],w=_(u.path),c=`${n.replace(/\/$/,"")}/${w}`,s=`${f}.part${a}`;try{if(i.existsSync(s))if((await I(s)).toLowerCase()===String(u.checksum).toLowerCase()){e("progress:part",{path:t.path,part:a,totalParts:S,received:Number(u.size||0),total:Number(u.size||0)}),k[a]=s;continue}else try{i.unlinkSync(s)}catch{}}catch{}let o=0;for(;;){if(p?.cancelled)throw new Error("cancelled");o+=1;let y=0,z=0;try{let B=0;try{B=i.statSync(s).size}catch{}let N=Number(u.size||0);if(N>0&&B>N)try{i.unlinkSync(s),B=0}catch{}await b(c,s,(E,L)=>{let v=Math.max(0,E-z);z=E;try{v>0&&e("progress:bytes",{delta:v})}catch{}y+=v;let H=N||L||0;e("progress:part",{path:t.path,part:a,totalParts:S,received:Math.min(E,H||E),total:H})},1,p,B,N)}catch{try{i.unlinkSync(s)}catch{}try{y>0&&e("progress:bytes",{delta:-y})}catch{}try{e("progress:part:reset",{path:t.path,part:a,totalParts:S})}catch{}let N=Math.min(2e3*o,1e4);await D(N);continue}if((await I(s)).toLowerCase()===String(u.checksum).toLowerCase())break;try{i.unlinkSync(s)}catch{}try{y>0&&e("progress:bytes",{delta:-y})}catch{}try{e("progress:part:reset",{path:t.path,part:a,totalParts:S})}catch{}let J=Math.min(2e3*o,1e4);await D(J)}k[a]=s}}let m=Array.from({length:Math.max(1,l)},()=>A());return await Promise.all(m),{downloadComplete:!0,verificationComplete:!1,targetPath:f,mergeAndVerifyAsync:async()=>{e("progress:merge:start",{path:t.path,parts:k.length});let a=i.createWriteStream(f);for(let w=0;w<k.length;w++){let c=k[w];e("progress:merge:part",{path:t.path,part:w,totalParts:k.length}),await new Promise((s,o)=>{let y=i.createReadStream(c);y.on("error",o),a.on("error",o),y.on("end",()=>{try{i.unlinkSync(c)}catch{}s()}),y.pipe(a,{end:!1})})}await new Promise((w,c)=>{a.on("error",c),a.on("finish",w),a.end()});try{e("progress:merge:done",{path:t.path})}catch{}if(e("progress:verify",{path:t.path}),(await I(f)).toLowerCase()!==String(t.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${t.path}`);try{let w=i.readdirSync(d.dirname(f)),c=d.basename(f);w.forEach(s=>{if(s.startsWith(c+".part"))try{i.unlinkSync(d.join(d.dirname(f),s))}catch{}})}catch{}return{verificationComplete:!0,targetPath:f,filePath:t.path}}}}else{let S=_(t.path),k=`${n.replace(/\/$/,"")}/${S}`,g=0;for(;;){g+=1;let r=0,A=0,m=`${f}.download`,a=0;try{a=i.statSync(m).size}catch{}let u=Number(t.size||0);if(u>0&&a>u)try{i.unlinkSync(m),a=0}catch{}if(await b(k,m,(c,s)=>{let o=Math.max(0,c-A);A=c;try{o>0&&e("progress:bytes",{delta:o})}catch{}r+=o;let y=u||s||0;e("progress:file",{path:t.path,received:Math.min(c,y||c),total:y})},1,p,a,u),(await I(m)).toLowerCase()===String(t.checksum).toLowerCase())break;try{i.unlinkSync(m)}catch{}try{r>0&&e("progress:bytes",{delta:-r})}catch{}if(g>=2)throw new Error(`Checksum mismatch for ${t.path}`)}try{i.unlinkSync(f)}catch{}i.renameSync(`${f}.download`,f)}if(e("progress:verify",{path:t.path}),(await I(f)).toLowerCase()!==String(t.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${t.path}`);return{downloadComplete:!0,verificationComplete:!0,targetPath:f}}async function kt(n,t,h,e,l=!1,p=4,P=4,f,T){let S=new Set,k=[];for(let c of t.files||[]){if(!(l||!c.optional))continue;let s=j(c.path);s&&(S.has(s)||(S.add(s),k.push(c)))}let g=k.filter(c=>!(Array.isArray(c.parts)&&c.parts.length>0)),r=k.filter(c=>Array.isArray(c.parts)&&c.parts.length>0),A=g.concat(r),m=A.length,a=0,u=A.reduce((c,s)=>{let o=Number(s.size||0);return o>0?c+o:Array.isArray(s.parts)&&s.parts.length?c+s.parts.reduce((y,z)=>y+Number(z.size||0),0):c},0);try{e("progress:bytes:total",{totalBytes:u})}catch{}async function w(c,s,o,y=!1){let z=0,q=[];async function J(){for(;;){for(;T&&T();)if(await D(100),f?.cancelled)return;let N=z++;if(N>=c.length)return;let E=c[N],L=s+N,v=j(E.path),H=async()=>lt(n,E,h,e,P,f),X=!1,W=U.get(v);W?X=!0:(e("progress:start",{index:L,total:m,path:E.path,completed:a}),W=(async()=>{try{let $=await H();if(y&&$?.mergeAndVerifyAsync){let F=$.mergeAndVerifyAsync().then(C=>(C?.filePath&&(a+=1,e("progress:done",{index:L,total:m,path:C.filePath,completed:a})),C)).catch(C=>{if(String(C?.message||C||"error").includes("cancelled"))throw C;try{let M=d.join(h,E.path.replace(/\\/g,d.sep));try{i.unlinkSync(M)}catch{}try{let x=i.readdirSync(d.dirname(M)),R=d.basename(M);x.forEach(G=>{if(G.startsWith(R+".part"))try{i.unlinkSync(d.join(d.dirname(M),G))}catch{}})}catch{}return H().then(x=>x.mergeAndVerifyAsync?x.mergeAndVerifyAsync().then(R=>(R?.filePath&&(a+=1,e("progress:done",{index:L,total:m,path:R.filePath,completed:a})),R)):x)}catch(M){try{e("progress:error",{path:E.path,message:String(M?.message||M)})}catch{}throw M}});return q.push(F),{...$,skipProgressDone:!0}}return $}catch($){if(String($?.message||$||"error").includes("cancelled"))throw $;try{let C=d.join(h,E.path.replace(/\\/g,d.sep));try{i.unlinkSync(C)}catch{}let V=await H();if(y&&V?.mergeAndVerifyAsync){let M=V.mergeAndVerifyAsync().then(x=>(x?.filePath&&(a+=1,e("progress:done",{index:L,total:m,path:x.filePath,completed:a})),x)).catch(x=>{try{let R=d.join(h,E.path.replace(/\\/g,d.sep)),G=i.readdirSync(d.dirname(R)),at=d.basename(R);G.forEach(O=>{if(O.startsWith(at+".part"))try{i.unlinkSync(d.join(d.dirname(R),O))}catch{}})}catch{}try{e("progress:error",{path:E.path,message:String(x?.message||x)})}catch{}throw x});return q.push(M),{...V,skipProgressDone:!0}}return V}catch(C){try{e("progress:error",{path:E.path,message:String(C?.message||C)})}catch{}throw C}}})(),U.set(v,W));let Z;try{Z=await W}finally{X||U.delete(v)}Z?.skipProgressDone||(a+=1,e("progress:done",{index:L,total:m,path:E.path,completed:a})),await D(10)}}let B=Array.from({length:Math.max(1,o)},()=>J());await Promise.all(B),q.length>0&&await Promise.all(q)}if(await w(g,0,Math.max(1,p)),U.size>0)try{await Promise.all([...U.values()])}catch{}await w(r,g.length,1,!0)}export{St as cancelToken,mt as createCancelToken,kt as downloadAll,lt as downloadFileObject,Et as fetchChecksums,wt as setGlobalDownloadSpeed};
