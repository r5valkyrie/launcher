import o from"node:fs";import y from"node:path";import at from"node:crypto";import{pipeline as nt}from"node:stream";import{promisify as st}from"node:util";import Y from"node:https";var ct=st(nt);function _(n){return String(n||"").replace(/\\/g,"/").replace(/^\/+/,"")}function O(n){return String(n||"").replace(/\\/g,"/").toLowerCase()}var U=new Map,j=new Y.Agent({keepAlive:!0,maxSockets:64,maxFreeSockets:32,keepAliveMsecs:6e4,scheduling:"fifo"}),K=class{constructor(){this.maxBytesPerSecond=0,this.tokens=0,this.lastRefill=Date.now()}setMaxSpeed(t){this.maxBytesPerSecond=Math.max(0,t),this.tokens=this.maxBytesPerSecond}async consumeTokens(t){if(this.maxBytesPerSecond<=0)return;let i=Date.now(),e=(i-this.lastRefill)/1e3;if(this.tokens=Math.min(this.maxBytesPerSecond,this.tokens+e*this.maxBytesPerSecond),this.lastRefill=i,t>this.tokens){let l=(t-this.tokens)/this.maxBytesPerSecond*1e3;await $(l),this.tokens=0}else this.tokens-=t}},tt=new K;function wt(n){tt.setMaxSpeed(n)}function I(n){return new Promise((t,i)=>{let e=at.createHash("sha256"),h=o.createReadStream(n);h.on("error",i),h.on("end",()=>t(e.digest("hex"))),h.on("data",l=>e.update(l))})}function et(n){o.mkdirSync(n,{recursive:!0})}function ot(n){return new Promise((t,i)=>{let e=Y.get(n,{agent:j},h=>{if(h.statusCode!==200){i(new Error(`HTTP ${h.statusCode} for ${n}`)),h.resume();return}let l="";h.setEncoding("utf8"),h.on("data",P=>l+=P),h.on("end",()=>{try{t(JSON.parse(l))}catch(P){i(P)}})});e.on("error",i),e.setTimeout(3e4,()=>{e.destroy(),i(new Error("JSON fetch timeout"))})})}function $(n){return new Promise(t=>setTimeout(t,n))}function mt(){return{cancelled:!1,requests:new Set}}function St(n){if(n){n.cancelled=!0;for(let t of n.requests)try{t.destroy(new Error("cancelled"))}catch{}n.requests.clear()}}var it=new Set(["ECONNRESET","ETIMEDOUT","EAI_AGAIN","ECONNABORTED","ENETRESET","EHOSTUNREACH","ENETUNREACH","EPIPE","ENOTFOUND","ECONNREFUSED","EHOSTDOWN","ENETDOWN"]);async function q(n,t,i,e=1,h,l=0,P=0){return new Promise((p,T)=>{et(y.dirname(t));let S=o.createWriteStream(t,{flags:l>0?"a":"w"});if(h?.cancelled)return S.close(()=>{}),T(new Error("cancelled"));let k={agent:j};l>0&&(k.headers={Range:`bytes=${l}-`});let u=Y.get(n,k,c=>{if(c.statusCode!==200&&!(l>0&&c.statusCode===206)){if(S.close(()=>{}),l>0&&c.statusCode===200){try{o.unlinkSync(t)}catch{}let r=Math.min(2e3*e,1e4);c.resume();try{u.destroy(new Error("restart:range-ignored"))}catch{}return $(r).then(()=>p(q(n,t,i,e+1,h,0,P)))}if(o.unlink(t,()=>{}),c.statusCode&&[429,500,502,503,504].includes(c.statusCode)&&e<5){let r=Math.min(2e3*e,1e4);return c.resume(),$(r).then(()=>p(q(n,t,i,e+1,h,l,P)))}T(new Error(`HTTP ${c.statusCode} for ${n}`)),c.resume();return}let A=Number(c.headers["content-length"]||0),g=P>0?P:l>0?l+A:A,a=0,f=Date.now(),w=e<=2?3e4:45e3,s=setInterval(()=>{if(!h?.cancelled&&Date.now()-f>w)try{let r=new Error("stalled");r.code="ETIMEDOUT",u.destroy(r)}catch{}},1e4);c.on("data",async r=>{await tt.consumeTokens(r.length),a+=r.length,f=Date.now(),i&&i(Math.min(l+a,g||l+a),g||0)}),c.on("aborted",async()=>{let r=new Promise(d=>S.close(()=>d()));try{clearInterval(s)}catch{}try{await r}catch{}if(e<5){let d=Math.min(2e3*e,1e4);return $(d).then(()=>p(q(n,t,i,e+1,h,l+a,P)))}T(new Error("response aborted"))}),ct(c,S).then(()=>{try{clearInterval(s)}catch{}p()}).catch(r=>{try{clearInterval(s)}catch{}T(r)})});if(h?.requests.add(u),u.on("socket",c=>{try{c.setKeepAlive(!0,6e4),c.setNoDelay(!0),c.setRecvBufferSize&&c.setRecvBufferSize(64*1024),c.setSendBufferSize&&c.setSendBufferSize(64*1024)}catch{}}),u.on("close",()=>h?.requests.delete(u)),u.setTimeout(9e4,()=>{try{let c=new Error("Request timeout");c.code="ETIMEDOUT",u.destroy(c)}catch{}}),h?.cancelled)try{u.destroy(new Error("cancelled"))}catch{}u.on("error",async c=>{let A=c?.code,g=e<8&&A&&it.has(String(A)),a=new Promise(f=>{try{S.close(()=>f())}catch{f()}});try{await a}catch{}if(g){let f=Math.min(1e3*Math.pow(1.5,e),15e3),w=Math.random()*1e3,s=f+w,r=l;try{r=o.statSync(t).size}catch{}return $(s).then(()=>p(q(n,t,i,e+1,h,r,P)))}T(c)})})}async function ht(n,t,i){try{let e=o.statSync(n);return i&&Number(i)>0&&e.size!==Number(i)?!1:(await I(n)).toLowerCase()===String(t).toLowerCase()}catch{return!1}}async function Et(n){let t=`${n.replace(/\/$/,"")}/checksums.json`;return ot(t)}async function lt(n,t,i,e,h=4,l){let P=_(t.path).split("/").join(y.sep),p=y.join(i,P);if(et(y.dirname(p)),await ht(p,t.checksum,t.size))return e("progress:skip",{path:t.path}),{downloadComplete:!0,verificationComplete:!0,targetPath:p};if(l?.cancelled)throw new Error("cancelled");if(Array.isArray(t.parts)&&t.parts.length>0){let S=t.parts.length,k=new Array(S),u=0,c=new Set;async function A(){for(;;){let a=u++;if(a>=S)return;if(c.has(a))continue;c.add(a);let f=t.parts[a],w=_(f.path),s=`${n.replace(/\/$/,"")}/${w}`,r=`${p}.part${a}`;try{if(o.existsSync(r))if((await I(r)).toLowerCase()===String(f.checksum).toLowerCase()){e("progress:part",{path:t.path,part:a,totalParts:S,received:Number(f.size||0),total:Number(f.size||0)}),k[a]=r;continue}else try{o.unlinkSync(r)}catch{}}catch{}let d=0;for(;;){if(l?.cancelled)throw new Error("cancelled");d+=1;let m=0,v=0;try{let D=0;try{D=o.statSync(r).size}catch{}let N=Number(f.size||0);if(N>0&&D>N)try{o.unlinkSync(r),D=0}catch{}await q(s,r,(E,L)=>{let z=Math.max(0,E-v);v=E;try{z>0&&e("progress:bytes",{delta:z})}catch{}m+=z;let H=N||L||0;e("progress:part",{path:t.path,part:a,totalParts:S,received:Math.min(E,H||E),total:H})},1,l,D,N)}catch{try{o.unlinkSync(r)}catch{}try{m>0&&e("progress:bytes",{delta:-m})}catch{}try{e("progress:part:reset",{path:t.path,part:a,totalParts:S})}catch{}let N=Math.min(2e3*d,1e4);await $(N);continue}if((await I(r)).toLowerCase()===String(f.checksum).toLowerCase())break;try{o.unlinkSync(r)}catch{}try{m>0&&e("progress:bytes",{delta:-m})}catch{}try{e("progress:part:reset",{path:t.path,part:a,totalParts:S})}catch{}let J=Math.min(2e3*d,1e4);await $(J)}k[a]=r}}let g=Array.from({length:Math.max(1,h)},()=>A());return await Promise.all(g),{downloadComplete:!0,verificationComplete:!1,targetPath:p,mergeAndVerifyAsync:async()=>{e("progress:merge:start",{path:t.path,parts:k.length});let a=o.createWriteStream(p);for(let w=0;w<k.length;w++){let s=k[w];e("progress:merge:part",{path:t.path,part:w,totalParts:k.length}),await new Promise((r,d)=>{let m=o.createReadStream(s);m.on("error",d),a.on("error",d),m.on("end",()=>{try{o.unlinkSync(s)}catch{}r()}),m.pipe(a,{end:!1})})}await new Promise((w,s)=>{a.on("error",s),a.on("finish",w),a.end()});try{e("progress:merge:done",{path:t.path})}catch{}if(e("progress:verify",{path:t.path}),(await I(p)).toLowerCase()!==String(t.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${t.path}`);try{let w=o.readdirSync(y.dirname(p)),s=y.basename(p);w.forEach(r=>{if(r.startsWith(s+".part"))try{o.unlinkSync(y.join(y.dirname(p),r))}catch{}})}catch{}return{verificationComplete:!0,targetPath:p,filePath:t.path}}}}else{let S=_(t.path),k=`${n.replace(/\/$/,"")}/${S}`,u=0;for(;;){u+=1;let c=0,A=0,g=`${p}.download`,a=0;try{a=o.statSync(g).size}catch{}let f=Number(t.size||0);if(f>0&&a>f)try{o.unlinkSync(g),a=0}catch{}if(await q(k,g,(s,r)=>{let d=Math.max(0,s-A);A=s;try{d>0&&e("progress:bytes",{delta:d})}catch{}c+=d;let m=f||r||0;e("progress:file",{path:t.path,received:Math.min(s,m||s),total:m})},1,l,a,f),(await I(g)).toLowerCase()===String(t.checksum).toLowerCase())break;try{o.unlinkSync(g)}catch{}try{c>0&&e("progress:bytes",{delta:-c})}catch{}if(u>=2)throw new Error(`Checksum mismatch for ${t.path}`)}try{o.unlinkSync(p)}catch{}o.renameSync(`${p}.download`,p)}if(e("progress:verify",{path:t.path}),(await I(p)).toLowerCase()!==String(t.checksum).toLowerCase())throw new Error(`Checksum mismatch for ${t.path}`);return{downloadComplete:!0,verificationComplete:!0,targetPath:p}}async function kt(n,t,i,e,h=!1,l=4,P=4,p,T){let S=new Set,k=[];for(let s of t.files||[]){if(!(h||!s.optional))continue;let r=O(s.path);r&&(S.has(r)||(S.add(r),k.push(s)))}let u=k.filter(s=>!(Array.isArray(s.parts)&&s.parts.length>0)),c=k.filter(s=>Array.isArray(s.parts)&&s.parts.length>0),A=u.concat(c),g=A.length,a=0,f=A.reduce((s,r)=>{let d=Number(r.size||0);return d>0?s+d:Array.isArray(r.parts)&&r.parts.length?s+r.parts.reduce((m,v)=>m+Number(v.size||0),0):s},0);try{e("progress:bytes:total",{totalBytes:f})}catch{}async function w(s,r,d,m=!1){let v=0,V=[];async function J(){for(;;){for(;T&&T();)if(await $(100),p?.cancelled)return;let N=v++;if(N>=s.length)return;let E=s[N],L=r+N,z=O(E.path),H=async()=>lt(n,E,i,e,P,p),Q=!1,W=U.get(z);W?Q=!0:(e("progress:start",{index:L,total:g,path:E.path,completed:a}),W=(async()=>{try{let B=await H();if(m&&B?.mergeAndVerifyAsync){let Z=B.mergeAndVerifyAsync().then(C=>(C?.filePath&&(a+=1,e("progress:done",{index:L,total:g,path:C.filePath,completed:a})),C)).catch(C=>{if(String(C?.message||C||"error").includes("cancelled"))throw C;try{let M=y.join(i,E.path.replace(/\\/g,y.sep));try{o.unlinkSync(M)}catch{}try{let x=o.readdirSync(y.dirname(M)),R=y.basename(M);x.forEach(G=>{if(G.startsWith(R+".part"))try{o.unlinkSync(y.join(y.dirname(M),G))}catch{}})}catch{}return H().then(x=>x.mergeAndVerifyAsync?x.mergeAndVerifyAsync().then(R=>(R?.filePath&&(a+=1,e("progress:done",{index:L,total:g,path:R.filePath,completed:a})),R)):x)}catch(M){try{e("progress:error",{path:E.path,message:String(M?.message||M)})}catch{}throw M}});return V.push(Z),{...B,skipProgressDone:!0}}return B}catch(B){if(String(B?.message||B||"error").includes("cancelled"))throw B;try{let C=y.join(i,E.path.replace(/\\/g,y.sep));try{o.unlinkSync(C)}catch{}let b=await H();if(m&&b?.mergeAndVerifyAsync){let M=b.mergeAndVerifyAsync().then(x=>(x?.filePath&&(a+=1,e("progress:done",{index:L,total:g,path:x.filePath,completed:a})),x)).catch(x=>{try{let R=y.join(i,E.path.replace(/\\/g,y.sep)),G=o.readdirSync(y.dirname(R)),rt=y.basename(R);G.forEach(F=>{if(F.startsWith(rt+".part"))try{o.unlinkSync(y.join(y.dirname(R),F))}catch{}})}catch{}try{e("progress:error",{path:E.path,message:String(x?.message||x)})}catch{}throw x});return V.push(M),{...b,skipProgressDone:!0}}return b}catch(C){try{e("progress:error",{path:E.path,message:String(C?.message||C)})}catch{}throw C}}})(),U.set(z,W));let X;try{X=await W}finally{Q||U.delete(z)}X?.skipProgressDone||(a+=1,e("progress:done",{index:L,total:g,path:E.path,completed:a})),await $(10)}}let D=Array.from({length:Math.max(1,d)},()=>J());await Promise.all(D),V.length>0&&await Promise.all(V)}if(await w(u,0,Math.max(1,l)),U.size>0)try{await Promise.all([...U.values()])}catch{}await w(c,u.length,1,!0)}export{St as cancelToken,mt as createCancelToken,kt as downloadAll,lt as downloadFileObject,Et as fetchChecksums,wt as setGlobalDownloadSpeed};
